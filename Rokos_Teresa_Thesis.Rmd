---
header-includes:
    - \usepackage{setspace}\doublespacing
    - \usepackage{amsmath}
    - \renewcommand{\thesection}{\Roman{section}} 
    - \renewcommand{\thesubsection}{\thesection.\Roman{subsection}}
    - \usepackage{dcolumn}
    - \usepackage{booktabs}
    - \usepackage{longtable}
    - \usepackage{caption}
output:
  pdf_document:
    number_sections: true
geometry: "left=1.5in, right=1in, top=1in, bottom=1in"
fontsize: 12pt
---


```{r child = 'title_page.Rmd'}
```

\newpage
\pagenumbering{gobble}
```{r, include=FALSE}
library(knitr)
library(tidyverse)
library(fs)
library(readxl)
library(janitor)
library(scales)
library(ggthemes)
library(stringi)
library(stargazer)
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
library(plotly)
library(foreign)
library(purrr)
library(ggrepel)
library(lfe)
library(kableExtra)
library(formattable)
library(multiwayvcov)
library(kableExtra)
```

```{r, include=FALSE}
# Constructing data set from raw NH HealthCost data ###########################################################################################################
merge_sheets <- function(x) {
 bind_rows(
   x %>%
      excel_sheets() %>%
      set_names() %>% 
      purrr::map(read_excel, path = x), .id = "Insurer") %>% 
    mutate(procedure = x)
}
primary_data <- data.frame(Insurer = character(), procedure = character())
file_names <- dir_ls("NH_HealthCost_data/")
for (n in file_names) {
  primary_data <- primary_data %>% 
    bind_rows(merge_sheets(n))
}
primary_data <- primary_data %>% 
  mutate(procedure = str_remove_all(procedure, "NH_HealthCost_data/"),
         procedure = str_remove_all(procedure, ".xlsx")) %>% 
  separate(procedure, into = c("CPT_code", "procedure"), sep = " ", extra = "merge")
primary_data <- clean_names(primary_data, case = "snake")
primary_data <- primary_data %>% 
  rename(provider_name = provider_name_compare_selected) %>% 
  mutate(estimate_of_total_cost = case_when(is.na(estimate_of_total_cost) ~ estimate_of_procedure_cost,
                                            !is.na(estimate_of_total_cost) ~ estimate_of_total_cost),
         insurer = str_replace_all(insurer, "None", "Uninsured"),
         provider_name = str_remove(provider_name, "Compare ")) %>% 
  separate(provider_name, sep = " ", into = c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven")) %>%
  select(-estimate_of_procedure_cost, -six, -eight, -ten) %>% 
  mutate(two = case_when(!is.na(four) ~ two),
         three = case_when(!(!is.na(two) & is.na(seven)) ~ three),
         four = case_when(!is.na(three) ~ four),
         four = case_when(!(!is.na(three) & is.na(nine)) ~ four),
         five = case_when(!(!is.na(three) & is.na(four)) ~ five),
         five = case_when(!(!is.na(four) & is.na(eleven)) ~ five),
         seven = case_when(!(!is.na(four) & is.na(five)) ~ seven),
         seven = case_when(!(!is.na(five) & !is.na(eleven)) ~ seven),
         nine = case_when(!(is.na(seven) & !is.na(eleven)) ~ nine)) %>% 
  unite("provider_name", c("one", "two", "three", "four", "five", "seven", "nine", "eleven"), sep = " ") %>% 
  mutate(provider_name = str_remove_all(provider_name, " NA"),
         provider_name = str_replace_all(provider_name, "Lakes Region General Healthcare", "Lakes Region General Hospital"),
         provider_name = str_replace_all(provider_name, "LRGHealthcareLRGHealthcare", "LRGHealthcare"),
         provider_name = str_replace_all(provider_name, "Dartmouth-Hitchcock Clinic", "Dartmouth-Hitchcock (Manchester)"))
###############################################################################################################################################################
# Hospital and ambulatory center latitude, longitude, zipcode, and locality
primary_data <- read_csv("provider_coordinates.csv") %>% 
  right_join(primary_data, by = "provider_name") %>% 
  mutate(locality = case_when(zip %in% c("05156", "05819") ~ "VERMONT",
                              zip %in% c("01805", "01810", "01824", "01830", "01841", "01844", "01845","01851", "01852", "01863", "01876", "01886", 
                                         "01915", "01950") ~ "METROPOLITAN BOSTON, MA",
                              zip %in% c("03909", "04005", "04009") ~ "SOUTHERN MAINE",
                              TRUE ~ "NEW HAMPSHIRE"))
###############################################################################################################################################################
# Constructing Medicare prices and adding to primary data set
primary_data <- read_xlsx("RVU18A_files/PPRRVU18_JAN_mod.xlsx", skip = 9, col_names = TRUE) %>% 
  rename(cpt_code = HCPCS) %>% 
  filter(cpt_code %in% c(primary_data$cpt_code, 
                         "29806", "29807", "29819", "29820", "29821", "29822", "29823", "29824", "29825",
                         "29873", "29874", "29875", "29876", "29877", "29879", "29880", "29881",
                         "45384",
                         "71045", "71046", "71047", "71048",
                         "72050",
                         "72072", "72074",
                         "74018", "74019", "74021"), is.na(MOD)) %>% 
  select(cpt_code, DESCRIPTION, WorkRVU = RVU, FacilityPERVU = `PE RVU__1`, MPRVU = RVU__1, ConversionFactor = FACTOR) %>% 
  mutate(cpt_code = case_when(DESCRIPTION == "Shoulder arthroscopy/surgery" ~ "29826",
                              DESCRIPTION == "Knee arthroscopy/surgery" ~ "29881",
                              DESCRIPTION == "Colonoscopy w/lesion removal" ~ "45385",
                              DESCRIPTION %in% c("X-ray exam chest 1 view", "X-ray exam chest 2 views", 
                                                 "X-ray exam chest 3 views", "X-ray exam chest 4+ views") ~ "71020",
                              DESCRIPTION %in% c("X-ray exam neck spine 2-3 vw", "X-ray exam neck spine 4/5vws") ~ "72040",
                              DESCRIPTION %in% c("X-ray exam abdomen 1 view", "X-ray exam abdomen 2 views", "X-ray exam abdomen 3+ views") ~ "74000",
                              DESCRIPTION %in% c("X-ray exam thorac spine 2vws", "X-ray exam thorac spine 3vws", "X-ray exam thorac spine4/>vw") ~ "72070",
                              TRUE ~ cpt_code),
         DESCRIPTION = case_when(cpt_code == "71020" ~ "X-ray exam chest",
                                 cpt_code == "72040" ~ "X-ray exam neck spine",
                                 cpt_code == "74000" ~ "X-ray exam abdomen",
                                 cpt_code == "72070" ~ "X-ray exam thorac spine",
                                 TRUE ~ DESCRIPTION)) %>% 
  group_by(cpt_code, DESCRIPTION) %>% 
  summarize(WorkRVU = mean(WorkRVU), FacilityPERVU = mean(FacilityPERVU), MPRVU = mean(MPRVU), ConversionFactor = mean(ConversionFactor)) %>% 
  ungroup() %>% 
  right_join(primary_data,  by = "cpt_code")
primary_data <- read_xlsx("RVU18A_files/GPCI2018_copy.xlsx", skip = 2, col_names = TRUE) %>% 
  rename(locality = X__3) %>% 
  filter(locality %in% c("NEW HAMPSHIRE", "SOUTHERN MAINE", "METROPOLITAN BOSTON, MA", "REST OF MASSACHUSETTS", "VERMONT")) %>% 
  select(locality, WorkGPCI = `PW GPCI`, PEGPCI = `PE GPCI`, MPGPCI = `MP GPCI`) %>% 
  right_join(primary_data, by = "locality") %>% 
  mutate(Medicare = ((WorkRVU * WorkGPCI) + (FacilityPERVU * PEGPCI) + (MPRVU * MPGPCI)) * ConversionFactor, medicare_price = Medicare) %>% 
  select(cpt_code, procedure, provider_name, locality, lat, long, zip, insurer, estimate_of_total_cost, Medicare,
         medicare_price, precision_of_the_cost_estimate, typical_patient_complexity, uninsured_discount)
primary_data <- primary_data %>% 
  count(cpt_code, procedure, provider_name, locality, lat, long, zip, typical_patient_complexity, Medicare, medicare_price) %>% 
  mutate(typical_patient_complexity = case_when(provider_name == "Access Sports Medicine & Orthopaedics" ~ " MEDIUM",
                                                provider_name == "Cheshire Medical Center" ~ " MEDIUM",
                                                provider_name == "Lakes Region General Hospital" ~ " MEDIUM",
                                                TRUE ~ typical_patient_complexity)) %>% 
  count(cpt_code, procedure, provider_name, locality, lat, long, zip, typical_patient_complexity, Medicare, medicare_price) %>% 
  select(-n) %>% 
  gather(Medicare, key = insurer, value = estimate_of_total_cost) %>% 
  bind_rows(primary_data) %>% 
  filter(!cpt_code %in% c("29881", "45380", "45385", "85027")) %>%  # only looking at radiology services or top 10 procedures
  select(-Medicare)
# Adding in Hospital Compare data for quality measures
primary_data <- read_csv("Hospital_Compare_data/Hospital_General_Information_copy.csv") %>% 
  filter(State %in% c("VT", "NH", "ME", "MA")) %>% 
  mutate(provider_name = str_to_title(`Hospital Name`)) %>% 
  filter(`Provider ID` != "200001") %>% 
  mutate(provider_name = str_replace_all(provider_name, "Exeter Hospital Inc","Exeter Hospital"), 
         provider_name = str_replace_all(provider_name, "Memorial Hospital, The","Memorial Hospital"), 
         provider_name = str_replace_all(provider_name, "Southern Nh Medical Center", "Southern NH Medical Center"),
         provider_name = str_replace_all(provider_name, "St Joseph Hospital", "St. Joseph Hospital")) %>% 
  right_join(primary_data, by = "provider_name") %>% 
  mutate(`Hospital Type` = case_when(is.na(`Hospital Type`) ~ "Non-Hospital Providers",
                                     TRUE ~ `Hospital Type`),
         `Hospital overall rating` = case_when(provider_name == "Alice Peck Day Memorial Hospital" ~ "3",
                                              TRUE ~ `Hospital overall rating`),
         `Hospital overall rating footnote` = case_when(provider_name == "Alice Peck Day Memorial Hospital" ~ "2017 rating",
                                                        TRUE ~ `Hospital overall rating footnote`)) %>% 
  select(-`Hospital Name`, -Address, -`Phone Number`, -11, -12, -15:-28)
# The number of other hospitals in each hospital's market
# First adding info on each hospital's hsa and hrr from 2016 dartmouth atlas zipcode to HSA/HRR crosswalk
primary_data <- read_csv("ZipHsaHrr16.csv") %>% 
  filter(hsastate %in% c("NH", "MA", "ME", "VT")) %>% 
  rename(zip = zipcode16) %>%
  right_join(primary_data, by = "zip")
# Counting number of hospitals within HSA/HRR that also offer that procedure
primary_data <- primary_data %>% 
  filter(!is.na(`Provider ID`)) %>% 
  count(provider_name, procedure, hsanum, hrrnum) %>% 
  group_by(procedure, hsanum) %>% 
  mutate(n_hosp_hsa_p = n()) %>% 
  ungroup() %>% 
  group_by(procedure, hrrnum) %>% 
  mutate(n_hosp_hrr_p = n()) %>% 
  ungroup() %>% 
  select(-n, -hsanum, -hrrnum) %>% 
  right_join(primary_data, by = c("provider_name", "procedure"))
# Counting number of providers within HSA/HRR that also offer that procedure
primary_data <- primary_data %>% 
  count(provider_name, procedure, hsanum, hrrnum) %>% 
  group_by(procedure, hsanum) %>% 
  mutate(n_provider_hsa_p = n()) %>% 
  ungroup() %>% 
  group_by(procedure, hrrnum) %>% 
  mutate(n_provider_hrr_p = n()) %>% 
  ungroup() %>% 
  select(-n, -hsanum, -hrrnum) %>% 
  right_join(primary_data, by = c("provider_name", "procedure"))
# Counting number of total hospitals in HSA/HRR
primary_data <- primary_data %>% 
  filter(!is.na(`Provider ID`)) %>% 
  count(provider_name, hsanum, hrrnum) %>% 
  group_by(hsanum) %>% 
  mutate(n_hosp_hsa_total = n()) %>% 
  ungroup() %>% 
  group_by(hrrnum) %>% 
  mutate(n_hosp_hrr_total = n()) %>% 
  ungroup() %>% 
  select(-n, -hsanum, -hrrnum) %>% 
  right_join(primary_data, by = "provider_name")
# Counting number of total providers in HSA/HRR
primary_data <- primary_data %>% 
  count(provider_name, hsanum, hrrnum) %>% 
  group_by(hsanum) %>% 
  mutate(n_providers_hsa_total = n()) %>% 
  ungroup() %>% 
  group_by(hrrnum) %>% 
  mutate(n_providers_hrr_total = n()) %>% 
  ungroup() %>% 
  select(-n, -hsanum, -hrrnum) %>% 
  right_join(primary_data, by = "provider_name")
# Next, I want to calculate the distance of every hospital to every other hospital and define the markets as certain radius
# Counting number of hospitals that also offer that procedure
  # Creating an empty data frame for loop to add to
  # Contains the distance between each hospital pair present in my data (later narrow down to hospitals that are 5 or 25mi apart)
      radial_markets_procedure <- data.frame(provider1 = character(), procedure = character(), provider2  = character(), 
                                            distance = double(), 
                                            hospital_type1 = character(), hospital_type2 = character(), 
                                            hospital_rating1 = character(), hospital_rating2 = character())
  
  # Create a data set containing every provider and its coordinates, as well as the provider type and overall rating (hospitals only)    
      provider_coordinates <- primary_data %>% 
        count(provider_name, lat, long, `Hospital Type`, `Hospital overall rating`) %>% # one observation per hospital
        select(-n) %>% 
        mutate(lat = (lat*pi)/180, long = (long*pi)/180) # converting latitude and longitude to radians
      
  # Creating a loop that will compute the distance between every hospital in the data set
      for (i in provider_coordinates$provider_name) { # hospitals and corresponding coordinates taken 
      
        # Creating a data set of the procedures offered at hospital i (at least one contract with a private insurer for that procedure)
          provider_procedure <- primary_data %>% 
            count(provider_name, procedure) %>%
            select(-n) %>% 
            filter(provider_name == i)
        
        # Isolating the coordinates, hospital type, and hospital overall rating for the particular hospital i  
          provider <- provider_coordinates %>% 
            filter(provider_name == i)
        
        # Assigning each value in the one row data set to an object to be referenced in the next step
          provider1 <- provider$provider_name
          lat1 <- provider$lat
          long1 <- provider$long
          hospital_type1 <- provider$`Hospital Type`
          hospital_rating1 <- provider$`Hospital overall rating`
          
        # Creating a data set that contains all hospital pairings that are less than or equal to 25 miles apart and offer the same procedure
          radial_markets_procedure <- primary_data %>% 
            count(provider_name, procedure, lat, long, `Hospital Type`, `Hospital overall rating`) %>% # one observation per provider-procedure combination
            select(-n) %>% 
            mutate(lat = (lat*pi)/180, long = (long*pi)/180) %>% # converting latitude and longitude to radians
            filter(procedure %in% provider_procedure$procedure) %>% # selecting only hospitals that offer at least one of the same procedures as hospital i
            rename(provider2 = provider_name, lat2 = lat, long2 = long, hospital_type2 = `Hospital Type`, 
                   hospital_rating2 = `Hospital overall rating`) %>% # all of this data is relevant to the hospitals surrounding hospital i
            mutate(provider1 = provider1, # name of hospital i (all values in column the same)
                   lat1 = lat1, long1 = long1, # coordinates of hospital i (all values in each column the same)
                   hospital_type1 = hospital_type1,
                   hospital_rating1 = hospital_rating1,
                   dLat = (lat2 - lat1), dLong = (long2 - long1), # calculating distance in radians between latitude and longitude
                   a = (sin(dLat/2)^2) + (cos(lat1) * cos(lat2) * sin(dLong/2)^2),
                   c = 2 * atan2(sqrt(a), sqrt(1 - a)), 
                   distance = 3959*c) %>% # converting this distance to miles (3959mi is the radius of the Earth)
            filter(distance <= 25) %>% # filtering only for relevant hospital pairings (those that are potential competitors)
            select(provider1, procedure, provider2, distance, hospital_type1, hospital_type2, hospital_rating1, hospital_rating2) %>% 
            bind_rows(radial_markets_procedure) # adding data for each hospital i containing the distance between it and each hospital offering that procedure
      
      }
    
    # Counting number of hospitals that also offer procedure (both providers are hospitals)
        # Using the data set created by the loop above I count how many hospitals within a 25mi radius of each also offer the same procedure
          primary_data <- radial_markets_procedure %>%
            filter(hospital_type1 != "Non-Hospital Providers", hospital_type2 != "Non-Hospital Providers") %>% 
            group_by(provider1, procedure) %>% 
            summarize(n_hosp_25mi_p = n()) %>% # counting the number of hospitals that also offer that procedure within a 25mi radius
            ungroup() %>% 
            rename(provider_name = provider1) %>% 
            right_join(primary_data, by = c("provider_name", "procedure")) # adding this as a column to my primary data
          
        # Same idea as the code above, just restricted to hospitals within a 15mi radius 
          primary_data <- radial_markets_procedure %>% 
            filter(hospital_type1 != "Non-Hospital Providers", hospital_type2 != "Non-Hospital Providers", distance <= 15) %>% 
            group_by(provider1, procedure) %>% 
            summarize(n_hosp_15mi_p = n()) %>% 
            ungroup() %>% 
            rename(provider_name = provider1) %>% 
            right_join(primary_data, by = c("provider_name", "procedure")) # adding this as another column to my primary data
          
        # Same idea as the code above, just restricted to hospitals within a 5mi radius   
          primary_data <- radial_markets_procedure %>% 
            filter(hospital_type1 != "Non-Hospital Providers", hospital_type2 != "Non-Hospital Providers", distance <= 5) %>% 
            group_by(provider1, procedure) %>% 
            summarize(n_hosp_5mi_p = n()) %>% 
            ungroup() %>% 
            rename(provider_name = provider1) %>% 
            right_join(primary_data, by = c("provider_name", "procedure"))
          
    # Now counting all providers that also offer that procedure
        # Counting all providers within a 25mi radius of each also offer the same procedure
          primary_data <- radial_markets_procedure %>%
            group_by(provider1, procedure) %>% 
            summarize(n_provider_25mi_p = n()) %>% # counting the number of providers that also offer that procedure within a 25mi radius
            ungroup() %>% 
            rename(provider_name = provider1) %>% 
            right_join(primary_data, by = c("provider_name", "procedure")) # adding this as a column to my primary data
          
        # Same idea as the code above, just restricted to hospitals within a 15mi radius 
          primary_data <- radial_markets_procedure %>% 
            filter(distance <= 15) %>% 
            group_by(provider1, procedure) %>% 
            summarize(n_provider_15mi_p = n()) %>% 
            ungroup() %>% 
            rename(provider_name = provider1) %>% 
            right_join(primary_data, by = c("provider_name", "procedure")) # adding this as another column to my primary data
          
        # Same idea as the code above, just restricted to hospitals within a 5mi radius   
          primary_data <- radial_markets_procedure %>% 
            filter(distance <= 5) %>% 
            group_by(provider1, procedure) %>% 
            summarize(n_provider_5mi_p = n()) %>% 
            ungroup() %>% 
            rename(provider_name = provider1) %>% 
            right_join(primary_data, by = c("provider_name", "procedure"))
# Counting total number of hospitals
    radial_markets <- data.frame(provider1 = character(), provider2  = character(), 
                                          distance = double(), 
                                          hospital_type1 = character(), hospital_type2 = character(), 
                                          hospital_rating1 = character(), hospital_rating2 = character())
    
    provider_coordinates <- primary_data %>% 
      count(provider_name, lat, long, `Hospital Type`, `Hospital overall rating`) %>% 
      select(-n) %>% 
      mutate(lat = (lat*pi)/180, long = (long*pi)/180)
    
    for (i in provider_coordinates$provider_name) {
    
    provider <- provider_coordinates %>% 
      filter(provider_name == i)
    
    provider1 <- provider$provider_name
    lat1 <- provider$lat
    long1 <- provider$long
    hospital_type1 <- provider$`Hospital Type`
    hospital_rating1 <- provider$`Hospital overall rating`
    
    radial_markets <- provider_coordinates %>% 
      rename(provider2 = provider_name, lat2 = lat, long2 = long, hospital_type2 = `Hospital Type`, 
             hospital_rating2 = `Hospital overall rating`) %>% 
      mutate(provider1 = provider1,
             lat1 = lat1, long1 = long1, 
             hospital_type1 = hospital_type1,
             hospital_rating1 = hospital_rating1,
             dLat = (lat2 - lat1), dLong = (long2 - long1), 
             a = (sin(dLat/2)^2) + (cos(lat1) * cos(lat2) * sin(dLong/2)^2),
             c = 2 * atan2(sqrt(a), sqrt(1 - a)), 
             distance = 3959*c) %>% 
      filter(distance <= 25) %>% 
      select(provider1, provider2, distance, hospital_type1, hospital_type2, hospital_rating1, hospital_rating2) %>% 
      bind_rows(radial_markets)
    
    }
      
    primary_data <- radial_markets %>% 
      filter(!is.na(hospital_rating2)) %>% 
      group_by(provider1) %>% 
      summarize(n_hosp_25mi_total = n()) %>% 
      ungroup() %>% 
      rename(provider_name = provider1) %>% 
      right_join(primary_data, by = "provider_name")
    
    primary_data <- radial_markets %>% 
      filter(!is.na(hospital_rating2), distance <= 15) %>% 
      group_by(provider1) %>% 
      summarize(n_hosp_15mi_total = n()) %>% 
      ungroup() %>% 
      rename(provider_name = provider1) %>% 
      right_join(primary_data, by = "provider_name")
    
    primary_data <- radial_markets %>% 
      filter(!is.na(hospital_rating2), distance <= 5) %>% 
      group_by(provider1) %>% 
      summarize(n_hosp_5mi_total = n()) %>% 
      ungroup() %>% 
      rename(provider_name = provider1) %>% 
      right_join(primary_data, by = "provider_name")
# Top CPT codes from NH Hospital Association
top_10_cpt_codes <- read_xlsx("NHA_top_cpt_codes.xlsx", col_names = TRUE) %>% 
  filter(!is.na(`CPT Code`)) %>% 
  gather(-`CPT Code`, -Description, key = hospital, value = avg_price) %>% 
  filter(!is.na(avg_price)) %>% 
  group_by(`CPT Code`, Description) %>% 
  summarize(avg_price_nh = mean(avg_price)) %>% 
  arrange(desc(avg_price_nh)) %>% 
  filter(Description %in% c("ARTHROSCOPY SHOULDER DECOM", "TONSILLECTOMY&ADNOIDECTOMY:UNDER AGE 12", "UPPER GI ENDOSCOPY, BIOPSY", 
                            "DIAGNOSTIC COLONOSCOPY", "CT BRAIN ‐ W/OUT CONTRAST", "PELVIC ULTRASOUND ‐ NON OBGYN ( NON PREGNANCY)", 
                            "VAGINAL ULTRASOUND ‐ NON OBGYN (NON PREGNANCY)", "ED VISIT‐ PROBLEM(S) ARE OF MODERATE SEVERITY", 
                            "SPINE X‐RAY (LUMBAR PA‐LAT)", "ED VISIT‐ PROBLEM(S) ARE OF LOW TO MODERATE SEVERITY")) %>% 
  rename(cpt_code = `CPT Code`, description = Description) %>% 
  ungroup() %>% 
  mutate(cpt_code = as.character(cpt_code))
# Adding in Census Data
primary_data <- primary_data %>% 
  count(hsacity, `County Name`) %>%
  filter(!is.na(`County Name`)) %>% 
  select(-n) %>% 
  right_join(primary_data, by = "hsacity") %>% 
  select(-`County Name.y`) %>% 
  rename(`County Name` = `County Name.x`) %>%
  mutate(`County Name` = case_when(zip == "01805" ~ "MIDDLESEX",
                                   zip == "01830" ~ "ESSEX",
                                   zip == "01844" ~ "ESSEX",
                                   zip == "01915" ~ "ESSEX",
                                   zip == "03079" ~ "ROCKINGHAM",
                                   zip == "04005" ~ "YORK",
                                   zip == "05156" ~ "WINDSOR",
                                   TRUE ~ `County Name`))
primary_data <- primary_data %>% 
  select(-hrrcity, -City) %>% 
  mutate(State = case_when(`County Name` == "ROCKINGHAM" ~ "NH",
                           TRUE ~ hsastate))
primary_data <- primary_data %>% 
  count(`County Name`, State) %>% 
  arrange(State) %>% 
  select(`County Name`) %>% 
  mutate(median_household_income = c(73533, 92878, 65702, 62618, 65834, 58139, 60148, 45386, 61036, 75777, 69856, 85619, 67805, 59419, 47371, 56828),
         percent_pop_over65 = c(0.166, 0.15, 0.178, 0.197, 0.215, 0.271, 0.193, 0.232, 0.201, 0.153, 0.178, 0.173, 0.146, 0.21, 0.201, 0.226),
         pop_density = c(1508.8, 1837.9, 337.2, 199, 150.1, 51.4, 109.1, 18.4, 52.2, 457.4, 156.8, 425, 333.7, 81.4, 48.1, 58.5),
         percent_pop_over65 = 100*percent_pop_over65,
         median_household_income = median_household_income/1000) %>% 
  right_join(primary_data, by = "County Name")
# Making a numeric scale for typical patient complexity
primary_data <- primary_data %>% 
count(typical_patient_complexity) %>% 
  mutate(typical_patient_complexity_scale = case_when(n == 24 ~ 1,
                                                      n == c(85, 4968) ~ 2,
                                                      n == 768 ~ 3)) %>% 
  select(-n) %>% 
  right_join(primary_data, by = "typical_patient_complexity")
# Fixing precision of cost estimates variable
primary_data <- primary_data %>% 
  count(precision_of_the_cost_estimate) %>% 
  mutate(precision_of_cost_estimate = case_when(n == 773 ~ "high",
                                                n == 1439 ~ "low",
                                                n == 899 ~ "medium")) %>% 
  select(-n) %>% 
  right_join(primary_data, by = "precision_of_the_cost_estimate") %>% 
  select(-precision_of_the_cost_estimate) %>% 
  mutate(precision_of_cost_estimate = case_when(insurer %in% c("Medicare", "Uninsured") ~ "high",
                                                TRUE ~ precision_of_cost_estimate),
         commercial_market_share = case_when(insurer == "Anthem NH" ~ 39,
                                             insurer == "Harvard Pilgrim HC" ~ 27,
                                             insurer == "CIGNA" ~ 20),
         nh_enrollment_share = case_when(insurer == "Anthem NH" ~ 0.5,
                                             insurer == "Harvard Pilgrim HC" ~ 0.77,
                                             insurer == "CIGNA" ~ 12),
         nh_enrollment_share = case_when(`Hospital Type` == "Critical Access Hospitals" ~ 0.5*nh_enrollment_share,
                                         TRUE ~ nh_enrollment_share))
# Standardizing prices to Medicare
primary_data <- primary_data %>% 
  filter(!insurer %in% c("Medicare", "Other", "Uninsured"), precision_of_cost_estimate != "low", !is.na(`ZIP Code`), locality == "NEW HAMPSHIRE") %>% # restricting only to well estimated prices for the privately insured at hospitals
  group_by(cpt_code, procedure, locality) %>% # want to standardize each private price relative to medicare_price for that procedure at that locality
  summarize(medicare_price = mean(medicare_price), # medicare price is the same across all hospitals in each locality
            med_private_price = median(estimate_of_total_cost), 
            standardization_fct = (2*medicare_price)/med_private_price) %>% # standardize such that median private price is 200% of the Medicare price
  ungroup() %>% 
  select(cpt_code, procedure, locality, standardization_fct) %>% 
  right_join(primary_data, by = c("cpt_code", "procedure", "locality")) %>% # add this standardization factor as a column to my data
  # count(procedure, locality, standardization_fct) %>% arrange(locality)
  mutate(standardization_fct = case_when(insurer == "Medicare" ~ 1, # do not want to change Medicare prices
                                         TRUE ~ standardization_fct),
         adj_cost_estimate = estimate_of_total_cost*standardization_fct, # generating deflated price estimates
         percent_medicare = (adj_cost_estimate/medicare_price)*100, # and standardizing them as a percentage of the medicare price
         Anthem_NH = case_when(insurer == "Anthem NH" ~ 1,
                               insurer != "Anthem NH" ~ 0),
         Harvard_Pilgrim_HC = case_when(insurer == "Harvard Pilgrim HC" ~ 1,
                               insurer != "Harvard Pilgrim HC" ~ 0),
         CIGNA = case_when(insurer == "CIGNA" ~ 1,
                               insurer != "CIGNA" ~ 0),
         Medicare = case_when(insurer == "Medicare" ~ 1,
                               insurer != "Medicare" ~ 0),
         private_payer = case_when(insurer == "Medicare" ~ 0,
                               insurer != "Medicare" ~ 1),
         `Hospital Quality` = as.numeric(`Hospital overall rating`),
         n_hosp_5mi_total = n_hosp_5mi_total - 1,
         n_hosp_15mi_total = n_hosp_15mi_total - 1, 
         n_hosp_25mi_total = n_hosp_25mi_total - 1,
         n_provider_5mi_p = n_provider_5mi_p - 1,
         n_provider_15mi_p = n_provider_15mi_p - 1, 
         n_provider_25mi_p = n_provider_25mi_p - 1,
         n_hosp_5mi_p = n_hosp_5mi_p - 1,
         n_hosp_15mi_p = n_hosp_15mi_p - 1, 
         n_hosp_25mi_p = n_hosp_25mi_p - 1, 
         n_providers_hsa_total = n_providers_hsa_total - 1,
         n_providers_hrr_total = n_providers_hrr_total - 1,
         n_hosp_hsa_total = n_hosp_hsa_total - 1,
         n_hosp_hrr_total = n_hosp_hrr_total - 1, 
         n_provider_hsa_p = n_provider_hsa_p - 1,
         n_provider_hrr_p = n_provider_hrr_p - 1,
         n_hosp_hsa_p = n_hosp_hsa_p - 1,
         n_hosp_hrr_p = n_hosp_hrr_p - 1)
```

```{r, include=FALSE}
primary_regression_data <- primary_data %>% 
  filter(!insurer %in% c("Uninsured", "Other", "Medicare"), !is.na(`Provider ID`), !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283"),
         precision_of_cost_estimate != "low", State == "NH") %>% 
  arrange(insurer)
##########################
lm_insurers1 <- lm(percent_medicare ~ Harvard_Pilgrim_HC + CIGNA, 
                       data = primary_regression_data)
lm_insurers2 <- lm(formula = percent_medicare ~ Harvard_Pilgrim_HC + CIGNA + procedure, 
                       data = primary_regression_data)
vcov_insurers2 <- cluster.vcov(lm_insurers2, primary_regression_data$procedure)
se_insurers2 <- sqrt(diag(vcov_insurers2))
# coeftest(lm_insurers2, vcov = vcov_insurers2)
# stargazer(lm_insurers1, coeftest(lm_insurers2, vcov = vcov_insurers2), coeftest(lm_insurers3, vcov = vcov_insurers3), type = "text")
# stargazer(lm_insurers1, lm_insurers2, se = list(NULL, se_insurers2), type = "text")
lm_insurers3 <- lm(formula = percent_medicare ~ Harvard_Pilgrim_HC + CIGNA + procedure + provider_name,
                       data = primary_regression_data)
vcov_insurers3 <- cluster.vcov(lm_insurers3, primary_regression_data$procedure)
se_insurers3 <- sqrt(diag(vcov_insurers3))
##########################
lm_market_share <- lm(formula = percent_medicare ~ commercial_market_share + procedure + 
                         provider_name,
                       data = subset(primary_regression_data, insurer != Medicare))
vcov_market_share <- cluster.vcov(lm_market_share, primary_regression_data$procedure)
se_market_share <- sqrt(diag(vcov_market_share))
############################
lm_hospitals1 <- lm(data = primary_regression_data,
                        formula = percent_medicare ~ n_hosp_hsa_total + typical_patient_complexity_scale + `Hospital Quality` + 
                          median_household_income + percent_pop_over65 + pop_density +
                          Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_hospitals1 <- cluster.vcov(lm_hospitals1, primary_regression_data$procedure)
se_hospitals1 <- sqrt(diag(vcov_hospitals1))
lm_hospitals2 <- lm(data = primary_regression_data,
                        formula = percent_medicare ~ n_hosp_hrr_total + typical_patient_complexity_scale + `Hospital Quality` + 
                          median_household_income + percent_pop_over65 + pop_density +
                          Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_hospitals2 <- cluster.vcov(lm_hospitals2, primary_regression_data$procedure)
se_hospitals2 <- sqrt(diag(vcov_hospitals2))
lm_hospitals3 <- lm(data = primary_regression_data,
                        formula = percent_medicare ~ n_hosp_hsa_p + typical_patient_complexity_scale + `Hospital Quality` + 
                          median_household_income + percent_pop_over65 + pop_density +
                          Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_hospitals3 <- cluster.vcov(lm_hospitals3, primary_regression_data$procedure)
se_hospitals3 <- sqrt(diag(vcov_hospitals3))
lm_hospitals4 <- lm(data = primary_regression_data,
                        formula = percent_medicare ~ n_hosp_hrr_p + typical_patient_complexity_scale + `Hospital Quality` + 
                          median_household_income + percent_pop_over65 + pop_density +
                          Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_hospitals4 <- cluster.vcov(lm_hospitals4, primary_regression_data$procedure)
se_hospitals4 <- sqrt(diag(vcov_hospitals4))
lm_hospitals5 <- lm(data = primary_regression_data,
                        formula = percent_medicare ~ n_hosp_15mi_total + typical_patient_complexity_scale + `Hospital Quality` + 
                          median_household_income + percent_pop_over65 + pop_density +
                          Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_hospitals5 <- cluster.vcov(lm_hospitals5, primary_regression_data$procedure)
se_hospitals5 <- sqrt(diag(vcov_hospitals5))
lm_hospitals6 <- lm(data = primary_regression_data,
                        formula = percent_medicare ~ n_hosp_25mi_total + typical_patient_complexity_scale + `Hospital Quality` + 
                          median_household_income + percent_pop_over65 + pop_density +
                          Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_hospitals6 <- cluster.vcov(lm_hospitals6, primary_regression_data$procedure)
se_hospitals6 <- sqrt(diag(vcov_hospitals6))
lm_hospitals7 <- lm(data = primary_regression_data,
                        formula = percent_medicare ~ n_hosp_15mi_p + typical_patient_complexity_scale + `Hospital Quality` + 
                          median_household_income + percent_pop_over65 + pop_density +
                          Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_hospitals7 <- cluster.vcov(lm_hospitals7, primary_regression_data$procedure)
se_hospitals7 <- sqrt(diag(vcov_hospitals7))
lm_hospitals8 <- lm(data = primary_regression_data,
                        formula = percent_medicare ~ n_hosp_25mi_p + typical_patient_complexity_scale + `Hospital Quality` + 
                          median_household_income + percent_pop_over65 + pop_density +
                          Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_hospitals8 <- cluster.vcov(lm_hospitals8, primary_regression_data$procedure)
se_hospitals8 <- sqrt(diag(vcov_hospitals8))
###########################
lm_hospitals_insurers_1 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_hsa_p*Harvard_Pilgrim_HC + n_hosp_hsa_p*CIGNA + 
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_insurers_1 <- cluster.vcov(lm_hospitals_insurers_1, primary_regression_data$procedure)
se_hospitals_insurers_1 <- sqrt(diag(vcov_hospitals_insurers_1))
lm_hospitals_insurers_2 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_hrr_p*Harvard_Pilgrim_HC + n_hosp_hrr_p*CIGNA + 
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_insurers_2 <- cluster.vcov(lm_hospitals_insurers_2, primary_regression_data$procedure)
se_hospitals_insurers_2 <- sqrt(diag(vcov_hospitals_insurers_2))
lm_hospitals_insurers_3 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_15mi_p*Harvard_Pilgrim_HC + n_hosp_15mi_p*CIGNA + 
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                    + procedure)
vcov_hospitals_insurers_3 <- cluster.vcov(lm_hospitals_insurers_3, primary_regression_data$procedure)
se_hospitals_insurers_3 <- sqrt(diag(vcov_hospitals_insurers_3))
lm_hospitals_insurers_4 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_25mi_p*Harvard_Pilgrim_HC + n_hosp_25mi_p*CIGNA + 
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_insurers_4 <- cluster.vcov(lm_hospitals_insurers_4, primary_regression_data$procedure)
se_hospitals_insurers_4 <- sqrt(diag(vcov_hospitals_insurers_4))
lm_hospitals_insurers_5 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_5mi_total*Harvard_Pilgrim_HC + n_hosp_5mi_total*CIGNA + 
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_insurers_5 <- cluster.vcov(lm_hospitals_insurers_5, primary_regression_data$procedure)
se_hospitals_insurers_5 <- sqrt(diag(vcov_hospitals_insurers_5))
lm_hospitals_insurers_6 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_15mi_total*Harvard_Pilgrim_HC + n_hosp_15mi_total*CIGNA + 
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_insurers_6 <- cluster.vcov(lm_hospitals_insurers_6, primary_regression_data$procedure)
se_hospitals_insurers_6 <- sqrt(diag(vcov_hospitals_insurers_6))
lm_hospitals_insurers_7 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_25mi_total*Harvard_Pilgrim_HC + n_hosp_25mi_total*CIGNA + 
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_insurers_7 <- cluster.vcov(lm_hospitals_insurers_7, primary_regression_data$procedure)
se_hospitals_insurers_7 <- sqrt(diag(vcov_hospitals_insurers_7))
lm_hospitals_ms_1 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_5mi_total*commercial_market_share + n_hosp_5mi_total*nh_enrollment_share +
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_ms_1 <- cluster.vcov(lm_hospitals_ms_1, primary_regression_data$procedure)
se_hospitals_ms_1 <- sqrt(diag(vcov_hospitals_ms_1))
lm_hospitals_ms_2 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_15mi_total*commercial_market_share + + n_hosp_15mi_total*nh_enrollment_share +
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_ms_2 <- cluster.vcov(lm_hospitals_ms_2, primary_regression_data$procedure)
se_hospitals_ms_2 <- sqrt(diag(vcov_hospitals_ms_2))
lm_hospitals_ms_3 <- lm(data = primary_regression_data,
                                  formula = percent_medicare ~ n_hosp_25mi_total*commercial_market_share + n_hosp_25mi_total*nh_enrollment_share +
                                    typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density 
                                  + procedure)
vcov_hospitals_ms_3 <- cluster.vcov(lm_hospitals_ms_3, primary_regression_data$procedure)
se_hospitals_ms_3 <- sqrt(diag(vcov_hospitals_ms_3))
###################################
uninsured_data <- primary_data %>%
  mutate(`Hospital Quality` = as.numeric(`Hospital overall rating`)) %>% 
  filter(insurer == "Uninsured", `Hospital Type` != "Non-Hospital Providers", !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283"))
lm_uninsured_1 <- lm(data = uninsured_data,
                         formula = percent_medicare ~ n_hosp_hsa_p + typical_patient_complexity_scale + `Hospital Quality` + 
                           median_household_income + percent_pop_over65 + pop_density + procedure)
vcov_uninsured_1 <- cluster.vcov(lm_uninsured_1, uninsured_data$procedure)
se_uninsured_1 <- sqrt(diag(vcov_uninsured_1))
lm_uninsured_2 <- lm(data = uninsured_data,
                         formula = percent_medicare ~ n_hosp_15mi_p + typical_patient_complexity_scale + `Hospital Quality` + 
                           median_household_income + percent_pop_over65 + pop_density + procedure)
vcov_uninsured_2 <- cluster.vcov(lm_uninsured_2, uninsured_data$procedure)
se_uninsured_2 <- sqrt(diag(vcov_uninsured_2))
lm_uninsured_3 <- lm(data = uninsured_data,
                         formula = percent_medicare ~ n_hosp_hrr_p + typical_patient_complexity_scale + `Hospital Quality` +
                           median_household_income + percent_pop_over65 + pop_density + procedure)
vcov_uninsured_3 <- cluster.vcov(lm_uninsured_3, uninsured_data$procedure)
se_uninsured_3 <- sqrt(diag(vcov_uninsured_3))
lm_uninsured_4 <- lm(data = uninsured_data,
                         formula = percent_medicare ~ n_hosp_25mi_p + typical_patient_complexity_scale + `Hospital Quality` +
                           median_household_income + percent_pop_over65 + pop_density + procedure)
vcov_uninsured_4 <- cluster.vcov(lm_uninsured_4, uninsured_data$procedure)
se_uninsured_4 <- sqrt(diag(vcov_uninsured_4))
################################################
lm_providers_1 <- lm(data = subset(primary_data, !insurer %in% c("Uninsured", "Other", "Medicare") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE"),
                   formula = percent_medicare ~ n_provider_5mi_p + typical_patient_complexity_scale + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_providers_1 <- cluster.vcov(lm_providers_1, subset(primary_data, !insurer %in% c("Uninsured", "Other", "Medicare") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE")$procedure)
se_providers_1 <- sqrt(diag(vcov_providers_1))
lm_providers_2 <- lm(data = subset(primary_data, !insurer %in% c("Uninsured", "Other", "Medicare") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE"),
                   formula = percent_medicare ~ n_provider_15mi_p + typical_patient_complexity_scale +
                     median_household_income + percent_pop_over65 + pop_density +
                    Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_providers_2 <- cluster.vcov(lm_providers_2, subset(primary_data, !insurer %in% c("Uninsured", "Other", "Medicare") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE")$procedure)
se_providers_2 <- sqrt(diag(vcov_providers_2))
lm_providers_3 <- lm(data = subset(primary_data, !insurer %in% c("Uninsured", "Other", "Medicare") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE"),
                   formula = percent_medicare ~ n_provider_25mi_p + typical_patient_complexity_scale + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_providers_3 <- cluster.vcov(lm_providers_3, subset(primary_data, !insurer %in% c("Uninsured", "Other", "Medicare") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE")$procedure)
se_providers_3 <- sqrt(diag(vcov_providers_3))
lm_providers_4 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_provider_5mi_p + typical_patient_complexity_scale + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_providers_4 <- cluster.vcov(lm_providers_4, primary_regression_data$procedure)
se_providers_4 <- sqrt(diag(vcov_providers_4))
lm_providers_5 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_provider_15mi_p + typical_patient_complexity_scale + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_providers_5 <- cluster.vcov(lm_providers_5, primary_regression_data$procedure)
se_providers_5 <- sqrt(diag(vcov_providers_5))
lm_providers_6 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_provider_25mi_p + typical_patient_complexity_scale + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                    Harvard_Pilgrim_HC + CIGNA + procedure)
vcov_providers_6 <- cluster.vcov(lm_providers_6, primary_regression_data$procedure)
se_providers_6 <- sqrt(diag(vcov_providers_6))
####################################
lm_providers_insurers_1 <- lm(data = subset(primary_data, !insurer %in% c("Uninsured", "Other") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE"),
                   formula = percent_medicare ~ n_provider_5mi_p*Anthem_NH + n_provider_5mi_p*Harvard_Pilgrim_HC + n_provider_5mi_p*CIGNA + 
                     typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density
                     + procedure)
vcov_providers_insurers_1 <- cluster.vcov(lm_providers_insurers_1, subset(primary_data, !insurer %in% c("Uninsured", "Other") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE")$procedure)
se_providers_insurers_1 <- sqrt(diag(vcov_providers_insurers_1))
lm_providers_insurers_2 <- lm(data = subset(primary_data, !insurer %in% c("Uninsured", "Other") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE"),
                   formula = percent_medicare ~ n_provider_25mi_p*Anthem_NH + n_provider_25mi_p*Harvard_Pilgrim_HC + n_provider_25mi_p*CIGNA + 
                     typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density
                     + procedure)
vcov_providers_insurers_2 <- cluster.vcov(lm_providers_insurers_2, subset(primary_data, !insurer %in% c("Uninsured", "Other") & 
                                         !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283") &
                                         precision_of_cost_estimate != "low" & locality == "NEW HAMPSHIRE")$procedure)
se_providers_insurers_2 <- sqrt(diag(vcov_providers_insurers_2))
```
\Large {\bf Acknowledgements}

\normalsize

*There are several people I would like to thank for helping me to write this thesis.*

*First, I would like to thank my advisor, Professor Vilsa Curto, for her consistent patience, positivity, and brilliant insights. She helped me immensely in every step of the thesis writing process, from defining a topic to finding data to refining my conclusions, and I really appreciate that she took the time to be a first-time thesis advisor for me. I could not have done any of this without her, and I am extremely honored and grateful to have had the chance to work with her.*

*Next, I would like to thank all those who provided additional insight to my topic through varios discussions: everyone in my thesis tutorial, Professor Pakes and Samuel Moy from my health policy tutorial, my mom and dad, and Avtar Ahluwalia, the Administrative Director at Keck Hospital of USC, who spoke with me at length about the hospital-insurer negotiation process from the hospital's perspective.*

*Additionally, I would like to thank Harry Oppenheimer who helped me out enormously with all my R-related programming questions, and my crew teammates and thesis fairies for always providing support throughout the thesis writing process.*

*Lastly, I want to express how incredibly grateful I am to Kiran Gajwani, my thesis tutorial instructor. Kiran is one of the most positive and dedicated people I have ever met, and I feel so lucky to have had her as an additional advisor to my thesis. Not only is she always there for moral support, but she provided extremely careful and perceptive feedback to help me truly produce work I am proud of. I cannot thank her enough.*

\newpage
\Large {\bf Abstract}

\normalsize
This thesis evaluates how insurers and hospitals are able to exert market power in negotiating prices for hospital care, contributing additional evidence to the literature on hospital and insurer market power. Using insurer-hospital-procedure-level prices from New Hampshire's HealthCost website, I compare the prices for outpatient radiology services first across insurers and then across hospitals to evaluate how this relates to the insurer or hospital's market share using linear fixed effects models. Within hospitals, I find that on average Anthem, the largest commercial insurer in New Hampshire, pays the lowest private prices, Harvard Pilgrim, the second largest insurer, pays 13.9% more than Anthem, and Cigna, the smallest major insurer, pays 21.2% more than Anthem. These results are all statistically significant at the 1% level. I also estimate that across hospitals, all insurers negotiate lower prices at hospitals with more competitors after controlling for quality, typical patient complexity, and socioeconomic characteristics. However, this relationship is largely driven by Harvard Pilgrim, which appears to face a different bargaining position with hospitals as a small non-profit insurer compared to Anthem and Cigna. These results are consistent with a Nash-Bertrand model of hospital-insurer negotiations, implying that prices for hospital care are inefficient and that policy solutions that decrease hospital market power or increase insurer market power in hospital-insurer negotiations may help to reduce hospital prices. 

\newpage
\pagenumbering{arabic}
\captionsetup{font=scriptsize}

# Introduction
The United States' expenditure on health care has grown rapidly since World War II and has outpaced that of many peer countries without significant returns to quality (OECD 2017; Los Angeles Times 2017; Reinhardt et al., 2004). From 1960 to 2017, the growth rate of health care spending has surpassed that of GDP, averaging 6.3% annually, and although this rate recently slowed to only 3.9% in 2017 (Center for Medicare and Medicaid Services 2018), it remains positive and continues to outpace the annual growth rate of real GDP (Bureau of Economic Advisors 2018). Given that the \$3.5 trillion (17.9% of GDP) spent on health care  (CMS 2018) erodes the budgets of households and governments, exploring the sources of spending has generated a large body of relevant research in health economics. Hospital care, physician services, and pharmaceutical drugs are the largest sources of spending, with hospital care constituting the largest share at 32.7% ($1.1 trillion) of total national health expenditure in 2017 (CMS 2018) as shown in Figure 1. Hospital care expenditures are also one of the fastest growing components of total health care spending, growing on average over the last decade at 5.8% annually, while spending of physician services and prescription drugs over the same period grew on average at 4.8% and 4.1%, respectively (CMS 2018). Though the prevalence of third party payers and certain unhealthy behaviors of the American lifestyle may encourage higher utilization of medical care, the biggest driver behind the U.S.'s spending on hospital care is not greater utilization or social spending but simply higher prices (Anderson et al., 2003; Papanicolas et al., 2018).

```{r, echo=FALSE, message=FALSE}
# Creating a graphic to show the growth in U.S. health care spending over time and specifically the growth in hospital care spending
# 1) putting together the data frame that will have U.S. health expenditure by year manually, using data from the CDC
year <- c(1960, 1970, 1980, 1990, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017)
national_health_expenditure <- c(27.2, 74.6, 255.3, 721.4, 1369.2, 1486.2, 1628.7, 1767.6, 1895.8, 2023.8, 2156.3, 2295.4, 2399.3, 2495.6, 2598.6, 2690.6, 2798.0, 2881.8, 3030.9, 3205.9, 3361.1, 3492.1) # in billions of dollars
hospital_care_expenditure <- c(9.0, 27.2, 100.5, 250.4, 415.5, 449.4, 486.5, 525.9, 565.3, 608.6, 651.2, 691.9, 725.6, 779.6, 822.3, 851.9, 902.5, 937.6, 978.2, 1034.5, 1092.8, 1142.6 ) # in billions of dollars
phys_clinical_sevices_exp <- c(5.6, 14.3, 47.7, 158.4, 288.2, 312.7, 337.7, 364.3, 389.4, 413.0, 434.7, 457.5, 481.9, 497.7, 512.6, 535.9, 557.1, 569.6, 595.7, 631.2, 666.5, 694.3) # in billions of dollars
prescrip_drugs_exp <- c(2.7, 5.5, 12.0, 40.3, 121.0, 139.0, 157.9, 176.7, 192.8, 205.2, 224.1, 235.7, 241.5, 252.7, 253.1, 258.8, 259.2, 265.2, 297.9, 324.5, 332.0, 333.4)
nominal_gdp <- c(542, 1073, 2857, 5963, 10252, 10582, 10936, 11458, 12214, 13037, 13815, 14452, 14713, 14449, 14992, 15543, 16197, 16785, 17522, 18219, 18707, 19485) # in billions of dollars, adj for inflation using 2012 dollars; https://www.thebalance.com/us-gdp-by-year-3305543
health_expenditures <- data.frame(year, national_health_expenditure, hospital_care_expenditure, nominal_gdp)
# 2) converting expenditures to percents of gdp
health_expenditures <- health_expenditures %>% 
  mutate(percent_nhe = national_health_expenditure/nominal_gdp,
         percent_hce = hospital_care_expenditure/nominal_gdp,
         percent_pcse = phys_clinical_sevices_exp/nominal_gdp,
         percent_pde = prescrip_drugs_exp/nominal_gdp) %>% 
  select(year, percent_nhe, percent_hce, percent_pcse, percent_pde) %>% 
  gather(-year, percent_pde, key = component_of_exp, value = percent_of_gdp)
# 2) putting together a line plot that will show this growth over time
health_spending <- ggplot(health_expenditures, aes(x = year, y = percent_of_gdp, group = fct_reorder(component_of_exp, -percent_of_gdp))) +
  geom_line(aes(color = fct_reorder(component_of_exp, -percent_of_gdp), linetype = fct_reorder(component_of_exp, -percent_of_gdp))) +
  labs(caption = "Notes: All dollar amounts are nominal. National Health Expenditure data up to 2017 comes from CMS 2018 
       NHE Estimates; GDP data from Bureau of Economic Advisors 2019.") +
  scale_y_continuous(name = "Expenditure (as a percentage of GDP)", labels = percent) +
  scale_x_continuous(name = "Year", breaks = c(1960, 1970, 1980, 1990, 2000, 2010)) +
  scale_linetype_manual(name = "Component of Expenditure",
                        values = c("percent_nhe" = "dotted",
                                   "percent_hce" = "solid",
                                   "percent_pcse" = "dashed", 
                                   "percent_pde" = "longdash"),
                        labels = c("Total National Health Expenditure", "Hospital Care", "Physician and Clinical Services", "Prescription Drugs")) +
  scale_color_manual(name = "Component of Expenditure",
                     values = c("percent_nhe" = "black",
                                "percent_hce" = "red",
                                "percent_pcse" = "gray",
                                "percent_pde" = "light gray"),
                    labels = c("Total National Health Expenditure", "Hospital Care", "Physician and Clinical Services", "Prescription Drugs")) +
  theme_tufte() +
  theme(plot.caption = element_text(hjust = 0))
ggsave("health_spending.png", dpi = 720)
```
\begin{figure}[ht]
  \caption{Health Care Expenditure in the U.S. over time}
  \includegraphics[width=\linewidth]{health_spending.png}
\end{figure}

Due to the size and relevance of hospital care spending, an important health economics literature investigates the sources of hospital price variation. However, the process of determining and defining hospital prices for private payers has long been a challenging element of this research as the list prices hospitals put on their "chargemasters" have little systematic relation to what payers actually pay (Reinhardt 2006). The actual hospital transaction prices for private payers have largely been considered commercially sensitive, but relatively recently a select number of states have begun constructing databases on these prices by mandated these prices be reported by insurers to the state. What has been discovered as these price data have become more available is that prices vary dramatically for different payers (Cooper et al. 2019). Public payers such as Medicare and Medicaid set administrative prices at the federal or state level, which may vary somewhat across regions to reflect costs but usually do not vary within region. Because Medicare and Medicaid account for 20% and 17% of total national health expenditure respectively (CMS 2018), they are able to exert significant monopsony power and pay the lowest prices for hospital services as hospitals would stand to lose significant revenues in serving Medicaid and particularly Medicare patients. Private payers, on the other hand, account for 34% of total national health spending (CMS 2018) but because there are many of them, even the largest health insurers account for less than 10% of total enrollment and, therefore, presumably less than 10% of private spending. Commercial insurers negotiate price contracts separately with each hospital they choose to include in-network and often pay an additional 50-200% of the Medicare price for hospital services (Selden et al. 2015; Cooper et al. 2019; Bai and Anderson 2018), a gap that has only been growing in recent decades (Selden et al. 2015). In addition to the public-private gap, a budding literature (Bai and Anderson, 2018; Cooper et al. 2019) has also identified price gaps between different private payers, such that for the same care at the same hospital, different insurers are paying significantly different prices. Considering the fact that 49% of Americans receive health care coverage from their employer through private insurance plans rather than through Medicare (21%) and Medicaid (14%) (Kaiser Family Foundation 2017), this price variation in different private insurer-hospital contracts affects what many Americans pay out of pocket and in premiums for their health care.

In this paper, I estimate how prices for outpatient radiology services in New Hampshire are related to the market share of the insurer and the market share of the hospital through multivariate fixed effects linear regressions, the results of which suggest how hospitals and insurers may exercise market power. New Hampshire has been a pioneer of price transparency in health care among the U.S. states and therefore provides the opportunity to more closely evaluate the forces shaping hospital prices. I use publicly available data on insurer-hospital-procedure-level prices from the NH HealthCost website, information on state-level health insurance coverage from the New Hampshire Insurance Department, and geographical data from Dartmouth Atlas of Health Care and NH HealthCost. While much of the previous literature analyzes inpatient care, I choose to focus my analysis on hospitals' outpatient radiology services for several reasons. In terms of relevance, outpatient services have expanded steadily in recent decades (Fuchs 2012; American Hospital Association 2018), and by 2016, outpatient revenues accounted for 47% of total hospital revenues (American Hospital Association 2018) and therefore compose a significant proportion of hospital spending.^[Inpatient services accounted for the remaining 53% of hospital revenues in 2016.] Radiology services are some of the most common and costly outpatient services (Pelech 2018), and in New Hampshire, 17 out of the 82 most common outpatient procedures are radiology services (New Hampshire Hospital Association 2017). Due to both their high demand and high per-unit revenue to per-unit cost ratio, radiology services often constitute the largest source of outpatient profits for many hospitals at roughly 35% (Becker's Hospital Review 2015). In addition to being relevant to hospital spending, radiology services are unique in that their quality is more constant across hospitals compared to other types of services, like surgical procedures, and particularly within hospitals, the quality of the same radiology service is conceivably fixed. 

Upon examining the prices for these services, as available through NH HealthCost, I find statistically significant differences between the prices different insurers face within the same hospitals for the same service as well as between the prices different insurers pay across hospitals for the same procedure in markets with varying hospital densities. Specifically, I find that, on average for a particular procedure, Anthem, the largest commercial insurer in New Hampshire, pays the lowest prices at 181% of the Medicare price for that procedure; Harvard Pilgrim, the second largest insurer, pays 26.2% of the Medicare price more than Anthem; and Cigna, the smallest insurer, pays 38.3% of the Medicare price above Anthem. Furthermore, hospitals in markets with higher hospital density are more likely to receive lower prices for each procedure across all insurers. The addition of one hospital within five miles of a hospital, which often places these hospitals in the same Hospital Service Area (HSA), is associated with a reduction in the prices that hospital receives for each procedure equivalent to 21% of the Medicare price; if one additional hospital is added within 25 miles of a hospital, this is associated with only a 6% of the Medicare price decrease, but the broader market definition generally include more than one additional hospital. However, interacting hospital density and insurer identity reveals that the trends at the local level are driven primarily by Harvard Pilgrim, for which the addition of one hospital to a hospital's 5-mile radius is associated with a decrease in negotiated prices equivalent to 36% of the Medicare price, while the coefficients for Anthem and Cigna are also negative but not statistically significant. When considering hospital density within a 25-mile radius however, the relationships are negative and statistically significant for all three insurers although they remain the greatest in magnitude for Harvard Pilgrim and smallest for Cigna. These results suggest that, for outpatient radiology services, Harvard Pilgrim's elasticity to hospital density is the greatest of the three insurers.

This paper builds on a growing literature that has also examined price variation across private payers and hospitals using actual hospital transaction prices. Historically, it has been very difficult to obtain the prices paid by different insurers (Gaynor, Ho, Town 2015) and therefore much of the hospital price literature relates to *average* private hospital prices. As a result, much of the previous literature examines the effects of hospital concentration on hospital prices but much less work has examined how insurer concentration relates to hospital prices. Early work on disparities among private payers in hospital prices largely focused on the prices for health maintenance organizations (HMOs), either comparing HMO prices to PPO or indemnity plan prices (Cutler, McClellan, and Newhouse 2000), evaluating hospital competition in HMO networks (Town and Vistnes 2001), or assessing whether HMOs exert monopsony power (Feldman and Wholey 2001). One of the earliest papers to examine private payer‐level differences in negotiated discounts for hospital services was Sorenson (2003), which found, using a unique dataset from Connecticut, that larger insurers were generally able to negotiate lower prices. Later work (Moriya, Vogt, and Gaynor 2010; Ho and Lee 2017; Dafny 2019) has made use of newer datasets that contain claims from a set of large of employers with multiple insurance carriers and plan types represented to evaluate hospital payments across payers and payer types. Most recently, Cooper, Craig, Gaynor, and Reenen (2018) have made use of a novel sample of claims data from four of the largest health insurers in the U.S. available through the Health Cost Care Institute (HCCI) and provide the first national evidence that insurers pay substantially different prices at the same hospital for the same procedure, aligning with the findings of prior literature in indentifying a positive relationship between hospital concentration and price. My work is most closely related in methodology to Cooper et al. (2019) as I examine how prices for private insurers vary both within and across hospitals. I also employ the Nash-Bertrand bargaining model of hospital-insurer negotiations put forth in Ho and Lee (2017) to explain my findings and attempt to control more carefully for quality variation in services across hospitals than Cooper et al. (2019). That is, I examine a more plausibly homogenous *set* of services^[Cooper et al. (2019) make claims about price variation across hospitals for homogenous services when observing the prices for lower-limb MRIs specifically.] and control for the typical patient complexity at the hospital-procedure level, which may better control for quality than other measures via the revealed preferences of patients. 

Section II of this paper lays out the conceptual framework motivating this analysis, and Section III provides background on the New Hampshire market for health services. Section IV supplies an explanation of the data sources being used, how they were obtained, and the relevant information contained therein. Section V describes the empirical approach and Section VI presents the results. A discussion of the results takes place in Section VII and potential policy implications are considered in Section VIII, with a conclusion in Secition IX.



# Conceptual Framework
The market for hospital services is deviates from perfect competition in several ways. Only about 14% of total health spending is out-of-pocket (Fuchs 2012), and therefore most consumers do not face the full costs of the services they require due to health insurance coverage. Health insurance is made necessary because the market for health care involves a large amount of risk; care is both highly expensive and unpredictable as an individual consumer does not know how much care she will need and when. Thus, insurance helps distribute the risk associated with each consumer across a pool of plan enrollees by bearing some of the costs of care in exchange for monthly premiums. However, this structure leads to reduced pressure on hospitals to offer competitive prices as consumers rarely "shop" for care on the basis of the total hospital price. Because most patients do not observe these prices for the care they receive, their hospital utilization choices are not based on the true costs of care (Manning et al., 1987; Finkelstein et al., 2012). Instead, they "shop" for insurance plans or employers who provide insurance plans on the basis of plan premiums and the convenience of the hospital networks offered by each plan (Ho 2006). Thus, private insurers and other third-party payers are the most proximate agents to the price setting process with hospitals, particularly for expensive, technologically advanced services where consumers pay a smaller portion of total costs; each hospital and private insurer negotiate explicit contracts of the insurer's reimbursement rates, often on an annual basis. Because of the small number of payers and providers, the norm of bilateral contract negotiations, and the lack of price transparency for the consumer, both hospitals and insurers exert market power in the market for health, and therefore the market for hospital care deviates from a perfectly competitive model.

In standard micro-economic theory, goods are optimally allocated in a perfectly competitive market via the mechanism of price, which results from the intersection of the supply and demand curves that aggregate many producers' cost functions and many consumers' preferences. The resulting price is equivalent to the marginal cost of production and the value of the marginal consumer's marginal unit of utility, but no one consumer's consumption decision or one producer's production decsion will effect the market price as there are so many consumers and producers. Thus in this standard model, both producers and consumers are price takers, making their production or consumption decisions based on an *exogenous* price, and economic profits are equivalent to zero. However, if there is only a small number of suppliers or consumers in the market, individual agents' production or consumption decisions can affect price such that it is no longer exogenous and the agent becomes a price setter that can exercise market power. Thus, in this deviation from the standard model, the price setting agent extracts profits, and this results in an ineffiecient amount of the good being supplied or consumed. For hospital-insurer contracts, negotiations essentially determine how profits off the consumer will be split between hospitals and insurers (Capps, Dranove, Satterthwaite 2003) and can be modeled as simultaneous bilateral Nash-Bertrand bargaining^[In Nash bargaining, parties reach an equilibrium outcome due to their simultaneous decisions that weigh their individual "gains-from-trade" from successfully or unsuccessfully negotiating a contract. In Nash-Bertrand bargaining, the two parties bargain over how to split the profits allowed in Bertrand competition, where the presence of few competitos in a market allow for profits, and successful contracts coordinate the setting of price above marginal costs to perpetuate the existence of profits.] (Ho and Lee 2017; Gowrisankaran, Nevo, and Town 2015). Hospitals and insurers face profit tradeoffs in successful versus unsuccessful price negotiations, and the party that stands to lose the most from an unsuccessful price negotiation ends up with the smallest share of profits. In other words, the party with the most to lose from an unsuccessful contract receives the least favorable prices after negotiations and therefore is less able to exercise market power.

Both insurers and hospitals want to negotiate a contract that maximizes their profits and will not negotiate a contract if the proposed contract is less profitable than having no contract at all. That is, both want to maximize the number of health consumers they serve while maximizing their profit margins per consumer, even if the provider is a non-profit (Horwitz 2005). If a hospital is asking for prices that are too high, an insurer can threaten to terminate negotiations by not including that hospital in its network, thereby reducing the likelihood its enrollees will go to that hospital for care. If the insurer covers many potential patients in that hospital's market, this threat could result in considerably reduced volume and revenues for the hospital (Ho 2009). However in return, if insurers are offering prices that are too low, hospitals can threaten to terminate negotiations by not being included in the insurer's network, making the insurer's plan less attractive to potential enrollees and therefore hurting the insurer's revenues.^[Including convenient providers and a large choice in providers in a plan's network is an important aspect of health insurance plan selection for individuals (Ho 2006).] If the hospital is a major hospital or the only hospital in a large geographic region, this threat can generate significant bargaining leverage as potential enrollees may be willing to pay much more in premiums to have convenient or well-known hospitals in their network and may chose to avoid plans that do not include certain hospitals in their network. 

However, the credibility of these threats are important to the bargaining model as this affects how each party perceives the likelihood of the other party's threats being realized. While an insurer may cover a large proportion of a hospital's potential patients, the hospital may know that the potential patient population of that hospital composes a large share of that insurer's total enrollment, and therefore the insurer's threat not to include that hospital in its network is less credible. Conversely, if an insurer knows they cover a large portion of a hospital's profitable patient volume,^[Most hospitals claim to lose money on Medicare and Medicaid patients, so privately insured patients are often much more profitable for hospitals to care for as private payers generally pay 50-200% above the Medicare price (Cooper et al. 2019). However, hospitals may find ways to reduce costs such that they also make some profit on Medicare patients.] the hospital's threat to end negotiations with that insurer may also be less believable. Thus, the prices that result from these negotiations may reflect the relative bargaining power of the insurer and the hospital rather than the marginal cost and marginal utility of the services provided, and therefor may be less efficient at allocating hospital services than a perfectly competitive market. 

In order to test this, I evaluate whether the prices for outpatient radiology services in New Hampshire align with the Nash-Bertrand bargaining model. I hypothesize that hospitals and insurers with greater market shares or fewer competitors will generally be able to negotiate more favorable prices for themselves in the bargaining process and therefore exercise greater market power. However, the ability of each party to exercise market power will be a function of what proportion of the hospital's potential patients are covered by the insurer and what proportion of an insurer's enrollees would place a large value on having that hospital in their network. Therefore, price variation *within* a hospital is expected to relate directly to each insurer's market share as all successful contracts^[My price data only contain observations of successful hospital-insurer contract negotiations,] simply divide profits between the insurer and the hospital, and the larger insurers in a hospitals market are able to secure a greater share of the profits for themselves. *Across* hospitals, however, prices are expected to vary for each insurer relative to the market share of each *hospital* in the insurer's total enrollment market.


# Background on the New Hampshire Market
The state of New Hampshire has been a pioneer of price transparency through the creation of the Comprehensive Health Care Information System (CHIS), and in the same legislation that created CHIS, the state enacted statutes required health insurance carriers to submit their encrypted health care claims data and Health Employer Data and Information Set (HEDIS) data to the state. This has led to a rich set of health claims data that has allowed for the creation of an online public tool NH HealthCost, which allows individuals to find estimates for what the total price^[The total price includes the sum of payments both by the insurer and out-of-pocket by the patient.] for certain services will be at each hospital given their insurance carrier. I construct most of my dataset from this NH HealthCost prices as described in further detail in Section IV. The following subsections describe the New Hampshire insurance and provider landscapes as well as information on radiology services.

## Health Insurance Coverage
New Hampshire is a small state (8,953 square miles) with a population of 1.3 million (90.5% white) and median household income of $71,305 (Census Bureau 2017). Additionally, 17.6% of the population is over the age of 65, which is slightly higher than the national average of 15.6% (Census Bureau 2017). Figures 2 and 3 show the insurance status of New Hampshire residents in 2017 and the market share of major private insurers, respectively. In 2017, 62% of residents (approximately 820,000 individuals) received health insurance through the private insurance market, 56% through employer-sponsored insurance and 6% through individual private insurance, and this translates to 543,900 enrolled members (New Hampshire Health Insurance Department 2018).^[A plan member can be a household or an individual; these estimates exclude individuals covered by the Federal Employees Health Benefits Program (FEHBP)] Of the privately insured, 81% received coverage through employer-sponsored insurance plans (12.6% Small Group, 19.8% Large Group Fully Insured, and 48.9% Large Group Self Insured) and the remainder either purchase their coverage individually (11.0%) or received subsidies for private coverage through New Hampshire's Premium Assistance Program (7.7%). This paper concerns only the prices faced by members of employer-based insurance plans (group insurance).

```{r, echo=FALSE}
# Creating dataframe on insurance status in NH from NH Insurance department, first creating columns
insurance_status <- c("Employer Coverage Only", "Individual Coverage Only", "Medicare Coverage Only", "Medicaid Coverage Only",  
                                                 "Tricare & VA Coverage", "Uninsured","Dual Medicare/Medicaid Coverage", "Other Coverage Combinations")
percent_in <- c(56, 6, 14, 10, 1, 6, 1, 6)
#insurance_status <- c("Employer Coverage Only", "Individual Coverage Only", "Medicare Coverage Only", "Medicaid Coverage Only", "Uninsured", 
                      #"Other Coverage Combinations", "Dual Medicare/Medicaid Coverage", "Tricare & VA Coverage")
#percent_in <- c(56, 6, 14, 10, 6, 6, 1, 1)
# Putting together as dataframe
insurance_status_nh <- data.frame(insurance_status, percent_in) %>% 
  arrange(desc(percent_in))
# Creating dataframe on private insurance in NH
insurer <- c("Anthem/Matthew Thorton", "Harvard Pilgrim", "Cigna", "Other")
percent_enrolled <- c(39, 27, 20, 14)
# Putting together as dataframe
private_insurance <- data.frame(insurer, percent_enrolled) 
```

```{r, echo=FALSE, message=FALSE}
insurance_status_nh$pos = (cumsum(c(0, insurance_status_nh$percent_in)) + c(insurance_status_nh$percent_in / 2, .001))[1:nrow(insurance_status_nh)]
levels(insurance_status_nh$insurance_status) <- gsub(" ", "\n", levels(insurance_status_nh$insurance_status))
levels(insurance_status_nh$insurance_status) <- gsub("Tricare\n&\nVA\nCoverage", "Tricare & VA\nCoverage", levels(insurance_status_nh$insurance_status))
levels(insurance_status_nh$insurance_status) <- gsub("Dual\nMedicare/Medicaid\nCoverage", "Dual Medicare/\nMedicaid\nCoverage", 
                                                     levels(insurance_status_nh$insurance_status))
levels(insurance_status_nh$insurance_status) <- gsub("Other\nCoverage\nCombinations", "Other Coverage\nCombinations", 
                                                     levels(insurance_status_nh$insurance_status))
 
insurance_status <- ggplot(insurance_status_nh, aes(1, percent_in, group = fct_reorder(insurance_status, -percent_in))) +
  geom_col(position = position_stack(reverse = TRUE),
           color = "black",
           fill = "white",
           show.legend = FALSE) +
  geom_text_repel(data = subset(insurance_status_nh, !insurance_status %in% c("Employer\nCoverage\nOnly", "Medicare\nCoverage\nOnly", 
                                                                              "Medicaid\nCoverage\nOnly")), 
                  aes(x = 1.4, y = pos, label = paste0(insurance_status, " (", percent_in, "%)")), 
                  nudge_x = 1.4,
                  box.padding = 0.5,
                  size = 3,
                  family = "serif",
                  show.legend = FALSE) +
  geom_text(data = subset(insurance_status_nh, insurance_status == "Medicaid\nCoverage\nOnly"), 
                  aes(x = 0.7, y = pos, label = paste0(insurance_status, " (", percent_in, "%)")), 
                  nudge_x = 0.5,
                  size = 3,
                  family = "serif",
                  show.legend = FALSE) +
  geom_text(data = subset(insurance_status_nh, insurance_status %in% c("Employer\nCoverage\nOnly", "Medicare\nCoverage\nOnly")), 
                  aes(x = 0.6, y = pos, label = paste0(insurance_status, " (", percent_in, "%)")), 
                  nudge_x = 0.5,
                  size = 3,
                  family = "serif",
                  show.legend = FALSE) +
  expand_limits(x = c(1, 1.5)) +
  coord_polar("y", start = 0.6) + 
  labs(caption = "Source: New Hampshire Health Insurance Department, Nov. 2018") +
  theme_tufte() +
  theme(axis.title.x  = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title.y  = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.caption = element_text(hjust = 0))
ggsave("insurance_status.png", dpi = 720)
```
\begin{figure}[ht]
  \caption{Health Insurance Status of New Hampshire Residents in 2017}
  \includegraphics[width=\linewidth]{insurance_status.png}
\end{figure}

As shown in Figure 3, the three major private insurers are Anthem/Matthew Thorton (39%), Harvard Pilgrim Healthcare (27%), and Cigna (20%). Other insurers include Ambetter (3.5%), Minuteman Health (3.4%), Tufts (3.0%), Community Health Options (2.1%), United (1.2%), and Aetna (0.2%) and each constitute less than 5% of the commercial market. The NH HealthCost website does not distinguish between these other insurers and often does not provide prices for them at all, so I do not include them in my analysis. Anthem plans are underwritten by Matthew Thorton Health Plan, Inc. in New Hampshire, a fully owned subsidiary of Anthem, but are referred to as "Anthem" throughout the paper. Of the three major insurers, both Anthem and Cigna have a significant national presence, Anthem being the larger of the two with 40.2 million members compared to Cigna's 15.9 million members (Becker's Hospital Review, 2019). Thus group insured New Hampshire residents constitute roughly 0.5% of Anthem's total membership and 0.7% of Cigna's total membership. Harvard Pilgrim Health Care is a non-profit private company that primarily operates in the northeastern United States (Crunchbase, 2019) and has only 1.2 million members, so while it is the second largest insurer in New Hampshire, it is a relatively small national player. As a result, group insured New Hampshire residents constitute 12.2% of total Harvard Pilgrim membership, a significantly larger portion than for Anthem or Cigna.

```{r, echo=FALSE, message=FALSE}
private_insurance <- private_insurance %>% 
  arrange(desc(percent_enrolled))
private_insurance$pos = (cumsum(c(0, private_insurance$percent_enrolled)) + c(private_insurance$percent_enrolled / 2, .001))[1:nrow(private_insurance)]
private_insurance$insurer <- gsub("Anthem/Matthew Thorton", "Anthem", private_insurance$insurer)
private_insurance_coverage <- ggplot(private_insurance, aes(1, percent_enrolled, group = fct_reorder(insurer, -percent_enrolled))) +
  geom_col(position = position_stack(reverse = TRUE),
           color = "black",
           fill = "white",
           show.legend = FALSE) +
  geom_text(aes(x = 0.6, y = pos, label = paste0(insurer, "\n(", percent_enrolled, "%)")), 
                  nudge_x = 0.5,
                  size = 3,
                  family = "serif",
                  show.legend = FALSE) +
  coord_polar("y", start = 0) + 
  labs(caption = "Source: New Hampshire Health Insurance Department, Nov. 2018") +
  theme_tufte() +
  theme(axis.title.x  = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title.y  = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.caption = element_text(hjust = 0))
ggsave("private_insurance.png", dpi = 720)
```
\begin{figure}[ht]
  \caption{Distribution by Insurer for NH Commercial Market in 2017}
  \includegraphics[width=\linewidth]{private_insurance.png}
\end{figure}

## New Hampshire Providers
My primary analysis examines prices at New Hampshire's 26 acute-care hospitals. The state has a total of 31 hospitals and 3,503 beds, and of these hospitals, 13 with 2,704 beds are Prospective Payment Systems (PPS) Hospitals, 13 with 301 beds are Critical Access Hospitals (CAHs), and 5 with 498 beds are Specialty Hospitals. PPS hospitals are normal acute-care hospitals that are reimbursed by Medicare through prospective payments^[Medicare prospective payments are predetermined, fixed amounts based on the classification system of the care received. For example, acute-care hospitals are reimbursed for inpatient stays according to the patient's diagnosis, corresponding to a diagnosis-related group (DRG), rather than according to the services provided to that patient.] for inpatient stays. CAHs are acute-care hospitals that serve rural populations and are therefore eligible to receive cost-based reimbursements from Medicare for inpatient stays. Specialty hospitals provide a specialized category of services (such as children’s hospitals, orthopaedic hospitals, cancer hospitals, etc.) and are omitted from my analysis for lack of price information. While the way these hospitals are reimbursed for inpatient hospital stays by Medicare may differ, these distinctions are largely irrelevant in the outpatient setting where physician and clinical services are reimbursed on a service level basis through Medicare Part B. Furthermore, the structure of Medicare reimbursement should not significantly affect how hospitals are reimbursed by private insurers.

In addition to the 26 New Hampshire hospitals, there are 6 out-of-state hospitals relevant to my analysis that are located close to New Hampshire's borders: Anna Jaques Hospital, Lawrence General Hospital, and Lowell General Hospital (Massachusetts); Bridgton Hospital and York Hospital (Maine); and Northeastern Vermont Regional Hospital (Vermont). I do not evaluate the prices each insurer pays at these hospitals because I only have access to the statewide market shares of each insurer within New Hampshire and this share may differ substantially across state lines, but I do include them as competitors to New Hampshire hospitals near state borders. Furthermore, there are 99 non-hospital providers that include ambulatory surgical centers, clinics, and private physician groups that also provide select outpatient radiology procedures, and 79 of these providers are within the state of New Hampshire. Though my primary analyses concern only hospitals, I include these non-hospital providers in a secondary analysis of provider density, and plot them in Figure 4 for context. Non-hospital providers are often highly concentrated in certain areas and some even exist on the same campus as other non-hospital providers, clinics, or hospitals, so it is difficult to determine whether they are competing with hospitals as substitutes or complementing hospitals' delivery of care.

```{r, echo=FALSE, out.width="100%", message=FALSE, warning=FALSE}
library(ggsn)
counties <- map_data("county")
north_east <- subset(counties, region == "new hampshire")
                     # region %in% c("vermont", "new hampshire", "maine", "massachusetts"))
hospitals <- primary_data %>% 
  filter(!is.na(`Provider ID`)) %>% 
  count(provider_name, lat, long, `Hospital Type`)
nh_map <- ggplot() + 
  geom_polygon(data = north_east, aes(x = long, y = lat, group = group), fill = "white", color = "black", size = 0.2) + 
  coord_fixed(xlim = c(-74, -69.5),  ylim = c(42, 45.3), ratio = 1.3) +
  geom_point(data = primary_data, mapping = aes(x = long, y = lat, fill = `Hospital Type`, color = `Hospital Type`, alpha = `Hospital Type`), pch = 21) +
  scale_fill_manual(name = "Hospital Type", values = c("Acute Care Hospitals" = "#000000", 
                                                        "Critical Access Hospitals" = "#FFFFFF", 
                                                        "Non-Hospital Providers" = "#999999")) +
  scale_color_manual(name = "Hospital Type", values = c("Acute Care Hospitals" = "#000000", 
                                                        "Critical Access Hospitals" = "#000000", 
                                                        "Non-Hospital Providers" = "#999999")) +
  scale_alpha_manual(name = "Hospital Type", values = c("Acute Care Hospitals" = 1, 
                                                        "Critical Access Hospitals" = 1, 
                                                        "Non-Hospital Providers" = 0.5)) +
   geom_text_repel(data = subset(hospitals, long < -71.48 & lat > 44), 
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'), 
                   xlim = c(-74,-72), ylim = c(44.2, 46), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, long < -71.48 & lat < 44 & lat > 43.6), 
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'), 
                   xlim = c(-74,-72.4), ylim = c(43.6, 44.2), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, long < -71.48 & lat < 43.6 & lat > 43.2),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-74,-72.5), ylim = c(43, 43.6), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, long < -71.482 & lat < 43.2),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-74,-72.5), ylim = c(42, 43.2), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, long > -71.482 & long < -71.47 & lat < 43.2 & lat > 42.8),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-74,-72.4), ylim = c(42, 42.75), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "Southern NH Medical Center"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-74,-72), ylim = c(42, 42.6), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "St. Joseph Hospital"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-74,-71.7), ylim = c(42, 42.45), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "Elliot Hospital"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-74,-70.9), ylim = c(42, 42.3), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "Lowell General Hospital"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-71,-70), ylim = c(42, 42.45), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "Lawrence General Hospital"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.8,-70), ylim = c(42.45, 42.6), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "Parkland Medical Center"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.9,-70), ylim = c(42.5, 42.75), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, long > -71 & lat < 43.1),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.5,-69.6), ylim = c(42.75, 43.1), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "York Hospital"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.5,-69.6), ylim = c(43.1, 44), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, long > -71 & lat < 44 & lat > 43.15),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.5,-69.6), ylim = c(43.2, 44), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "Lakes Region General Hospital"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.9,-69.6), ylim = c(43.75, 46), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "Huggins Hospital"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.9, -69.6), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, long > -71.4 & long < -71 & lat > 44),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.9, -69.6), ylim = c(44.2, 46), segment.size = 0.2, family = "serif") +
   geom_text_repel(data = subset(hospitals, provider_name == "Bridgton Hospital"),
                   aes(x = long, y = lat, label = provider_name), size = 2, box.padding = unit(0.2, 'lines'),
                   xlim = c(-70.5, -69.6), segment.size = 0.2, family = "serif") +
  labs(caption = "Note: Location of hospitals and non-hospital providers provided by NH HealthCost. County divisions are shown.") +
  theme_tufte() +
  theme(axis.title.x  = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title.y  = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.caption = element_text(hjust = 0)) +
  scalebar(dist = 25, x.min = -73, x.max = -69, y.min = 42, y.max = 46,
           location = "bottomleft", st.bottom = T, border.size = 0.2, st.size = 2, height = 0.01,
           dist_unit = "mi", transform = TRUE)
ggsave("nh_map.png", dpi = 720)
```
\begin{figure}[ht]
  \caption{Location of New Hampshire Hospitals}
  \includegraphics[width=\linewidth]{nh_map.png}
\end{figure}

There has only been one official hospital merger involving a hospital in New Hampshire: Massachusetts General Hospital (MGH)/Partners HealthCare from Boston, MA acquired Wentworth-Douglass on January 1, 2017. However, if two pending quasi-mergers go through, "22 out of New Hampshire's 26 acute-care hospitals will have established some kind of organizational connection with other institutions, often mergers in all but name" (Concord Monitor Jan 26, 2019). However, this should not affect my analysis significantly as most New Hampshire hospitals are not part of large official hospital systems.

## Radiology Services
Radiology services (CT scans, MRIs, ultrasounds, x-rays, etc.) generally involve the use of an imaging device to capture an image which is then read by a radiologist who reports their findings to the patient or patient's doctor. The initial cost of purchasing one of these imaging devices is expensive and may vary somewhat, but the per unit cost of procuring and reading an image is likely to be similar across providers once controlling for wages. Particularly within the same hospital, it is plausible that the per unit cost and quality of each radiology service is constant across privately insured patient populations on average. Furthermore, *across* hospitals, the quality of radiology services is plausibly similar. While the number of specialized radiologists employed by each hospital may vary, the emergence of telemedicine across the country, and specifically in New Hampshire, may help to mitigate these disparities as rural hospitals can send imaging to be reliably read by specialized radiologists employed by telemedicine firms. Particularly after controlling for the hospital's overall quality, I assume that imaging service quality is minimally different between hospitals.^[My knowledge of radiology services comes primarily from speaking directly with phsycians.]



# Data
My primary source of data on private prices comes from the New Hampshire Insurance Department's HealthCost website, which provides insurer-hospital-procedure-level prices in New Hamprhire for roughly 150 services and from which I am able to construct a dataset containing insurer-hospital specific prices for each of the 33 radiology services listed on the site. The prices reported on NH HealthCost are the median amounts that the hospital is paid for providing each service to patients covered by each insurer. I then calculate what percentage of the Medicare price for the same service at the same hospital each price represents using CMS data in order to standardize the prices across different procedures. However, the prices listed on NH HealthCost reflect "bundled" costs and seem somewhat inflated compared to Medicare prices, which are unbundled or include fewer services in their bundle, so I perform one further standardization to deflate my estimates to be more in line with prior literature and to execute my estimations conservatively. This process is described in more detail in Appendix A. In order to obtain measures of market share, I use data from the New Hampshire Health Insurance Department on statewide commercial insurance coverage and geographical information from the Dartmouth Atlas of Health Care and NH HealthCost. Lastly, I include supplementary data from the 2017 Census and Hospital Compare to provide controls for hospital quality and costs associated with providing the selected services.

## NH HealthCost Data
For the most part, the actual transaction prices between hospitals and insurers have been treated as commercially sensitive information, but there have been recent legislative efforts in the last few years to increase price transparency in health care. New Hampshire is one of the few states that has made information on private prices publicly available, hence why I use it as a case study for my analysis. The prices are calculated using claims data from the New Hampshire Comprehensive Healthcare Information System (NHCHIS) to determine the median amount that insurance carriers and patients pay for each service. The estimated costs therefore reflect the rates negotiated between health care providers and insurance carriers (often referred to as the "allowable amount") rather than provider charges, which have been shown to have little relation to what most privately insured individuals actually pay for a given service.

The reported prices may be "bundled" to include multiple services or independent providers; that is, the prices represent aggregated transaction costs under the "lead provider" for what may be treatment received from several providers billing separately. Thus, prices do not distinguish between what is paid to the facility versus the physicians who treat the patient. Reported prices for radiology services use a modified bundle that includes the facility and the professional fees associated with the patient receiving that service but not any other costs that the patient may have incurred on the same day. For example, the prices reflect what a patient was billed for receiving an outpatient foot x-ray and not what they may have been billed for receiving an orthopaedic surgery or cast on that same day.

Each service on HealthCost is identified with a description (e.g. "X-Ray - Foot") and one of the American Medical Association's Current Procedural Terminology (CPT) codes.  However, while most procedures correspond to a single CPT code, certain procedures are actually categories of multiple CPT codes. For example,  an abdominal x-ray is associated with different codes for a different number of views, so NH HealthCost counts the CPT codes for similar services and identifies the most common ones. From there, the representative CPT code and description is chosen based on what will be the simplest and most easily recognized procedure, and, when available, clinical insight is also considered. This means that in some cases, multiple CPT codes may be combined, as long as the cost is similar, under a single service. I make educated assumptions about which of the hundreds of radiology CPT codes are relevant to the prices in NH HealthCost, such that I can match my dataset of the 33 outpatient radiology services provided on NH HealthCost to Medicare prices for singular CPT codes.

Additionally, NH HealthCost includes indicators of variability for each estimate under the "Precision of the Cost Estimate" field, where "High" corresponds to transaction cost estimates with little variability from one patient to the next at the same hospital for the same procedure, and risk-adjustment indicators under the "Typical Patient Complexity" field, which are evaluated for each hospital within that procedure. I restrict my analysis only to cost estimates where the precision of the cost estimate is "Medium" or "High," and keep the the measure of typical patient complexity as a useful control for care intensity and quality in my analysis. The typical patient complexity control attempts to account for how a hospital may attract a more complex population than other hospitals when considering a specific procedure. For instance, if a hospital tends to attract a more complex population of patients for brain MRIs compared to other hospitals providing brain MRIs, this hospital would have a "High" typical patient complexity for brain MRIs. Lastly, HealthCost does not include visits where an infrequent and high cost procedure is performed in conjunction with the reported service on the website because the more expensive procedure may have also impacted the cost for performing the more routine services. 

NH HealthCost also provides several additional sources of information that I take advantage of to perform several secondary analyses. First, NH HealthCost lists prices paid at non-hospital providers, such as clinics, private physician groups, and ambulatory surgery centers, which enables me to evaluate whether hospitals may face additional sources of competition when considering outpatient services. Secondly, while my primary analysis concerns the prices faced by the three major private payers, NH HealthCost also provides data on the prices paid py the uninsured at each hospital for each procedure, allowing me to examine whether the effects of hospital market share are different between the privately insured and uninsured. In sum, these data allowed me to construct a data set containing the price for 33 radiology services and each provider-insurer combination for which data was available, resulting in a total of 2,430 observations when including the uninsured and non-hospital providers. However, of this, I have only 773 observations of private insurer-hospital prices at hospitals within the state of New Hampshire.^[I do not observe prices for all three insurers at all 26 New Hampshire hospitals for all 33 procedures. Specifically, NH HealthCost does not list prices for Anthem at six hospitals (Wentworth-Douglass, Cheshire Medical Center, Upper Connecticut Valley Hospital, Franklin Regional Hospital, New London Hospital, and Frisbie Memorial Hospital), and for Cigna, prices at Upper Connecticut Valley Hospital and Cottage Hospital are not listed. This indicates that these hospitals are likely outside of these insurers' networks.]

## Medicare Prices
I standardize the private prices provided by NH HealthCost to be expressed as a percentage of the Medicare price using the 2018 physician fee schedule to calculate Medicare's fee-for-service (FFS) prices for the relevant outpatient procedures. Thus, in the analysis outlined in Section V, my outcome variable of interest is the percentage of the Medicare price that insurer $i$ negotiates for a particular procedure $j$ at a particular hospital $h$, denoted as $y_{ijh}$:
\begin{equation}
y_{ijh} = \frac {p_{ijh}}{p_{j,l(h)}^{Medicare}}*100
\end{equation}
where $p_{ijh}$ denotes the price a particular insurer pays for procedure $j$ at hospital $h$, and $p_{j,l(h)}^{Medicare}$ denotes the price Medicare pays for the same service at the same at hospitals within hospital $h$'s locality $l(h)$. Because Medicare FFS prices are designed to account for cost variation in providing each service across clinical settings and regions, standardizing my prices as a percentage of Medicare allows me to control for some of the costs associated with each procedure. However, the NH HealthCost prices are "bundled" and therefore are not perfectly comparable to the Medicare FFS prices because they may include more than just payments to the lead provider for the specific service while Medicare prices do not.^[Medicare prices do account for a facility versus physician fee.] I therefore deflate the NH HealthCost prices by a certain factor per procedure such that the median price that the three major private insurers pay for the procedure is equivalent to 200% of the Medicare price for that procedure. This value is based on the results of prior literature on outpatient services and a recent paper by the Congressional Budget Office (Pelech 2018) which utilize direct claims data and have found this to be roughly the median percent of the Medicare price paid by private insurers for outpatient radiology services. Deflating the prices in such a way does not affect the statistical significance or direction of my results but merely adjusts their magnitude to more conservative estimates. Further details on the unadjusted NH HealthCost prices and this standardization process are provided in Appendix A.
I calculate the Medicare FFS prices for each service using data from the 2018 physician fee schedule made publicly available by the Center for Medicaid and Medicare Services (CMS). The Medicare FFS prices are constructed using Relative Value Units (RVUs) and Geographic Practice Cost Indeces (GPCIs) to reflect the different intensities of providing different services and geographic variation in costs for providing the same service. Specifically, RVUs are intended vary according to the effort and resources required to perform those services and whether the service was provided in an office or a hospital facility, and they are each multiplied by GPCIs, which vary by locality.^[CMS defines 112 localities within the United States, which are often state-level definitions but for some larger states or major cities may be much smaller areas. For instance, a large state like California accounts for 31 of all localities, and Massachusetts is divided into "Metropolitan Boston, MA" and the "Rest of Massachusetts, MA." However, CMS considers all of New Hampshire one locality.] Thus, the equation to calculate the Medicare price paid $p_{j,l(h)}^{Med}$ for each procedure $j$ at the locality level $l(h)$ are calculated as using the following formula:
$$p_{j,l(h)}^{Med} = [({RVU}_{j}^{work}*{GPCI}_{l(h)}^{work}) + ({RVU}_{j}^{PE}*{GPCI}_{l(h)}^{PE}) + ({RVU}_{j}^{MP}*{GPCI}_{l(h)}^{MP})]*{CF}_{2018} $$ 
where ${RVU}_{j}^{work}$ denotes the RVU for the physician effort, ${RVU}_{j}^{PE}$ denotes the RVU for the resource-based practice expense for the facility setting, and ${RVU}_{j}^{MP}$ denotes the RVU for the malpractice expense associated with providing procedure $j$. Within hospital $h$'s locality $l(h)$, ${GPCI}_{l(h)}^{work}$ denotes the GPCI corresponding to the work RVU, ${GPCI}_{l(h)}^{PE}$ corresponds to the practice expense RVU, and ${GPCI}_{l(h)}^{MP}$ corresponds to the malpractice RVU. ${CF}_{2018}$ denotes the 2018 conversion factor (\$35.996), which is updated annually to account for changes in the value of the dollar. For example, in calculating the Medicare price for a foot x-ray versus an arthroscopic shoulder surgery in New Hampshire, the RVUs for arthroscopic shoulder surgery are significantly higher than for a foot x-ray, particularly for the work RVU and practice expense RVU to capture how the arthroscopic shoulder surgery is a much more technical, expensive, and high-risk procedure. Thus, Medicare pays \$30.90 for a foot x-ray and \$677.26 for an arthroscopic shoulder surgery. However, in a different GPCI, such as the Boston Metropolitan Area, Medicare pays \$34.25 for a foot x-ray and \$729.84 for an arthroscopic shoulder surgery to reflect generally higher costs in Boston as compared to most of New Hampshire.
Medicare treats all of New Hampshire as one locality, meaning that all hospitals in New Hampshire that are reimbursed through prospective payments by Medicare Part A for inpatient services are reimbursed the same amounts for outpatient services through Medicare Part B. However, 13 out of the 32 hospitals^[Of the 32 hospitals, 26 are contained within the state of New Hampshire and therefore I only evaluate the prices at these 26 hospitals.] in my dataset are Critical Access Hospitals (CAHs) that are eligible to receive cost-based reimbursements from Medicare. I was unable to obtain data on exactly how much these CAHs are reimbursed in the outpatient setting and therefore use the Medicare FFS rates paid at prospective payment hospitals as approximations for what they are reimbursed by Medicare. This should not have a major impact on the analysis as the focus is on variation in the prices for private insurers, and I primarily use Medicare prices for the purposes of standardization of the private insurer prices available through NH HealthCost. 
## Price Variation in the New Hampshire Market
Having constructed prices at the insurer-procedure-hospital level using both data sources outlined above, I find that large price variation exists in New Hampshire, and I present in Table 1 the price Medicare pays as well as the median adjusted prices for the three major private insurers (Anthem, Harvard Pilgrim, and Cigna) and the uninsured for the 33 procedures included in my analysis. All prices reflect 2018 prices, and the raw unadjusted private prices can be found in Appedix A. Significant variation exists in the prices paid for the same procedure or service, not just between Medicare and the private payers but also when only considering the three major commercial insurers. This variation may be efficient if costs and quality vary across hospitals for complex procedures but may be inefficient for services where cost and quality are plausibly constant.
```{r, echo=FALSE, results = "asis", fig.align='center', message=FALSE}
step_1 <- primary_data %>%
  filter(`Hospital Type` != "Non-Hospital Providers", !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283"), locality == "NEW HAMPSHIRE") %>%
  group_by(procedure, insurer) %>% 
  summarize(Median = median(adj_cost_estimate), sd = sd(adj_cost_estimate)) %>% 
  ungroup() %>% 
  mutate(procedure = str_replace_all(procedure, "&", "/"),
         Median = currency(Median),
         sd = round(sd, 2)) %>% 
  select(procedure, insurer, Median, sd) %>% 
  spread(key = insurer, value = Median) %>% 
  mutate(Anthem_sd = case_when(!is.na(`Anthem NH`) ~ sd),
         HP_sd = case_when(!is.na(`Harvard Pilgrim HC`) ~ sd),
         CIGNA_sd = case_when(!is.na(CIGNA) ~ sd),
         Uninsured_sd = case_when(!is.na(Uninsured) ~ sd)) %>% 
  select(procedure, Medicare, `Anthem NH`, Anthem_sd, `Harvard Pilgrim HC`, HP_sd, CIGNA, CIGNA_sd, Uninsured, Uninsured_sd)
all_procedures <- step_1 %>%
  filter(!is.na(Uninsured)) %>% 
  select(procedure, Uninsured, Uninsured_sd) %>% 
  left_join(step_1, by = "procedure") %>% 
  select(-`Uninsured.y`, -Uninsured_sd.y)
all_procedures <- step_1 %>%
  filter(!is.na(CIGNA)) %>% 
  select(procedure, CIGNA, CIGNA_sd) %>% 
  left_join(all_procedures, by = "procedure") %>% 
  select(-`CIGNA.y`, -CIGNA_sd.y)
all_procedures <- step_1 %>%
  filter(!is.na(`Harvard Pilgrim HC`)) %>% 
  select(procedure, `Harvard Pilgrim HC`, HP_sd) %>% 
  left_join(all_procedures, by = "procedure") %>% 
  select(-`Harvard Pilgrim HC.y`, -HP_sd.y)
all_procedures <- step_1 %>%
  filter(!is.na(`Anthem NH`)) %>% 
  select(procedure, `Anthem NH`, Anthem_sd) %>% 
  left_join(all_procedures, by = "procedure") %>% 
  select(-`Anthem NH.y`, -Anthem_sd.y)
all_procedures <- step_1 %>% 
  filter(!is.na(Medicare)) %>% 
  select(procedure, Medicare) %>% 
  left_join(all_procedures, by = "procedure") %>% 
  select(-Medicare.y) %>% 
  group_by(procedure) %>% 
  summarize(Medicare.x = mean(Medicare.x), 
            `Anthem NH.x` = mean(`Anthem NH.x`), Anthem_sd.x = mean(Anthem_sd.x), 
            `Harvard Pilgrim HC.x` = mean(`Harvard Pilgrim HC.x`), HP_sd.x = mean(HP_sd.x), 
            CIGNA.x = mean(CIGNA.x), CIGNA_sd.x = mean(CIGNA_sd.x), 
            Uninsured.x = mean(Uninsured.x), Uninsured_sd.x = mean(Uninsured_sd.x)) %>% 
  arrange(desc(Medicare.x)) %>% 
  mutate(procedure = str_remove_all(procedure, "\\s*\\([^\\)]+\\)"),
         procedure = str_replace_all(procedure, "Emergency Department Visit - Low Complexity", "Emergency Room Visit - Low Level"),
         procedure = str_replace_all(procedure, "Emergency Room Visit - Medium", "Emergency Room Visit - Medium Level"),
         procedure = str_replace_all(procedure, "Upper Gastrointestinal Endoscopy, with biopsy", "Upper GI Endoscopy, with biopsy"),
         procedure = str_replace_all(procedure, "CT - Abdomen / Pelvis, with contrast", "CT - Abdomen/Pelvis, with contrast"),
         Anthem_sd.x = paste0("(", Anthem_sd.x, ")"), 
         HP_sd.x = paste0("(", HP_sd.x, ")"), 
         CIGNA_sd.x = paste0("(", CIGNA_sd.x, ")"), 
         Uninsured_sd.x = paste0("(", Uninsured_sd.x, ")"))

kable(all_procedures, format = "latex", caption = "Median Hospital Prices for Radiology Services by Payer", booktabs = T, digits = round(2),
      col.names = c("Procedure", "Medicare", "Anthem", "", "HP", "", "Cigna", "", "Uninsured", "")) %>%
  kable_styling(latex_options = "scale_down") %>% 
  add_footnote("All prices presented reflect 2018 prices")

# stargazer(all_procedures, summary = FALSE, rownames = FALSE, font.size = "footnotesize", header = FALSE, align = TRUE, column.sep.width = "0.5pt",
#           digits = 0, title = "Median Price for Radiology Services by Payer")
```
However, this variation persists even when costs and quality are reasonably assumed to be fixed within the same hospital. Controlling for procedure, across hospital price variation accounts for 16.4% of the total variation but *within* hospital price variation accounts for a further 17.0% of the total variation in my data, similar to the findings Cooper et al. (2019).^[Cooper et al. (2019) find that about 20% of total price variation across the services they consider occurs within hospitals for the same procedure after controlling for hospital fixed effects, insurance plan characteristics, and patient characteristics.] For the same service at the same hospital, different payers are charged vastly different amounts. Figure 5 and 6 show the different prices paid by the three major private payers in New Hampshire (Anthem, Harvard Pilgrim, and Cigna) at the same hospital for both a highly expensive and less common service as well as a more common, cheaper service. Relative prices vary significantly for both services. Figure 5 shows the prices paid by different insurers at different hospitals for abdominal CT scans, on of the most expensive outpatient radiology procedures, and Figure 6 shows the prices for spinal x-rays. For several of the hospitals in Figure 5, the difference between what the highest and lowest payers pay exceeds \$500.
```{r, echo=FALSE, message=FALSE}
ct_abdomen <- primary_regression_data %>% 
  filter(procedure == "CT - Abdomen & Pelvis, with contrast") %>%
  count(provider_name, insurer) %>%
  count(provider_name) %>%
  filter(n == 3) %>%
  left_join(primary_regression_data, by = "provider_name") %>%
  filter(procedure == "CT - Abdomen & Pelvis, with contrast") %>%
  group_by(provider_name, procedure) %>% 
  mutate(range = max(adj_cost_estimate) - min(adj_cost_estimate)) %>% 
  ungroup() %>% 
  mutate(insurer = case_when(insurer == "Anthem NH" ~ "Anthem",
                             insurer == "Harvard Pilgrim HC" ~ "Harvard Pilgrim",
                             insurer == "CIGNA" ~ "Cigna"),
         provider_name = str_replace_all(provider_name, "Southern NH Medical Center", "Southern NH\nMedical Center")) %>% 
  ggplot(aes(x = fct_reorder(provider_name, adj_cost_estimate), y = adj_cost_estimate, fill = fct_reorder(insurer, -commercial_market_share))) +
  geom_col(position = "dodge", width = 0.5, color = "black") +
  geom_hline(yintercept = 328.29, color = "black", size = 0.5) +
  scale_fill_manual(values = c("Cigna" = "#99CC00", "Anthem" = "#336699", "Harvard Pilgrim" = "#CC0000"), name = "") +
  scale_y_continuous(name = "Price Estimate", labels = c("$0", "Medicare\nPrice\n$328.29", "$500", "$1000", "$1500"), 
                     breaks = c(0, 328.29, 500, 1000, 1475)) +
# labs(caption = "Note: This plot shows all hospitals for which there was an estimated price difference greaterthan $100 between the highest and lowest paying commercial insurers for spine x-rays. Price estimates come from HealthCost website and all prices shown are estimated with medium to high precision.") +
  coord_flip() +
  theme_tufte() + 
  theme(axis.title.y = element_blank(),
        legend.position = "bottom",
        plot.caption = element_text(hjust = 0))
ggsave("ct_abdomen.png", dpi = 720)
```
\begin{figure}
  \caption{Prices Paid by Private Insurers for Abdominal and Pelvic CT Scans, with Contrast}
  \includegraphics[width=\linewidth]{ct_abdomen.png}
\end{figure}

```{r, echo=FALSE, message=FALSE}
xray_spine <- primary_regression_data %>% 
  filter(procedure == "X-Ray - Spine (outpatient)") %>%
  count(provider_name, insurer) %>%
  count(provider_name) %>%
  filter(n == 3) %>%
  left_join(primary_regression_data, by = "provider_name") %>%
  filter(procedure == "X-Ray - Spine (outpatient)") %>%
  group_by(provider_name, procedure) %>% 
  mutate(range = max(adj_cost_estimate) - min(adj_cost_estimate)) %>% 
  ungroup() %>% 
  filter(range < 50) %>% 
  mutate(insurer = case_when(insurer == "Anthem NH" ~ "Anthem",
                             insurer == "Harvard Pilgrim HC" ~ "Harvard Pilgrim",
                             insurer == "CIGNA" ~ "Cigna"),
         provider_name = str_replace_all(provider_name, "Southern NH Medical Center", "Southern NH\nMedical Center"),
         provider_name = str_replace_all(provider_name, "Mary Hitchcock Memorial Hospital", "Mary Hitchcock\nMemorial Hospital")) %>% 
  ggplot(aes(x = fct_reorder(provider_name, adj_cost_estimate), y = adj_cost_estimate, fill = fct_reorder(insurer, -commercial_market_share))) +
  geom_col(position = "dodge", width = 0.5, color = "black") +
  geom_hline(yintercept = 36.82, color = "black", size = 0.5) +
  scale_fill_manual(values = c("Cigna" = "#99CC00", "Anthem" = "#336699", "Harvard Pilgrim" = "#CC0000"), name = "") +
  scale_y_continuous(name = "Price Estimate", labels = c("$0", "$25", "Medicare\nPrice\n$36.82", "$50", "$75", "$100"), 
                     breaks = c(0, 25, 36.82, 50, 75, 100)) +
# labs(caption = "Note: This plot shows all hospitals for which there was an estimated price difference greaterthan $100 between the highest and lowest paying commercial insurers for spine x-rays. Price estimates come from HealthCost website and all prices shown are estimated with medium to high precision.") +
  coord_flip() +
  theme_tufte() + 
  theme(axis.title.y = element_blank(),
        legend.position = "bottom",
        plot.caption = element_text(hjust = 0))
ggsave("xray_spine.png", dpi = 720)
```
\begin{figure}[ht]
  \caption{Prices Paid by Private Insurers for Spinal X-Rays (Outpatient)}
  \includegraphics[width=\linewidth]{xray_spine.png}
\end{figure}

It is unlikely that the cost of providing each of these services and the quality of each of these services within the same hospital should vary with patients' insurance coverage enough to account for the different prices observed. That is, while Anthem patients could potentially be healthier on average and therefore less expensive to treat than Cigna patients, it is not very plausible that these differences in patient populations would be sufficiently large to account for much of the price variation, particularly for radiology services. Thus my analysis explores other potential sources of this variation, particularly the level of competition among insurers and hospitals that may allow each to exert certain levels of market power in the price bargaining scenario.

## Additional Data
Lastly, to provide controls for quality and cost variation, I include quality information from CMS's Hospital Compare data and county-level information on income and population demographics from 2017 US Census Data. CMS's overall hospital ratings attempt to capture the quality of care a hospital may provide compared to other hospitals based on the quality measures reported on Hospital Compare, summarizing into a single rating more than 60 measures in seven measure groups: mortality, safety of care, readmission, patient experience, effectiveness of care, timeliness of care, and efficient use of medical imaging. Hospitals are ranked out of five stars, and my dataset includes two hospitals with two stars, 11 hospitals with three stars, 16 hospitals with four stars, and three hospitals with five stars for their overall ratings. My analyses use only the hospital's overall quality rating as a control. The US Census data I use are county level estimates of median household income, percentage of the population over 65, and population density to provide further controls beyond the Medicare price for hospital's costs. 

In order to construct hospital markets and define hospital competition therein, I use geographical information from Dartmouth Atlas of Health Care and Google Maps. Dartmouth Atlas defines and provides data for each hospital's Hospital Service Area (HSA) and Hospital Referral Region (HRR), and these definitions for hospitals' markets are commonly used throughout the literature. An HSA delineates a local market for hospital care, composed of a collection of zip codes whose residents receive most of their hospitalizations from the hospitals contained in that area. For the most part, this calculation is based on assigning each zip code to the area where the greatest proportion of its Medicare patients were hospitalized. Most HSAs contain only one hospital. An HRR delineates regional health care markets for tertiary medical care and each contains at least one hospital that performs major cardiovascular procedures and neurosurgery. HRRs are largely defined by assigning HSAs to the region where the greatest proportion of major cardiovascular procedures were performed. Thus, both measures are perhaps more relevant to the inpatient setting. My dataset contains 29 unique HSAs and 4 unique HRRs, and I count both the total number of additional hospitals within each hospital's market and the number of additional hospitals that provide the same service/procedure within that market. My second set of market definitions simply uses coordinate information for each hospital from Google Maps to calculate the total number of hospitals and the number of hospitals offering the same procedure within a 15-mile and 25-mile radius of each hospital.



# Empirical Approach
My analysis seeks to identify whether the market shares of hospitals and insurers are related to variation in the prices private insurers pay for hospital services and whether the effect of hospital market share is heterogeneous accross different insurers. The first set of regressions concern price variation across insurers within hospitals, the second set evaluates price variation across hospital market share holding the insurer constant, and the third set examines heterogeneity in how price variation relates to hospital market share for each insurer. In performing these primary analyses, I restrict my dataset to contain only hospitals in New Hampshire,^[I exclude prices at ambulatory surgical centers, clinics, specialist practices, and private physician practices in my primary.] and only the three major private insurers. This leaves me with 33 services, 26 hospitals, and 773 observations.^[NH HealthCost does not list prices for all three insurers at all 26 New Hampshire Hospitals for all 33 radiology services considered either because a hospital is not included in a plan's network, the hospital does not offer that procedure, or the observation frequency of certain procedure-insurer-hospital-level prices are too low for accurate estimates. That is, if only two Anthem patients receive an outpatient brain MRI at St. Joseph's hospital during 2018, NH HealthCost does not list a price for this procedure at St. Joseph's for Anthem as estimation power for this procedure-insurer-hospital combination is too low.]

In the first set of regressions, I estimate whether there is a statistical difference between the prices for Anthem, Harvard Pilgrim, and Cigna *within the same hospital* for the same service, and whether there is a relationship between these differences and each insurer's market share. I first estimate what percentage of the Medicare price each insurer $i$ pays on average for each service $j$ at each hospital $h$ using the following fixed effects linear model:
\begin{equation}
y_{ijh} = \alpha + \beta_1 HP + \beta_2 CIGNA + \delta_j + \lambda_h + \varepsilon_{ijh}
\end{equation}
where $HP$ and $CIGNA$ are dummy variables for Harvard Pilgrim and Cigna respectively, $\delta_j$ is the procedure fixed effects term, $\lambda_h$ is the hospital fixed effects term, and the error term is denoted by $\varepsilon_{ijh}$. The omitted insurer dummy is Anthem such that the coefficients $\hat \beta_1$ and $\hat \beta_2$ estimate the percentage of the Medicare price above or below the Anthem price that Harvard Pilgrim or Cigna pay on average, and these are the primary coefficients of interest. By including procedure and hospital fixed effects, I am able to compare prices among the commercial insurers for the same procedure within the same hospital in a context where costs and quality are very plausibly constant. That is, there should be essentially no variation in costs or quality for each radiology service at the same hospital on average.

Equation (2) only estimates whether there are consistent differences between the prices each insurer pays, and the signs and relative magnitudes of the estimated coefficients $\hat \beta_1$ and $\hat \beta_2$ may suggest a possible direction to the association between insurer market share and negotiated prices. In order to investigate more closely the magnitude of this relationship, I also estimate the relationship between each insurer's statewide market share $s_i$ and price using the following simple fixed effects regression, restricting my observations only to private insurer prices:
\begin{equation}
y_{ijh} = \gamma s_i + \delta_j + \lambda_h + \varepsilon_{ijh}
\end{equation}
Ideally, I would know the market share of each insurer $i$ within hospital $h$'s market, and identify the relationship between the prices negotiated given these shares to identify the price and market share relationship more precisely, but given the limitations of my dataset, I am only able to examine this relationship to statewide market shares. However, a negative $\hat \gamma$ would fit the narrative that, within hospitals, larger insurers in the state may be able to negotiate lower hospital prices more often at New Hampshire hospitals.

In the second set of regressions, I estimate how variation in hospital market shares relates to the prices each insurer is able to negotiate for each service *across hospitals*. However, as with the imperfect measure of insurer market share, I use an imperfect measure of hospital market share as I am unable to obtain data on the precise outpatient volumes of each hospital for each service by each insurer. Instead, I construct a measure of the number of *additional* hospitals present in hospital $h$'s market to serve as a proxy for market share and relative hospital concentration in it's inverse form. This measure provides only a proxy for hospital market share because while there may be several hospitals in the same market, one may perform significantly more outpatient radiology procedures than the others and therefore have greater market share in the market for that service. This may be due to this hospital having a greater capacity to provide that service or because it is preferred by patients for that service for some other reason. Nevertheless, I hypothesize that because there are so few hospitals present in each market,^[At the broadest definitions of markets, the maximum number of hospitals in any one market is 13 total, but at the smaller market definitions, this number is often less than 5.] the addition of a marginal hospital to hospital $h$'s market will appreciably subtract from hospital $h$'s market share and reduce hospital concentration. I estimate this relationship using roughly the same framework as Equation (2) except that I decompose the hospital fixed effects term $\lambda_h$ into various observable measures relating to a particular hospital and its market, resulting in the following linear model:
\begin{equation}
y_{ijh} = \alpha + \beta_1 HP + \beta_2 CIGNA + \delta_j + \zeta n_h + \pi_1c_{jh} + \pi_2q_h + \bf{\pi_3 X_{c(h)}} + \varepsilon_{ijh}
\end{equation}
where $n_h$ represents the number of additional hospitals in hospital $h$'s market and proxies for hospital competition; $c_{jh}$ denotes the typical patient complexity for procedure $j$ at hospital $h$; $q_h$ denotes overall hospital quality at hospital $h$ as provided through the CMS Hospital Compare data; and $\bf{X_{c(h)}}$ is a vector of county-level characteristics for each hospital's county $c(h)$ that include the median household income, the percentage of people over 65 years of age, and population density. The primary coefficient of interest in this second set of regressions is $\hat \zeta$ which estimates how hospital competition may be related to prices. If $\hat \zeta$ is negative, this suggests that the more hospital competition there is within a hospital's market, the lower the prices.

A hospital's market is defined differently across several specifications, resulting in different levels of hospital density $n_h$ across different regressions. I first use HSA and HRR definitions for hospitals' markets and count the total number of additional hospitals within hospital $h$'s market. In another specification, I also count the number of additional hospitals that provide the same service within that market such that the hospital competition term in Equation (4) becomes $n_{jh}$. This attempts to isolate whether the hospital is truly competing with other hospitals in its market in providing procedure $j$ or whether it may be the only hospital in its market providing that service and therefore faces no competitors.^[Hospitals and insurers often explicity negotiate prices for each individual service, so it is possible that hospitals compete on a procedure-level basis.] While the 33 radiology services I have restricted my analysis to are quite common, I do not observe prices for all service-hospital combinations in the NH HealthCost data because some hospitals provide certain services very infrequently or the observations were dropped due to low precision of the estimate as explained in Section IV.I. Thus, my estimates are based only on service-hospital combinations for which I observe at least one price as this signals the hospital frequently provides the service in the outpatient setting. Most hospitals in the dataset do provide at least half of the relevant services and there does not appear to be a consistent set of services for which price data are missing.

The second set of market definitions I use are based on geographical radii drawn around each hospital. As with the HSA/HRR market definitions, I count the total number of hospitals as well as the number of hospitals that also provide the same service/procedure within a 5-mile radius (local market), 15-mile radius (broader market), and 25-mile radius (even broader market) of each hospital $h$. As the services being examined are all outpatient services, the HSA/HRR definitions may not truly capture the potential patient population and potential competitors because they are calculated on the basis of hospitalization (inpatient) events. For outpatient services as compared to inpatient services, patients may place greater weight on convenience and distance to the hospitals in their plan's networks in the outpatient setting rather than the intensity of care they can receive there because their health status is often less acute in the outpatient setting as compared to the inpatient setting. Therefore, insurers may want to provide attractive plans that offer patients enough convenient choice in their relevant market but without facing high premiums or out-of-pocket costs. Thus, this radial measure of a hospital's market may be more applicable to consumers' choices, particularly in the outpatient setting.

The key results of my analysis rely on an additional specification of Equation (4) where I add an interaction between the number of additional hospitals in hospital $h$'s market and an indicator for each insurer to allow for heterogenous relationships to hospital density:
\begin{equation}
y_{ijh} = \alpha + \beta_1 HP + \beta_2 CIGNA + \delta_j + \zeta n_h + \tau_1 (n_h \* HP) + \tau_2 (n_h \* CIGNA) 
+ \pi_1c_{jh} + \pi_2q_h + \bf{\pi_3 X_{c(h)}} + \varepsilon_{ijh}
\end{equation}
That is, the magnitudes of $\hat \zeta$, $\hat \tau_1$, and $\hat \tau_1$ indicate whether one insurer may be more sensitive to the level of hospital competition present in hospital $h$'s market because of their relative bargaining leverage in the price negotiation process. This bargaining leverage may be a function the market share of insurer $i$ in hospital $h$'s market or a function of hospital $h$ market share in insurer $i$'s market. In order to explore this possibility, I further decompose the insurer dummies of Equation (5) into the insurer's statewide market share $s_i$ as well as the proportion of the insurer's total enrollment composed of New Hampshire residents $e_i^{NH}$ to examine whether these factors are driving heterogeneity across the insurers in the following equation: 
\begin{equation}
y_{ijh} = \theta s_i + \vartheta e_i^{NH} + \delta_j + \zeta n_h + \kappa (n_h \* s_i) + \varphi (n_h \* e_i^{NH}) 
+ \pi_1p_{jh} + \pi_2q_h + \bf{\beta_3 X_{c(h)}} + \varepsilon_{ijh}
\end{equation}
While ideally I would have the precise hospital-market level estimates of these values, I proxy for these values using statewide estimates. As a reminder, Anthem insurers 39% of group insured individuals in New Hampshire, Harvard Pilgrim insures 27%, and Cigna insures 20%, but Anthem's proportion of total enrollment comprised of New Hampshire residents is about 0.5%, Cigna's is about 0.7%, and Harvard Pilgrim's is 12%. The limitations of this method are that these statewide distributions may not completely account for the actual market share of a particular insurer $i$ in hospital $h$'s market or of a particular hospital $h$ market share in insurer $i$'s market.^[This may be particularly true for small CAHs.] However, the coefficient $\hat \kappa$ will test whether the relationship between prices and hospital density is greater for insurers with greater state market share, and the coefficient $\hat \varphi$ will test whether this relationship is stronger when a greater share of the insurer's enrollees are New Hampshire residents, allowing me to observe the aggregated associations between hospital's and insurer's market shares relative to one another.



# Results
The first set of results presented in Table 2 demonstrate that there are statistically significant differences in the prices paid by each insurer for a particular service *within* each hospital and that prices are negatively associated with market power. Standard errors are clustered by procedure and hospital when procedure and hospital fixed effects are included, and the coefficients are presented as the percentage of the Medicare price *above* the Anthem price, which is also expressed as a percentage of the Medicare price in the constant, for each service at each hospital as Anthem is the omitted insurer dummy variable. In the primary specification in Column 3, these positively estimated coefficients suggest that on average Anthem the lowest prices at 181.8% of the Medicare price, Harvard Pilgrim pays more than Anthem by 26.2% the Medicare price, and Cigna pays more than Anthem by 38.3% the Medicare price. That is, Harvard Pilgrim pays about 14% more than Anthem, and Cigna pays about 21% more than Anthem on average. The basic fixed effects linear model of price on market share in Column 4 results in a negative and statistically significant coefficient on insurer statewide market share that estimates a 1% increase in insurer statewide market share is associated with a 2% of the Medicare price decrease in prices within a hospital. None of the results presented have causal interpretations, but they do demonstrate strong associations between the insurer's statewide market share and price as all estimated coefficients are statistically significant at at least the 5% level.
```{r, echo=FALSE, results = "asis", fig.align='center', message=FALSE}
stargazer(lm_insurers1, lm_insurers2, lm_insurers3, lm_market_share, 
          se = list(NULL, se_insurers2, se_insurers3, se_market_share), header = FALSE,
          add.lines = list(c("Procedure Fixed Effects", "No", "Yes", "Yes", "Yes"), 
                           c("Hospital Fixed Effects", "No", "No", "Yes", "Yes"),
                           c("", "", "", "", ""),
                           c("Clustered Standard Errors", "No", "Yes", "Yes", "Yes")),
          keep.stat = c("n", "rsq"),
          omit = c("procedure", "provider_name"),
          title = "Within Hospital Price Variation Across Insurers and Market Share",
          covariate.labels = c("Harvard Pilgrim", "Cigna", "Statewide Commercial Market Share", "Constant"), 
          dep.var.caption = "\\it{Dependent variable:} \\rm{Percent of Medicare Price}", font.size = "scriptsize", table.layout = "=lc#-t-a-s-n")
```

The second set of results presented in Tables 3-4 suggest that the number of hospitals in a hospital's market is negatively related to price at a statistically significant level across all definitions of a hospital's market and that the magnitude of this relationship decreases with distance.^[An HSA is the most local market (equivalent to drawing a 5-mile radius around each hospital), and an HRR is a broader market that the HSA or 15-mile radial markets but typically includes fewer hospitals than 25-mile radial markets.] Standard errors are clustered by procedure across all specifications presented. Table 3 presents the results where markets are defined at the hospital-level by HSA/HRR or radius, and Table 4 presents the results where markets are defined at the hospital-*procedure*-level by HSA/HRR or radius. These coefficients estimate that the addition of one hospital to a hospital's HSA definition is associated with a decrease in prices equivalent to 21% of the Medicare price and 25% of the Medicare price if offering the same procedure. The addition of any hospital within a hospital's 25-mile radius is associated with a price decrease equivalent to 5-6% of the Medicare price. All coefficients on the included quality and cost control variables are statistically insignificant, which may suggest that calculating prices as a percent of the Medicare price adequately controls for most variation in hospitals' costs and quality.^[Given that the Medicare prices do not vary at all within New Hampshire, there may be little variation in costs and quality within New Hampshire to begin with] Lastly, the coefficients on each insurer dummy remain similar to those in Table 1, indicating that both Harvard Pilgrim and Cigna still pay significantly higher prices than Anthem on average across all hospitals in the state. On the whole, these results suggest that, controlling for typical patient complexity, hospital quality, and county level characteristics, the greater the number of hospitals in a hospital's market, the lower the prices at that hospital tend to be, and that this association is more intense the smaller geographical area defining the hospital's market.
```{r, echo=FALSE, results = "asis", message=FALSE}
stargazer(lm_hospitals1, lm_hospitals5, lm_hospitals2, lm_hospitals6,
          se = list(se_hospitals1, se_hospitals5, se_hospitals2, se_hospitals6),
          header = FALSE,
          add.lines = list(c("Procedure Fixed Effects", "Yes", "Yes", "Yes", "Yes"),
                           c("", "", "", "", ""),
                           c("Clustered Standard Errors", "Yes", "Yes", "Yes", "Yes")),
          keep.stat = c("n", "rsq"),
          omit = "procedure",
          title = "Across Hospital Price Variation and Total Hospital Market Density",
          covariate.labels = c("HSA Hospital Density",
                               "15-mile Hospital Density",
                               "HRR Hospital Density",
                               "25-mile Hospital Density",
                               "Typical Patient \\ Complexity",
                               "Hospital Quality",
                               "Median Income \\ (in 1000s)",
                               "Percent Population \\ 65 and older",
                               "Population Density",
                               "Harvard Pilgrim",
                               "Cigna",
                               "Constant (Anthem)"),
          dep.var.caption = "\\it{Dependent variable:} \\rm{Percent of Medicare Price}", font.size = "scriptsize", table.layout = "=lc#-t-a-s-n")
```

```{r, echo=FALSE, results = "asis", message=FALSE}
stargazer(lm_hospitals3, lm_hospitals7, lm_hospitals4, lm_hospitals8,
          se = list(se_hospitals3, se_hospitals7, se_hospitals4, se_hospitals8),
          header = FALSE,
          add.lines = list(c("Procedure Fixed Effects", "Yes", "Yes", "Yes", "Yes"),
                           c("", "", "", "", ""),
                           c("Clustered Standard Errors", "Yes", "Yes", "Yes", "Yes")),
          keep.stat = c("n", "rsq"), 
          omit = "procedure",
          title = "Across Hospital Price Variation and Hospital Market Density by Procedure",
          covariate.labels = c("HSA Hospital Density \\ by Procedure",
                               "15-mile Hospital Density \\ by Procedure",
                               "HRR Hospital Density \\ by Procedure",
                               "25-mile Hospital Density \\ by Procedure",
                               "Typical Patient \\ Complexity",
                               "Hospital Quality",
                               "Median Income \\ (in 1000s)",
                               "Percent Population \\ 65 and older",
                               "Population Density",
                               "Harvard Pilgrim",
                               "Cigna",
                               "Constant (Anthem)"),
          dep.var.caption = "\\it{Dependent variable:} \\rm{Percent of Medicare Price}", font.size = "scriptsize", table.layout = "=lc#-t-a-s-n")
```

The last set of primary results presented in Table 5 involve the interaction of hospital market density with each insurer as well as specifications in Columns 5 and 6 that decompose the insurer dummies into statewide market share of the insurer and the proportion of the insurer's total enrollment that are New Hampshire residents. Within the 5-mile definition of a market shown in Column 1, the only a statistically significant relationship between hospital density and price is on the Harvard Pilgrim interaction term. Most hospitals do not have another competitor within their 5-mile radius, and in this case, Harvard Pilgrim pays 31.7% of the Medicare price more than Anthem and Cigna pays 38.7% more. However, when hospitals do have one other competitor in their local market, Harvard Pilgrim actually pays 4.2% *less* than Anthem on average while Cigna continues to pay about the same amount more than Anthem, and Anthem prices do not vary much if a competitor is added within a 5-mile radius. This suggests that for local hospital market density, Anthem and Cigna prices are not very sensitive, but for Harvard Pilgrim, prices do differ significantly with density variation. 

In the 25-mile radius market specification shown in Column 2, there are statistically significant coefficients for the 25-mile radial density, the Harvard Pilgrim dummy, the Harvard Pilgrim interaction, and the Cigna interaction. Taken in combination, these coefficients suggest that if one additional hospital is placed within 25 miles of another hospital, Anthem prices decrease by 6.0% of the Medicare price on average, Harvard Pilgrim prices decrease by 10.2% of the Medicare price on average, and Cigna prices decrease by only 0.62% of the Medicare price on average. Thus, Cigna prices appear the least price sensitive to hospital density. However, because the coefficient on the Cigna dummy is statistically insignificant, the estimates suggest that Cigna in markets with few hospitals, Anthem and Cigna pay much more similar prices: Cigna pays only 5.4% of the Medicare price more than Anthem at hospitals with no competitors within 25 miles. However, when there are 9 hospitals within 25-miles of a hospital (the maximum number observed), Cigna pays 47% of the Medicare price more than Anthem on average. Harvard Pilgrim, on the other hand, pays 39.1% of the Medicare price more than Anthem at hospitals with no competitors on average, but at hospitals with 9 competitors, Harvard Pilgrim pays only 1.3% of the Medicare price more than Anthem. If observations of Harvard Pilgrim are dropped from the dataset as shown in Columns 3 and 4, the relationship between price and hospital density at the 5-mile radius level is statistically equivalent to zero, but the hospital density relationship to price persists at the 25-mile radius level in Column 4 for both Anthem and Cigna though it is smaller in magnitude (-8.1) than that for Harvard Pilgrim in Column 2 (-10.2).

The last two columns of Table 5 are the key specifications that examine the mechanisms behind the observed heterogeneity in insurer responsiveness to hospital competition. Across both market specifications, hospital market density is negatively associated with price, although much more strongly in the local market (5-mile) specification, but the interaction terms of hospital density with market share and New Hampshire enrollment are positive. The coefficient on the market share/hospital density interaction is almost exactly equal and opposit to the coefficient on market share alone, so taken in combination, the two suggest that prices vary little given the insurer's market share with hospital density. This effect is largely led by Anthem and Cigna, whose relative prices vary much less than Harvard Pilgrim's across local hospital market concentration. More importantly, however, the positive coefficient on the New Hampshire enrollment interaction term suggests that insurers with more of total enrollment in New Hampshire are significantly more responsive to local hospital market density. Specifically, if a hospital provides care to 1% more of an insurer's enrolled population, that insurer's relative prices at that hospital are higher by 3.7% of the Medicare price. Given that roughly 10% more of Harvard Pilgrim's total enrollment is composed of New Hampshire residents compared to Anthem and Cigna, this translates into Harvard Pilgrim paying 37% of the Medicare price *more* than its usual relative price to the other insurers if the hospital faces no competitors within a 5-mile radius.

```{r, echo=FALSE, results = "asis", message=FALSE}
lm_hospitals_noHP_1 <- lm(data = subset(primary_regression_data, insurer != "Harvard Pilgrim HC"),
                          formula = percent_medicare ~ n_hosp_5mi_total*CIGNA +
                            typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density
                            + procedure)
vcov_hospitals_noHP_1 <- cluster.vcov(lm_hospitals_noHP_1, subset(primary_regression_data, insurer != "Harvard Pilgrim HC")$procedure)
se_hospitals_noHP_1 <- sqrt(diag(vcov_hospitals_noHP_1))
lm_hospitals_noHP_2 <- lm(data = subset(primary_regression_data, insurer != "Harvard Pilgrim HC"),
                          formula = percent_medicare ~ n_hosp_25mi_total*CIGNA +
                            typical_patient_complexity_scale + `Hospital Quality` + median_household_income + percent_pop_over65 + pop_density
                            + procedure)
vcov_hospitals_noHP_2 <- cluster.vcov(lm_hospitals_noHP_2, subset(primary_regression_data, insurer != "Harvard Pilgrim HC")$procedure)
se_hospitals_noHP_2 <- sqrt(diag(vcov_hospitals_noHP_2))
stargazer(lm_hospitals_insurers_5, lm_hospitals_insurers_7, lm_hospitals_noHP_1, lm_hospitals_noHP_2, lm_hospitals_ms_1, lm_hospitals_ms_3,
          se = list(se_hospitals_insurers_5, se_hospitals_insurers_7, se_hospitals_noHP_1, se_hospitals_noHP_2, se_hospitals_ms_1, se_hospitals_ms_3),
          header = FALSE,
          add.lines = list(c("Procedure Fixed Effects", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("", "", "", "", ""),
                           c("Clustered Standard Errors", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes")),
          keep.stat = c("n", "rsq"), 
          omit = "procedure",
          title = "Across Hospital Price Variation and Hospital Market Density Across Insurers and Insurer Market Share",
          column.labels = c("All Major Private Insurers", "No Harvard Pilgrim", "Statewide Market Shares"), column.separate = c(2, 2, 2),
          order = c("n_hosp_5mi_total", "n_hosp_5mi_total:Harvard_Pilgrim_HC", "n_hosp_5mi_total:CIGNA", "n_hosp_5mi_total:commercial_market_share",
                    "n_hosp_5mi_total:nh_enrollment_share",
                    "n_hosp_25mi_total", "n_hosp_25mi_total:Harvard_Pilgrim_HC", "n_hosp_25mi_total:CIGNA", "n_hosp_25mi_total:commercial_market_share",
                    "n_hosp_25mi_total:nh_enrollment_share",
                    "typical_patient_complexity_scale", "`Hospital Quality`", "median_household_income", "percent_pop_over65", "pop_density",
                    "Harvard_Pilgrim_HC", "CIGNA", "commercial_market_share"),
          covariate.labels = c("5-mile Hospital Density", 
                               "5-mile Density x HP", 
                               "5-mile Density x Cigna", 
                               "5-mile Density x Market Share",
                               "5-mile Density x NH Enrollment",
                               "25-mile Hospital Density", 
                               "25-mile Density x HP", 
                               "25-mile Density x Cigna", 
                               "25-mile Density x Market Share",
                               "25-mile Density x NH Enrollment",
                               "Typical Patient Complexity", 
                               "Hospital Quality", 
                               "Median Household Income (1000s)", 
                               "Percent Population Over 65", 
                               "Population Density",
                               "Harvard Pilgrim", 
                               "Cigna", 
                               "Statewide Market Share",
                               "NH Enrollment Share",
                               "Constant (Anthem)"),
          dep.var.caption = "\\it{Dependent variable:} \\rm{Percent of Medicare Price}", font.size = "tiny", column.sep.width = "2pt",
          table.layout = "=lc#-t-a-s-n")
```
These relationship persist at the broader 25-mile radius market definition although the combined coefficients on insurer market share are definitively negative. This suggests that in market specifications that include more hospitals, the larger insurers negotiate lower prices by 3% of the Medicare price on average for every additional unit of market share. However, while the combined effects of insurer's New Hampshire enrollment are negative in broader markets, the interaction term on New Hampshire enrollment and hospital density is positive. This suggests that if Anthem and Harvard Pilgrim both had equal New Hampshire shares of enrollment, their relative prices would remain roughly constant to one another and lower than Cigna's, but because Harvard Pilgrim has a much greater proportion of New Hampshire enrollment, it may not be able to negotiate as effectively as Anthem for lower prices even as hospital competition within the broader market increases. These results are generally consistent with the Nash-Bertrand bargaining model as discussed further in section VII.

## Secondary Analyses
I perform two secondary analyses to provide a more complete background to the results of the primary analysis. First, I examine whether the relationships found in the second step of my primary analysis investigating hospital density remain the same if I instead regress on *provider* density, which may include clinics, physician groups, and ambulatory surgery centers that also provide a particular service. I evaluate this association between prices and provider density for the prices at all providers in the dataset (Columns 1-3) and for prices at hospitals only (Columns 4-6) in Table 6. I find that, similar to my primary analysis, a negative relationship of price to hospital density persists and continues to decrease as the radial definition of the market increases for provider density, although the coefficients are generally smaller in magnitude than for the hospital density results presented in Table 3. However, within Table 5, the magnitude of the relationship between prices and provider density is somewhat greater when considering the prices at all providers (Columns 1-3) than just the prices at hospitals (Columns 4-6). This may suggest that hospitals do not really face much competition from non-hospital providers, which often are much smaller in maximum capacity compared to hospitals, and may be due to the being unable to distiguish providers associated with hospitals from providers that are independent of a hospital.
```{r, echo=FALSE, results = "asis", message=FALSE}
stargazer(lm_providers_1, lm_providers_2, lm_providers_3, lm_providers_4, lm_providers_5, lm_providers_6,
          se = list(se_providers_1, se_providers_2, se_providers_3, se_providers_4, se_providers_5, se_providers_6),
          header = FALSE,
          add.lines = list(c("Procedure Fixed Effects", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"), 
                           c("", "", "", "", "", "", ""),
                           c("Clustered Standard Errors", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes")),
          keep.stat = c("n", "rsq"), 
          omit = "procedure",
          title = "Across Hospital Price Variation and Provider Market Density by Procedure",
          column.labels = c("Prices at All Providers of Procedure", "Prices at Hospitals with Procedure"), column.separate = c(3, 3),
          covariate.labels = c("5-mile Provider Density \\ by Procedure",
                               "15-mile Provider Density \\ by Procedure",
                               "25-mile Provider Density \\ by Procedure",
                               "Typical Patient \\ Complexity",
                               "Hospital Quality",
                               "Median Income \\ (in 1000s)",
                               "Percent Population \\ 65 and older",
                               "Population Density",
                               "Harvard Pilgrim",
                               "Cigna",
                               "Constant (Anthem)"),
          dep.var.caption = "\\it{Dependent variable:} \\rm{Percent of Medicare Price}", font.size = "tiny", table.layout = "=lc#-t-a-s-n")
```
Next, I evaluate the relationship between hospital density and price again, but this time, restrict my observations to prices for the uninsured. The results demonstrate overall that there is not a clear association between hospital density and the prices paid by the uninsured as the coefficients are sometimes positive and sometimes negative and are not consistently statistically significant. In all specifications, however, the coefficients on the controls are statistically significant. Typical patient complexity is strongly and positively associated with higher prices, as is hospital quality and the median household income in the hospital's county, and the percentage of the population 65 and older and population density are both negatively associated with price, also with statitical significance at the 1% level.
```{r, echo=FALSE, results = "asis", message=FALSE}
stargazer(lm_uninsured_1, lm_uninsured_2, lm_uninsured_3, lm_uninsured_4,
          se = list(se_uninsured_1, se_uninsured_2, se_uninsured_3, se_uninsured_4),
          header = FALSE,
          add.lines = list(c("Procedure Fixed Effects", "Yes", "Yes", "Yes", "Yes"), 
                           c("", "", "", "", "", "", ""),
                           c("Clustered Standard Errors", "Yes", "Yes", "Yes", "Yes")),
          keep.stat = c("n", "rsq"),
          omit = "procedure",
          title = "Across Hospital Price Variation for the Uninsured and Hospital Market Density by Procedure",
          covariate.labels = c("HSA Hospital Density \\ by Procedure",
                               "15-mile Hospital Density \\ by Procedure",
                               "HRR Hospital Density \\ by Procedure",
                               "25-mile Hospital Density \\ by Procedure",
                               "Typical Patient \\ Complexity",
                               "Hospital Quality",
                               "Median Income \\ (in 1000s)",
                               "Percent Population \\ 65 and older",
                               "Population Density",
                               "Constant"),
          dep.var.caption = "\\it{Dependent variable:} \\rm{Percent of Medicare Price}", font.size = "scriptsize", table.layout = "=lc#-t-a-s-n")
```

# Discussion
The results as a whole suggest that the market power of insurers and hospitals is related to the prices hospitals and insurers negotiate, as consistent with a Nash-Bertrand bargaining model and prior literature. I find that within hospitals and across all hospitals *on average* the insurers and hospitals with the greatest market shares or the fewest competitors are able to negotiate the most favorable prices. In my primary results (Tables 2-5), I find that Anthem, the largest insurer, generally pays the lowest prices and that Cigna, the smallest insurer, generally pays the highest prices, with Harvard Pilgrim frequently paying somewhere in between. I also find that hospitals with more potential competitors nearby tend to negotiate lower prices with all private insurers, and this relationship is stronger the closer the other hospitals are. This implies that hospitals are better substitutes from the insurer's perspective when they serve roughly the same population, and therefore the insurer can more credibly threaten not to include one of the hospitals in its plan network, which affords it greater bargaining leverage and thus more favorable prices.

Furthermore, I find that Harvard Pilgrim is the most price sensitive to hospital concentration out of the three insurers. This discrepancy fits well with the Nash-Bertrand bargaining framework as Harvard Pilgrim stands to gain or lose the most from negotiations with each New Hampshire hospital and is therefore most sensitive to hospitals' bargaining leverage. There are major differences in company structure between Harvard Pilgrim and the other two insurers in that Harvard Pilgrim is a small, private, non-profit health insurance company active mainly in the Northeast United States whereas Anthem and Cigna are both massive, publicly traded companies that provide insurance nationally. As a result, New Hampshire residents constitute less than 1% of total members for Anthem and Cigna but constitute over 12% of membership for Harvard Pilgrim. Furthermore, Harvard Pilgrim's status as a non-profit may additionally affect it's negotiation scenario compared to the other for-profit insurers in the market (Dafny 2019). Thus, in each hospital negotiation with New Hampshire hospitals, Harvard Pilgrim stands to lose or gain much more revenue based on bargaining outcomes than Anthem and Cigna do; that is, the marginal benefit of negotiating lower prices may be greater for Harvard Pilgrim but the marginal cost of not including a hospital in its networks may also be greater for Harvard Pilgrim than the other two insurers. Thus, Harvard Pilgrim appears to have greater hospital density elasticity than Anthem and Cigna, who appear to negotiate prices that have little to do with the hospital's market power. The coefficient on the Harvard Pilgrim dummy (not the interaction) in Column 2 demonstrate that Harvard Pilgrim is estimated to be willing to pay a significantly higher price to successfully negotiate a contract with at least one hospital in a 25-mile radius, perhaps because having no contracts with any hospitals in a 25-mile radius would make its plans sufficiently unattractive to a large proportion of its plan enrollees to harm revenues. Indeed, Harvard Pilgrim is the only insurer for which the dataset contains at least one price observation at all 26 New Hampshire hospitals. In contrast, no prices are observed for Cigna at Upper Connecticut Valley Hospital or Cottage Hospital, and for Anthem, no prices are observed at Upper Connecticut Valley Hospital, Franklin Regional Hospital, New London Hospital, Frisbie Memorial Hospital, Wentworth-Douglass Hospital, or Cheshire Medical Center, so it appears these hospitals have been excluded from Anthem and Cigna's networks.^[All hospitals excluded by Anthem or Cigna are CAHs except for Wentworth-Douglass and Frisbie Memorial, which are both located near each other in Southeastern New Hampshire.] The nature of these exclusions may be indcative of Anthem and Cigna being able to make more credible threats not to include certain hospitals in their network; because they are such large national insurers, the potential impact on their total enrollment from not including one small New Hampshire hospital is likely very small. Additionally, they appear to best leverage this threat in the context of broader markets rather than local markets, and seem to be especially willing to exclude small Critical Access Hospitals, which presumably attract a very minor portion of their enrollees.

While both Cigna and Anthem have many similarities in terms of national presence and for-profit status compared to Harvard Pilgrim, the two have different approaches to health management as highlighted by their rejected merger in 2017. As David Dranove argued before the Department of Justice while the Anthem-Cigna merger was being considered, Cigna is a somewhat smaller national insurer that has focused on reducing costs through innovation like its Collaborative Accountable Care (CAC) arrangements with providers. This results in Cigna often paying somewhat higher prices to providers to incentivize high quality and coordinated care, which may require additional investment on the providers' part. Anthem, on the other hand, tends to rely more heavily on its sheer size to negotiate low prices with providers and therefore reduce costs (Dranove 2017). Thus, the different prices observed by Anthem and Cigna in New Hampshire may not be so much a function of their relative market shares but also a matter of their different approaches to cost saving. Cigna, for instance, appears willing to pay more isolated hospitals (those with few competitors in their 25-mile radius) somewhat more than Anthem, perhaps to encourage coordination of care and other innovations at these hospitals.

My secondary analyses in Tables 6 and 7 also provide some interesting results that suggest that hospitals also face some competition from non-hospital providers that can also provide the same services and that the prices for the uninsured appear to have little to do with hospital market share. The magnitude of the relationship of price to the number of non-hospital providers in the market is somewhat smaller than the relationship when considering only hospitals, which may be due to the non-hospital providers being subsitutes but not perfect subsitutes for hospitals, even in the outpatient setting. For the uninsured, price is statistically positively related to typical patient complexity and hospital quality, which suggests that higher quality hospitals or those more specialized in providing a particular service generally charge higher prices for that service to the uninsured. In addition, higher median household incomes are associated with higher prices for the uninsured, which may reflect labor costs and real estate prices, and older populations and more dense populations are associated negatively with prices. This suggests that hospitals that serve a higher number of Medicare patients generally charge somewhat lower prices to the uninsured. One possible explanation for this is that rather than cost-shifting,^[Cost-shifting is the idea that hospitals may charge private payers and individuals more to make up for financial losses on Medicare patients, but there is little evidence supporting that this does indeed occur.] hospitals that serve more Medicare patients may perhaps face incentives to provide more cost-efficient care as Medicare pays such low prices or are better able to absorb the losses of uncompensated care.

## Limitations
There are several key limitations to this analysis that prevent any causal claims being made from the results of this analysis. First, my data is specific to the state of New Hampshire, 2018 prices, and outpatient radiology services and therefore comparatively small as a result. There are also large gaps in price observations as my data do not contain prices for all services across all hospitals and all insurers. Thus, a more nationally, historically, and clinically representative dataset would be useful for evaluating the external validity of the results. Second, the analysis is limited by the lack of granularity of the data and potential assumptions made by NH HealthCost median price calculations that I am unaware of and therefore unable to account for, such that the potential for omitted variable bias is high. 

Specifically, the insurers' market shares are only available at the state-level, and therefore it cannot be explored whether the local market share of each insurer within each hospital's market affects negotiated prices more than statewide market shares. Furthermore, the hospital's true market share is also unknown as I do not have volume data for each hospital for each service or information on how this volume varies across different insurers. This prevents me from more precisely estimating the hospital's and insurer's positions in the Nash-Bertrand bargaining model. For example, one hospital may serve many more Anthem patients relative to Cigna patients than another hospital or may be present in a market that composes a larger share of Anthem's total enrollment compared to Cigna's. Important details such as these cannot be accounted for in my analysis beyond the lack of certain hospital-insurer combinations from my data suggesting a successful contract was not negotiated. 

While the NH HealthCost data are very useful, I am led to make several key assumptions because I do not have access to the individual claims data myself. First, the initial data I collected included hundreds of additional observations, but these were dropped due to low precision of the cost estimate. However, these dropped observations tended to increase the median prices paid for each service on average, so despite the lower number of observations, this allowed me to make more conservative estimates. Second, I cannot distinguish between whether or not missing hospitals are merely visited infrequently by the insurer's patients or truly out of network, but I make the plausible assumption that patients do not visit these hospitals with enough frequency because they are not referred to those hospitals or face high out-of-pocket costs when doing so. Therefore, it is likely that these hospitals are out of network. Third, all data presented on NH HealthCost reflect 2018 prices only, and therefore I am not able to account for omitted variables that may specifically be associated with the year 2018. 

Finally, I restrict my analysis only to outpatient radiology services in order to plausibly control for cost and quality both within and across hospitals, but this may not be true in all cases, particularly across hospitals. Radiology services involve more than simply the production of a diagnostic image, and while telemedicine is an expanding innovation particularly in radiology and rural areas, I am unable to control for radiologist quality across hospitals. Furthermore, radiology quality is difficult to quantify and compare across hospitals as the radiology services considered are purely diagnostic, and therefore it is not clear what "outcomes" can be measured. What may matter most to patients apart from receiving the correct diagnosis may be more related to patient experience and the timeliness of care. However, I attempt to control for this by including the CMS "Overall Hospital Rating," which takes into account patient experience but this effect may still not be fully captured. In a similar vein, there are many factors that lead consumers to choose where they, which therefore affect how insurers negotiate with each hospital, and I cannot account for all of these factors with a simple linear fixed effects model.



# Policy Implications
Despite the limitations of this analysis, the results as a whole suggest that private insurers and hospitals with greater market shares are able to negotiate more favorable prices for themselves and that these prices are consistent with a Nash bargaining model of the hospital-insurer contract negotiations as put forth in Ho and Lee (2017). That is, prices reflect that insurers with better bargaining leverage are able to negotiate lower prices, and hospitals with greater bargaining leverage are able to negotiate higher prices, more so for insurers who stand to gain more from negotiating a successful contract with the marginal hospital. Therefore, policy that can increase the relative bargaining power of the insurer and decrease the relative bargaining power of the hospital in hospital-insurer price negotiations may help reduce hospital prices. However, whether or not the lower prices that would be achieved by such policies are truly efficient is a critical consideration to keep in mind.

The results and their interpretations suggest important policy ramifications surrounding network adequacy requirements in ACA Marketplaces as it appears the large national insurers are wiling to exclude certain hospitals, particularly small and isolated CAHs, from their plan networks. The ACA requirements mandate that insurers offering plans on the state individual exchanges must have networks that meet the ACA's reasonable access standards, which are a set of maximums times and distances travelled for different types of care and in different settings^[Types of care are broken down by specialty (e.g., primary care, dental, oncology, etc.), and areas are categorized as "Large", "Metro", "Micro", "Rural", and "Counties with Extreme Access Considerations (CEAC)."] (Hall and Brandt, 2017). This may reduce competition between hospitals to offer low cost care as insurers must negotiate contracts with certain hospitals even if those hospitals do no serve a large number of their plan enrollees. As a result, there is a concern that this will increase hospital prices and translate to higher premiums for consumers, and in response, the Trump administration revised these requirements in 2017 to allow for narrower networks in an attempt to mitigate this concern. While I present evidence for the cost-reduction benefits of reduced hospital bargaining leverage on the prices paid by employer-sponsored insurance, the effects on the individual market are outside the scope of this thesis, and it is critical to evaluate whether patients may receive inadequate care as result of these narrower networks in future research.

However, there may be more promising policy solutions that aim to increase insurer's relative bargaining power specifically in hospital-insurer negotiations and not in insurer-employer negotiations. For example, Medicare Advantage plans are allowed to negotiate with hospitals on the basis of the statute that if an agreement on prices is not reached, the insurer of the Medicare Advantage plan simply pays the Medicare rate. This leads most Medicare Advantage payments to be 100-105% of the Medicare price (Berenson et al., 2015; Pelech 2018) as the private insurers offering Medicare Advantage plans are able to leverage this significant threat quite effectively. If the statutes that allow for this to take place for Medicare Advantage plans could be expanded to all private insurance plans, this could significantly increase the market power of insurers in the hospital price negotiation process without impacting their market power with consumers or employers, and therefore competitive pressures would continue to hold premiums low (Curto et al. 2014). However, this sort of policy would dramatically reduce hospitals profits and this could harm hospital innovation with less to invest in research and development and hospital employee benefits. Thus, it is important to further evaluate the broader and longer-term tradeoffs that may result from such a policy in order to truly account for the true economic efficiency of the resulting prices.

Additionally, while this thesis does not evaluate hospital mergers directly, my data do support the hypothesis that greater hospital competition is negatively related to hospital prices, and I observe that Anthem, which tends to pay the lowest hospital prices, does not appear to include Wentworth-Douglass Hospital in its network, the only hospital involved in an official merger within the last 5 years and often one of the most expensive in New Hampshire. Thus, mergers that allow hospital systems to control greater market shares and therefore face less competition are potentially leading hospital prices in the wrong direction, and claims of cost reductions from consolidation should be treated with some skepticism.


# Conclusion
This thesis provides further empirical evidence that hospital prices may be inefficient due to the nature of the hospital-insurer negotiation process but only makes use of a very small portion of the data on private prices that is becoming more and more available. Efforts that continue to encourage hospital price transparency for private insurers potentially bring the hospital care market closer to perfect competition conditions and unquestionably advance research surrounding health spending in the U.S. to generate better informed policy. Although further research is needed to investigate the findings of this thesis in more depth and in other settings, the evidence presented here provides empirical evidence of a clear relationship between hospital competition and hospital prices in New Hampshire and suggests possible economic mechanisms to reduce private health care spending in the U.S.



# References
American Hospital Association, "Trendwatch 2018".

Anderson, Gerard F., Uwe E. Reinhardt, Peter S. Hussey, and Varduhi Petrosyan. 2003. “It’s the prices, stupid: why the United States is so different from other countries” *Health Affairs*, 22(3): 89-105.

Bai, Ge, and Gerard F. Anderson. 2018. “Market Power: Price Variation Among Commercial Insurers For Hospital Services,” *Health Affairs*, 37(10): 1615-1622.

Berenson, Rober, Jonathan H. Sunshine, David Helms, and Emily Lawton. 2015. "Why Medicare Advantage Plans Pay Hospitals Traditional Medicare Prices," *Health Affairs*, 34(8): 1289-95

Brooks, David, "As N.H. hospitals combine forces, some wonder if more state oversight is needed," *Concord Monitor*, January 26, 2019.

Bureau of Economic Analysis National Income and Product Accounts Tables, "Table 1.1.5. Nominal GDP, Table 1.1.1. GDP Growth Rate. Table 1.1.6 Real Gross Domestic Product." 2018.

Capps, Cory S., David Dranove, and Mark A. Satterthwaite. 2003. "Competition and Market Power in Option Demand Markets." *RAND Journal of Economics*, 34(4): 737-763.

Center for Medicare and Medicaid Services, "NHE Fact Sheet." 2018.

Center for Medicare and Medicaid Services NHE Tables, "Table 2: National Health Expenditures, Aggregate and Per Capita Amounts, by Type of Expenditure." 2018.

Cooper, Zach, Stuart V. Craig, Martin Gaynor, and John Van Reenen. 2019. "The Price Ain’t Right? Hospital Prices and Health Spending on the Privately Insured," *The Quarterly Journal of Economics*,

Crunchbase. "Harvard Pilgrim Health Care." 2019.

Curto, Vilsa, Liran Einav, Jonathan Levin, and Jay Bhattacharya. 2014. "Can Health Insurance Competition Work? Evidence from Medicare Advantage." *NBER Working Paper Series*, No. 20818. Revised & resubmitted to *Journal of Political Economy*

Cutler, David, Mark Mcclellan, and Joseph Newhouse. 2000. "How Does Managed Care Do It?" *The RAND Journal of Economics*, 31(3): 526-548

Dafny, Leemore. 2019. "Does It Matter if Your Health Insurer Is For Profit? Effects of Ownership on Premiums, Insurance Coverage, and Medical Spending." *American Economic Journal: Economic Policy* 11(1): 222–265.

Dafny, Leemore, Kate Ho, and Robin S. Lee. 2016. “The Price Effects of Cross-Market Hospital Mergers,” *NBER Working Paper Series*, No. 22106.

Dranove, David, "The Anthem-Cigna Merger: A Post-Mortem," *Health Affairs Blog*, September 5, 2017.

Etehad, Melissa, and Kyle Kim. “The U.S. spends more on healthcare than any other country — but not with better health outcomes.” *Los Angeles Times*. July 18, 2017.

Feldman, Roger, and Douglas Wholey. 2001. "Do HMOs Have Monopsony Power?" *International Journal of Health Care Finance and Economics*, 1(1): 7-22.

Fuchs, Victor. 2012. "Major Trends in the U.S. Health Economy since 1950." *The New England Journal of Medicine*, 366(11): 973-977

Gaynor, Martin, Kate Ho and Robert J. Town. 2015. "The Industrial Organization of Health-Care Markets." *Journal of Economic Literature*, 53(2): 235-284

Gowrisankaran, Guatam, Aviv Nevo, and Robert Town. 2015. “Mergers When Prices Are Negotiated: Evidence from the Hospital Industry,” *American Economic Review*, 105(1): 172-203.

Haefner, Morgan. "America's largest health insurers in 2018." *Becker's Hospital Review*. January 10, 2019.

Hall, Mark and Caitlin Brandt, "Network Adequacy Under The Trump Administration," *Health Affairs Blog*, September 14, 2017.

Ho, Katherine and Robin Lee. 2017. "Insurer Competition in Health Care Markets," *Econometrica*, 85(2): 379–417

Horwitz, Jill. 2005. “Making Profits And Providing Care: Comparing Nonprofit, For-Profit, And Government Hospitals,” *Health Affairs*, 24(1): 790-801.

Kaiser Family Foundation, "State Health Facts - Health Insurance Coverage of the Total Population 2017".

Moriya, Osako, William B. Vogt, and Martin Gaynor. 2010. "Hospital prices and market structure in the hospital and insurance industries," *Health Economics, Policy and Law*, 5(4): 459-479 

New Hampshire Hospital Association Report, "Top Outpatient CPT Codes." 2017. 

New Hampshire Insurance Department, “Preliminary Report of the 2016 Health Care Premium and Claim Cost Drivers.” 2017.

Organization for Economic Cooperation and Development. 2017. “Health at a Glance: OECD Indicators 2017.” 

Papanicolas, Irene, Liana R. Woskie, and Ashish K. Jsa. 2018. “Health Care Spending in the United States and Other High-Income Countries,” *JAMA*, 319(10): 1024-1039.

Pelech, Daria. 2018. "An Analysis of Private-Sector Prices for Physicians’ Services," *Working Paper Series, Congressional Budget Office*, January, 2018.

Reinhardt, Uwe E., Peter S. Hussey, and Gerard F. Anderson. 2004. “U.S. Health Care Spending In An International Context.” *Health Affairs*, 23(3): 10-25.

Reinhardt, Uwe E.. 2006. “The Pricing Of U.S. Hospital Services: Chaos Behind A Veil Of Secrecy,” *Health Affairs*, 25(1): 57-69.
 
Selden, Thomas M., Zeynal Karaca, Patricia Keenan, Chapin White, and Richard Kronick. 2015. "The Growing Difference Between Public And Private Payment Rates For Inpatient Hospital Care." *Health Affairs* 34(12): 2147-2150

Sorenson, Alan. 2003. "Insurer-Hospital Bargaining: Negotiated Discounts in Post-Deregulation Connecticut." *The Journal of Industrial Economics*, 51(4): 469-490

Town, Robert J., and Gregory Vistnes. 2001. "Hospital competition in HMO networks." *Journal of Health Economics*, 20: 733-753.

United States Census Bureau, "QuickFacts - New Hampshire Population Estimates July 1, 2017." 2019.

White, Chapin. 2013. “Contrary To Cost-Shift Theory, Lower Medicare Hospital Payment Rates For Inpatient Care Lead To Lower Private Payment Rates,” *Health Affairs*, 32(1): 935-943.

\newpage

\Large {\bf Appendix A}

\normalsize
Table 8 shows the unadjusted mean prices paid by each insurer for each procedure within the state of New Hampshire. Table 9 shows the percent of medicare these prices translate to when unadjusted. Because these values appear much higher than what is usually found in the relevant literature, I choose to deflate prices by a standardization factor such that the median price paid by the three major private insurers for each procedure is equivalent to 200% of the Medicare price for that procedure. This number is chosen because it appears to be the median percentage of the Medicare price private payer pay for outpatient radiology services according to a working paper Pelech (2018) for the Congressional Budget Office. Therefore, I calculate the standardization factor such that:
$$
2 = \frac{SF_j*{median(p_{ij})}}{p_j^{Medicare}}
$$
where $SF_j$ is the standardization factor I use for procedure $j$, the median is taken of the prices paid by the three major private insurers for procedure $j$, and $p_j^{Medicare}$ denotes the Medicare price for that procedue. Thus, this standardization does nothing to affect the shape of each insurer's price distributions relative to one another but simply makes the results more presentable.
```{r, echo=FALSE, results = "asis", fig.align='center', message=FALSE}
step_1 <- primary_data %>%
  filter(`Hospital Type` != "Non-Hospital Providers", !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283"), locality == "NEW HAMPSHIRE") %>%
  group_by(procedure, insurer) %>% 
  summarize(Median = median(estimate_of_total_cost), sd = sd(estimate_of_total_cost)) %>% 
  ungroup() %>% 
  mutate(procedure = str_replace_all(procedure, "&", "/"),
         Median = currency(Median),
         sd = round(sd, 2)) %>% 
  select(procedure, insurer, Median, sd) %>% 
  spread(key = insurer, value = Median) %>% 
  mutate(Anthem_sd = case_when(!is.na(`Anthem NH`) ~ sd),
         HP_sd = case_when(!is.na(`Harvard Pilgrim HC`) ~ sd),
         CIGNA_sd = case_when(!is.na(CIGNA) ~ sd),
         Uninsured_sd = case_when(!is.na(Uninsured) ~ sd)) %>% 
  select(procedure, Medicare, `Anthem NH`, Anthem_sd, `Harvard Pilgrim HC`, HP_sd, CIGNA, CIGNA_sd, Uninsured, Uninsured_sd)
unadjusted_prices <- step_1 %>%
  filter(!is.na(Uninsured)) %>% 
  select(procedure, Uninsured, Uninsured_sd) %>% 
  left_join(step_1, by = "procedure") %>% 
  select(-`Uninsured.y`, -Uninsured_sd.y)
unadjusted_prices <- step_1 %>%
  filter(!is.na(CIGNA)) %>% 
  select(procedure, CIGNA, CIGNA_sd) %>% 
  left_join(unadjusted_prices, by = "procedure") %>% 
  select(-`CIGNA.y`, -CIGNA_sd.y)
unadjusted_prices <- step_1 %>%
  filter(!is.na(`Harvard Pilgrim HC`)) %>% 
  select(procedure, `Harvard Pilgrim HC`, HP_sd) %>% 
  left_join(unadjusted_prices, by = "procedure") %>% 
  select(-`Harvard Pilgrim HC.y`, -HP_sd.y)
unadjusted_prices <- step_1 %>%
  filter(!is.na(`Anthem NH`)) %>% 
  select(procedure, `Anthem NH`, Anthem_sd) %>% 
  left_join(unadjusted_prices, by = "procedure") %>% 
  select(-`Anthem NH.y`, -Anthem_sd.y)
unadjusted_prices <- step_1 %>% 
  filter(!is.na(Medicare)) %>% 
  select(procedure, Medicare) %>% 
  left_join(unadjusted_prices, by = "procedure") %>% 
  select(-Medicare.y) %>% 
  group_by(procedure) %>% 
  summarize(Medicare.x = mean(Medicare.x), 
            `Anthem NH.x` = mean(`Anthem NH.x`), Anthem_sd.x = mean(Anthem_sd.x), 
            `Harvard Pilgrim HC.x` = mean(`Harvard Pilgrim HC.x`), HP_sd.x = mean(HP_sd.x), 
            CIGNA.x = mean(CIGNA.x), CIGNA_sd.x = mean(CIGNA_sd.x), 
            Uninsured.x = mean(Uninsured.x), Uninsured_sd.x = mean(Uninsured_sd.x)) %>% 
  arrange(desc(Medicare.x)) %>% 
  mutate(procedure = str_remove_all(procedure, "\\s*\\([^\\)]+\\)"),
         procedure = str_replace_all(procedure, "Emergency Department Visit - Low Complexity", "Emergency Room Visit - Low Level"),
         procedure = str_replace_all(procedure, "Emergency Room Visit - Medium", "Emergency Room Visit - Medium Level"),
         procedure = str_replace_all(procedure, "Upper Gastrointestinal Endoscopy, with biopsy", "Upper GI Endoscopy, with biopsy"),
         procedure = str_replace_all(procedure, "CT - Abdomen / Pelvis, with contrast", "CT - Abdomen/Pelvis, with contrast"),
         Anthem_sd.x = paste0("(", Anthem_sd.x, ")"), 
         HP_sd.x = paste0("(", HP_sd.x, ")"), 
         CIGNA_sd.x = paste0("(", CIGNA_sd.x, ")"), 
         Uninsured_sd.x = paste0("(", Uninsured_sd.x, ")"))
kable(unadjusted_prices, format = "latex", caption = "Median Hospital Prices for Radiology Services by Payer", booktabs = T, digits = round(2),
      col.names = c("Procedure", "Medicare", "Anthem", "", "Harvard Pilgrim", "", "Cigna", "", "Uninsured", "")) %>%
  kable_styling(latex_options = "scale_down") %>% 
  add_footnote("All prices presented reflect 2018 prices")
##################
step_1 <- primary_data %>%
  filter(`Hospital Type` != "Non-Hospital Providers", !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283"), locality == "NEW HAMPSHIRE") %>%
  mutate(raw_percent_MC = percent_medicare/standardization_fct) %>% 
  group_by(procedure, insurer) %>% 
  summarize(Median = median(raw_percent_MC), sd = sd(raw_percent_MC)) %>% 
  ungroup() %>% 
  mutate(procedure = str_replace_all(procedure, "&", "/"),
         Median = currency(Median),
         sd = round(sd, 2)) %>% 
  select(procedure, insurer, Median, sd) %>% 
  spread(key = insurer, value = Median) %>% 
  mutate(Anthem_sd = case_when(!is.na(`Anthem NH`) ~ sd),
         HP_sd = case_when(!is.na(`Harvard Pilgrim HC`) ~ sd),
         CIGNA_sd = case_when(!is.na(CIGNA) ~ sd),
         Uninsured_sd = case_when(!is.na(Uninsured) ~ sd)) %>% 
  select(procedure, Medicare, `Anthem NH`, Anthem_sd, `Harvard Pilgrim HC`, HP_sd, CIGNA, CIGNA_sd, Uninsured, Uninsured_sd)
unadjusted_percent_MC <- step_1 %>%
  filter(!is.na(Uninsured)) %>% 
  select(procedure, Uninsured, Uninsured_sd) %>% 
  left_join(step_1, by = "procedure") %>% 
  select(-`Uninsured.y`, -Uninsured_sd.y)
unadjusted_percent_MC <- step_1 %>%
  filter(!is.na(CIGNA)) %>% 
  select(procedure, CIGNA, CIGNA_sd) %>% 
  left_join(unadjusted_percent_MC, by = "procedure") %>% 
  select(-`CIGNA.y`, -CIGNA_sd.y)
unadjusted_percent_MC <- step_1 %>%
  filter(!is.na(`Harvard Pilgrim HC`)) %>% 
  select(procedure, `Harvard Pilgrim HC`, HP_sd) %>% 
  left_join(unadjusted_percent_MC, by = "procedure") %>% 
  select(-`Harvard Pilgrim HC.y`, -HP_sd.y)
unadjusted_percent_MC <- step_1 %>%
  filter(!is.na(`Anthem NH`)) %>% 
  select(procedure, `Anthem NH`, Anthem_sd) %>% 
  left_join(unadjusted_percent_MC, by = "procedure") %>% 
  select(-`Anthem NH.y`, -Anthem_sd.y)
unadjusted_percent_MC <- step_1 %>% 
  filter(!is.na(Medicare)) %>% 
  select(procedure, Medicare) %>% 
  left_join(unadjusted_percent_MC, by = "procedure") %>% 
  select(-Medicare.y) %>% 
  group_by(procedure) %>% 
  summarize(Medicare.x = mean(Medicare.x), 
            `Anthem NH.x` = mean(`Anthem NH.x`), Anthem_sd.x = mean(Anthem_sd.x), 
            `Harvard Pilgrim HC.x` = mean(`Harvard Pilgrim HC.x`), HP_sd.x = mean(HP_sd.x), 
            CIGNA.x = mean(CIGNA.x), CIGNA_sd.x = mean(CIGNA_sd.x), 
            Uninsured.x = mean(Uninsured.x), Uninsured_sd.x = mean(Uninsured_sd.x)) %>% 
  arrange(desc(Medicare.x)) %>% 
  mutate(procedure = str_remove_all(procedure, "\\s*\\([^\\)]+\\)"),
         procedure = str_replace_all(procedure, "Emergency Department Visit - Low Complexity", "Emergency Room Visit - Low Level"),
         procedure = str_replace_all(procedure, "Emergency Room Visit - Medium", "Emergency Room Visit - Medium Level"),
         procedure = str_replace_all(procedure, "Upper Gastrointestinal Endoscopy, with biopsy", "Upper GI Endoscopy, with biopsy"),
         procedure = str_replace_all(procedure, "CT - Abdomen / Pelvis, with contrast", "CT - Abdomen/Pelvis, with contrast"),
         Anthem_sd.x = paste0("(", Anthem_sd.x, ")"), 
         HP_sd.x = paste0("(", HP_sd.x, ")"), 
         CIGNA_sd.x = paste0("(", CIGNA_sd.x, ")"), 
         Uninsured_sd.x = paste0("(", Uninsured_sd.x, ")"))
kable(unadjusted_prices, format = "latex", caption = "Median Hospital Prices for Radiology Services by Payer", booktabs = T, digits = round(2),
      col.names = c("Procedure", "Medicare", "Anthem", "", "Harvard Pilgrim", "", "Cigna", "", "Uninsured", "")) %>%
  kable_styling(latex_options = "scale_down") %>% 
  add_footnote("All prices presented reflect 2018 prices")
# unadjusted_percent_MC <- primary_data %>%
#   filter(`Hospital Type` != "Non-Hospital Providers", !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283"), locality == "NEW HAMPSHIRE") %>%
#   mutate(raw_percent_MC = percent_medicare/standardization_fct) %>% 
#   group_by(procedure, insurer) %>% 
#   summarize(Median = median(raw_percent_MC), sd = sd(raw_percent_MC)) %>% 
#   ungroup() %>% 
#   mutate(procedure = str_replace_all(procedure, "&", "/"),
#          Median = round(Median, 2),
#          sd = round(sd, 2),
#          Median_sd = case_when(insurer == "Medicare" ~ paste0(Median, ""),
#                                insurer != "Medicare" ~ paste0(Median, " (", sd, ")"))) %>% 
#   select(procedure, insurer, Median_sd) %>% 
#   spread(key = insurer, value = Median_sd) %>% 
#   select(procedure, Medicare, `Anthem NH`, `Harvard Pilgrim HC`, CIGNA, Uninsured) %>% 
#   rename("Procedure" = "procedure", "Anthem" = "Anthem NH", "Harvard Pilgrim" = "Harvard Pilgrim HC") %>% 
#   mutate(Procedure = str_remove_all(Procedure, "\\s*\\([^\\)]+\\)"),
#          Procedure = str_replace_all(Procedure, "Emergency Department Visit - Low Complexity", "Emergency Room Visit - Low Level"),
#          Procedure = str_replace_all(Procedure, "Emergency Room Visit - Medium", "Emergency Room Visit - Medium Level"),
#          Procedure = str_replace_all(Procedure, "Upper Gastrointestinal Endoscopy, with biopsy", "Upper GI Endoscopy, with biopsy"),
#          Procedure = str_replace_all(Procedure, "CT - Abdomen / Pelvis, with contrast", "CT - Abdomen/Pelvis, with contrast")) %>% 
#   right_join(desc_price, by = "Procedure")
# 
# kable(unadjusted_percent_MC, format = "latex", caption = "Median Percent of Medicare Price for Radiology Services by Payer (Unadjusted)", booktabs = T, digits = round(2),
#       align = c("l", "r", "r", "r", "r", "r")) %>%
#   kable_styling(latex_options = "scale_down") %>% 
#   add_footnote("All prices presented reflect 2018 prices")
```
