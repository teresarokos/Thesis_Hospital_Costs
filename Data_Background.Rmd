---
title: "Thesis Data Background Work"
author: "Teresa Rokos"
date: "1/9/2019"
output: html_document
---

```{r, include=FALSE}
library(knitr)
library(tidyverse)
library(fs)
library(readxl)
library(janitor)
library(scales)
library(ggthemes)
library(stringi)
```

## Background
This thesis is interested in evaluating how the market power of insurers and hospitals in sub-markets determines the prices insurers and hospitals negotiate for hospital care. New Hampshire provides a carrier-specific prices by hospital for particular medical procedures and services on the [NH HealthCost website](https://nhhealthcost.nh.gov/costs/select) and therefore provides a unique case-study of insurer versus hospital market power. The pie charts below are taken from the [NH Insurance Department 2017 Final Report of Health Care Premium and Claim Cost Drivers](https://www.nh.gov/insurance/reports/documents/2018-nhid-annual-hearing-final-report.pdf) (published November 2018) and illustrate relevant information about the insurance market in New Hampshire.

```{r, echo=FALSE, out.width="100%"}
knitr::include_graphics("Images/statewide_coverage_type.png")
knitr::include_graphics("Images/employee_coverage_by_insurer.png")
```

## Raw data from NH HealthCost
To obtain some data on hospital costs, I copy and pasted tables from [NH HealthCost](https://nhhealthcost.nh.gov/costs/select) for particular medical procedures and services into Excel spreadsheets (one for each medical procedure/service). At first, I attempted to mimic the 8 selected services analyzed in [Cooper et al. (2018)](https://healthcarepricingproject.org/sites/default/files/20180507_variationmanuscript_0.pdf) (Inpatient, Hip Replacement, Knee Replacement, Cesarean Section, Vaginal Delivery, PTCA, Colonoscopy, and Lower Limb MRI), but the website only had data for colonoscopies and MRIs. I therefore chose 8 of my own procedures somewhat randomly: Arthroscopic Knee Surgery (outpatient), Diagnostic colonoscopy (outpatient), Colonoscopy with biopsy (outpatient), Colonoscopy with polyp removal (outpatient), MRI - Pelvis (outpatient), X-Ray - Ankle (outpatient), MRI - Knee (outpatient), Blood test for complete blood cell count (hemoglobin).

This allowed me to construct a data set containing the estimated price for each procedure and each provider-insurer combination for which data was available. The following boxplots depict the various distributions of estimated prices for each private insurer.

```{r, include=FALSE}

# I have moved the raw Excel files into my R project in the "NH_HealthCost_data" folder. There is a separate .xlsx file for each type of procedure and a separate sheet for each insurer.

eight_procedures <- bind_rows(
  bind_rows(
  "NH_HealthCost_data/29881 Arthroscopic Knee Surgery (outpatient).xlsx" %>%
                              excel_sheets() %>%
                              set_names() %>%
                              map(read_excel, path = "NH_HealthCost_data/29881 Arthroscopic Knee Surgery (outpatient).xlsx"), .id = "Insurer"),
  bind_rows(
  "NH_HealthCost_data/45378 Diagnostic colonoscopy (outpatient).xlsx" %>%
                              excel_sheets() %>%
                              set_names() %>%
                              map(read_excel, path = "NH_HealthCost_data/45378 Diagnostic colonoscopy (outpatient).xlsx"), .id = "Insurer"),
  bind_rows(
  "NH_HealthCost_data/45380 Colonoscopy with biopsy (outpatient).xlsx" %>%
                              excel_sheets() %>%
                              set_names() %>%
                              map(read_excel, path = "NH_HealthCost_data/45380 Colonoscopy with biopsy (outpatient).xlsx"), .id = "Insurer"),
  bind_rows(
  "NH_HealthCost_data/45385 Colonoscopy with polyp removal (outpatient).xlsx" %>%
                              excel_sheets() %>%
                              set_names() %>%
                              map(read_excel, path = "NH_HealthCost_data/45385 Colonoscopy with polyp removal (outpatient).xlsx"), .id = "Insurer"),
  bind_rows(
  "NH_HealthCost_data/72197 MRI - Pelvis (outpatient).xlsx" %>%
                              excel_sheets() %>%
                              set_names() %>%
                              map(read_excel, path = "NH_HealthCost_data/72197 MRI - Pelvis (outpatient).xlsx"), .id = "Insurer"), 
  bind_rows(
  "NH_HealthCost_data/73610 X-Ray - Ankle (outpatient).xlsx" %>%
                              excel_sheets() %>%
                              set_names() %>%
                              map(read_excel, path = "NH_HealthCost_data/73610 X-Ray - Ankle (outpatient).xlsx"), .id = "Insurer"), 
  bind_rows(
  "NH_HealthCost_data/73721 MRI - Knee (outpatient).xlsx" %>%
                              excel_sheets() %>%
                              set_names() %>%
                              map(read_excel, path = "NH_HealthCost_data/73721 MRI - Knee (outpatient).xlsx"), .id = "Insurer"),
  bind_rows(
  "NH_HealthCost_data/85027 Blood test for complete blood cell count (hemoglobin).xlsx" %>%
                              excel_sheets() %>%
                              set_names() %>%
                              map(read_excel, path = "NH_HealthCost_data/85027 Blood test for complete blood cell count (hemoglobin).xlsx"), .id = "Insurer"),
  .id = "Procedure"
) %>% 
  mutate(Procedure = case_when(Procedure == 1 ~ "29881 Arthroscopic Knee Surgery (outpatient)",
                              Procedure == 2 ~ "45378 Diagnostic colonoscopy (outpatient)",
                              Procedure == 3 ~ "45380 Colonoscopy with biopsy (outpatient)",
                              Procedure == 4 ~ "45385 Colonoscopy with polyp removal (outpatient)",
                              Procedure == 5 ~ "72197 MRI - Pelvis (outpatient)",
                              Procedure == 6 ~ "73610 X-Ray - Ankle (outpatient)",
                              Procedure == 7 ~ "73721 MRI - Knee (outpatient)",
                              Procedure == 8 ~ "85027 Blood test for complete blood cell count (hemoglobin)")) %>% 
  separate(Procedure, into = c("CPT_code", "procedure"), sep = " ", extra = "merge")

eight_procedures <- clean_names(eight_procedures, case = "snake")

eight_procedures <- eight_procedures %>% 
  mutate(estimate_of_total_cost = case_when(is.na(estimate_of_total_cost) ~ estimate_of_procedure_cost,
                                            !is.na(estimate_of_total_cost) ~ estimate_of_total_cost)) %>% 
  rename(provider_name = provider_name_compare_selected)

eight_procedures$provider_name <- str_remove(eight_procedures$provider_name, "Compare ")

eight_procedures <- eight_procedures %>% 
  separate(provider_name,sep = " ", into = c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", 
                                   "eleven")) %>%
  select(-six, -eight, -ten) %>% 
  mutate(two = case_when(!is.na(four) ~ two),
         three = case_when(!(!is.na(two) & is.na(seven)) ~ three),
         four = case_when(!is.na(three) ~ four),
         four = case_when(!(!is.na(three) & is.na(nine)) ~ four),
         five = case_when(!(!is.na(three) & is.na(four)) ~ five),
         five = case_when(!(!is.na(four) & is.na(eleven)) ~ five),
         seven = case_when(!(!is.na(four) & is.na(five)) ~ seven),
         seven = case_when(!(!is.na(five) & !is.na(eleven)) ~ seven),
         nine = case_when(!(is.na(seven) & !is.na(eleven)) ~ nine)) %>% 
  unite("provider_name", c("one", "two", "three", "four", "five", "seven", "nine", "eleven"), sep = " ")
eight_procedures$provider_name <- str_remove_all(eight_procedures$provider_name, "NA ")
eight_procedures$provider_name <- str_remove_all(eight_procedures$provider_name, "NA")

```

### Variation accross private payers (statewide)
The following depict how prices vary across the state for the three major private insurers (Anthem NH, CIGNA, and Harvard Pilgrim). 
```{r, echo=FALSE, out.width="100%"}

eight_procedures %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00")) +
  coord_flip() +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  scale_x_discrete(name = "Insurer") +
  labs(title = "Distribution of Cost Estimates Across Major Private Payers", subtitle = "(All eight procedures)")
```

```{r, echo=FALSE, out.width="100%"}

eight_procedures %>%
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  facet_wrap(~procedure, nrow = 4, ncol = 2) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00")) +
  coord_flip() +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  ggtitle("Broken down by procedure") +
  theme(axis.title.y = element_blank())
```

### Within Hospital Price Variation
A large part of the motivation behind this thesis is due to the existence of within-hospital variation of prices: for the exact same service, hospitals are able to charge different payers different amounts. Below are some visual examples to illustrate this variation between the three major private payers for the exact same service at the exact same hospital.

<br>

For hospitals which had a price range between insurers >$100 for ankle x-rays:
```{r, echo=FALSE, out.width="100%"}
eight_procedures %>% 
  filter(procedure == "X-Ray - Ankle (outpatient)", !insurer %in% c("None", "Other")) %>% 
  count(provider_name, insurer) %>% 
  count(provider_name) %>% 
  filter(nn == 3) %>%
  left_join(eight_procedures, by = "provider_name") %>% 
  filter(procedure == "X-Ray - Ankle (outpatient)", !insurer %in% c("None", "Other")) %>%
  group_by(provider_name) %>% 
  mutate(range = max(estimate_of_total_cost) - min(estimate_of_total_cost)) %>% 
  filter(range > 100) %>% 
  ggplot(aes(x = provider_name, y = estimate_of_total_cost, fill = insurer)) +
  geom_col(position = "dodge", width = 0.5) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"), name = "Insurer") +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  labs(title = "Prices Paid by Different Private Insurers", subtitle = "Procedure: X-Ray - Ankle (outpatient)") + 
  theme(axis.title.y = element_blank()) +
  coord_flip()
```

<br>

For hospitals which had a price range between insurers >$20 for blood tests:
```{r, echo=FALSE, out.width="100%"}
eight_procedures %>% 
  filter(procedure == "Blood test for complete blood cell count (hemoglobin)", !insurer %in% c("None", "Other")) %>% 
  count(provider_name, insurer) %>% 
  count(provider_name) %>% 
  filter(nn == 3) %>%
  left_join(eight_procedures, by = "provider_name") %>% 
  filter(procedure == "Blood test for complete blood cell count (hemoglobin)", !insurer %in% c("None", "Other")) %>%
  group_by(provider_name) %>% 
  mutate(range = max(estimate_of_total_cost) - min(estimate_of_total_cost)) %>% 
  filter(range > 20) %>% 
  ggplot(aes(x = provider_name, y = estimate_of_total_cost, fill = insurer)) +
  geom_col(position = "dodge", width = 0.5) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"), name = "Insurer") +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  labs(title = "Prices Paid by Different Private Insurers", subtitle = "Procedure: Blood test for complete blood cell count (hemoglobin)") + 
  theme(axis.title.y = element_blank()) +
  coord_flip()
```

<br>

#### Map of New Hampshire Hospitals:
Source: [New Hampshire Hospital Association](https://www.nhha.org/index.php/nh-hospitals/map-of-hospitals)
```{r, echo=FALSE, out.width="100%"}
knitr::include_graphics("Images/2018_Hospital_Map.png")
```




## Statistical Analysis
# Methodology
The goal of this analysis is to determine whether there is a statistical difference between the prices hospitals charge Anthem, Harvard Pilgrim, and CIGNA in New Hampshire. That is, for the same service at the same hospital, is one insurer consistently paying a higher amount than the other two? In order to go about this, I want to create dummy variables for each of the insurers and regress on price.

```{r}
library(foreign)

eight_procedures <- eight_procedures %>% 
  mutate(Anthem_NH = case_when(insurer == "Anthem NH" ~ 1,
                               insurer != "Anthem NH" ~ 0),
         Harvard_Pilgrim_HC = case_when(insurer == "Harvard Pilgrim HC" ~ 1,
                               insurer != "Harvard Pilgrim HC" ~ 0),
         CIGNA = case_when(insurer == "CIGNA" ~ 1,
                               insurer != "CIGNA" ~ 0)) 

lm_eight_procedures <- eight_procedures %>% 
  filter(!insurer %in% c("None", "Other")) %>% 
  lm(formula = estimate_of_total_cost ~ CIGNA + Harvard_Pilgrim_HC + factor(provider_name) + factor(procedure))

summary(lm_eight_procedures)


eight_procedures %>% 
  filter(!insurer %in% c("None", "Other"), procedure == "Blood test for complete blood cell count (hemoglobin)") %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"))
```
```{r}
eight_procedures %>% 
  filter(!insurer %in% c("None", "Other"), procedure == "Colonoscopy with biopsy (outpatient)") %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"))
```

```{r}
eight_procedures %>% 
  filter(!insurer %in% c("None", "Other"), procedure == "Colonoscopy with polyp removal (outpatient)") %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"))
```

```{r}
eight_procedures %>% 
  filter(!insurer %in% c("None", "Other"), procedure == "Diagnostic colonoscopy (outpatient)") %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"))
```

```{r}
eight_procedures %>% 
  filter(!insurer %in% c("None", "Other"), procedure == "MRI - Knee (outpatient)") %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"))
```

```{r}
eight_procedures %>% 
  filter(!insurer %in% c("None", "Other"), procedure == "MRI - Pelvis (outpatient)") %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"))
```

```{r}
eight_procedures %>% 
  filter(!insurer %in% c("None", "Other"), procedure == "X-Ray - Ankle (outpatient)") %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"))
```

```{r}
eight_procedures %>% 
  filter(!insurer %in% c("None", "Other"), procedure == "Arthroscopic Knee Surgery (outpatient)") %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00"))
```

```{r}
 write.csv(eight_procedures, file = "eight_procedures.csv")
```


```{r}

file_names <- dir_ls("NH_HealthCost_data/")

merge_sheets <- function(x) {
  bind_rows(
    x %>%
      excel_sheets() %>%
      set_names() %>% 
      map(read_excel, path = x), .id = "Insurer")
}

primary_data <- bind_rows(
merge_sheets("NH_HealthCost_data/29881 Arthroscopic Knee Surgery (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/45378 Diagnostic colonoscopy (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/45380 Colonoscopy with biopsy (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/45385 Colonoscopy with polyp removal (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/51798 Urine Capacity Measurement.xlsx"),
merge_sheets("NH_HealthCost_data/70450 CT - Head&Brain, without dye.xlsx"),
merge_sheets("NH_HealthCost_data/70553 MRI - Brain (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/71020 X-Ray - Chest (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/71260 CT - Chest (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/72040 X-Ray - Neck (Spine, Cervical).xlsx"),
merge_sheets("NH_HealthCost_data/72070 X-Ray - Middle Back (Spine, Thoracic).xlsx"),
merge_sheets("NH_HealthCost_data/72100 X-Ray - Spine (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/72148 MRI - Back (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/72170 X-Ray - Pelvis.xlsx"),
merge_sheets("NH_HealthCost_data/72197 MRI - Pelvis (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/73030 X-Ray - Shoulder (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/73110 X-Ray - Wrist (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/73130 X-Ray - Hand.xlsx"),
merge_sheets("NH_HealthCost_data/73221 MRI - Shoulder, Elbow, or Wrist.xlsx"),
merge_sheets("NH_HealthCost_data/73502 X-Ray - Hip.xlsx"),
merge_sheets("NH_HealthCost_data/73562 X-Ray - Knee (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/73610 X-Ray - Ankle (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/73630 X-Ray - Foot (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/73721 MRI - Knee (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/74000 X-Ray - Abdomen.xlsx"),
merge_sheets("NH_HealthCost_data/74177 CT - Abdomen & Pelvis, with contrast.xlsx"),
merge_sheets("NH_HealthCost_data/76536 Ultrasound - Head and Neck.xlsx"),
merge_sheets("NH_HealthCost_data/76642 Ultrasound - Breast (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/76700 Ultrasound - Abdominal, Complete.xlsx"),
merge_sheets("NH_HealthCost_data/76705 Ultrasound - Abdominal, Limited.xlsx"),
merge_sheets("NH_HealthCost_data/76805 Ultrasound - Pregnancy (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/76816 Ultrasound - Pregnancy follow-up.xlsx"),
merge_sheets("NH_HealthCost_data/76830 Ultrasound - Transvaginal (non-maternity).xlsx"),
merge_sheets("NH_HealthCost_data/76856 Ultrasound - Pelvic (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/77067 Mammogram (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/77080 Bone Density Scan (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/78452 Myocardial Imaging (outpatient).xlsx"),
merge_sheets("NH_HealthCost_data/85027 Blood test for complete blood cell count (hemoglobin).xlsx"),
  .id = "Procedure"
) %>% 
  mutate(Procedure = case_when(Procedure == 1 ~ "29881 Arthroscopic Knee Surgery (outpatient)",
Procedure == 2 ~ "45378 Diagnostic colonoscopy (outpatient)",
Procedure == 3 ~ "45380 Colonoscopy with biopsy (outpatient)",
Procedure == 4 ~ "45385 Colonoscopy with polyp removal (outpatient)",
Procedure == 5 ~ "51798 Urine Capacity Measurement",
Procedure == 6 ~ "70450 CT - Head&Brain, without dye",
Procedure == 7 ~ "70553 MRI - Brain (outpatient)",
Procedure == 8 ~ "71020 X-Ray - Chest (outpatient)",
Procedure == 9 ~ "71260 CT - Chest (outpatient)",
Procedure == 10 ~ "72040 X-Ray - Neck (Spine, Cervical)",
Procedure == 11 ~ "72070 X-Ray - Middle Back (Spine, Thoracic)",
Procedure == 12 ~ "72100 X-Ray - Spine (outpatient)",
Procedure == 13 ~ "72148 MRI - Back (outpatient)",
Procedure == 14 ~ "72170 X-Ray - Pelvis",
Procedure == 15 ~ "72197 MRI - Pelvis (outpatient)",
Procedure == 16 ~ "73030 X-Ray - Shoulder (outpatient)",
Procedure == 17 ~ "73110 X-Ray - Wrist (outpatient)",
Procedure == 18 ~ "73130 X-Ray - Hand",
Procedure == 19 ~ "73221 MRI - Shoulder, Elbow, or Wrist",
Procedure == 20 ~ "73502 X-Ray - Hip",
Procedure == 21 ~ "73562 X-Ray - Knee (outpatient)",
Procedure == 22 ~ "73610 X-Ray - Ankle (outpatient)",
Procedure == 23 ~ "73630 X-Ray - Foot (outpatient)",
Procedure == 24 ~ "73721 MRI - Knee (outpatient)",
Procedure == 25 ~ "74000 X-Ray - Abdomen",
Procedure == 26 ~ "74177 CT - Abdomen & Pelvis, with contrast",
Procedure == 27 ~ "76536 Ultrasound - Head and Neck",
Procedure == 28 ~ "76642 Ultrasound - Breast (outpatient)",
Procedure == 29 ~ "76700 Ultrasound - Abdominal, Complete",
Procedure == 30 ~ "76705 Ultrasound - Abdominal, Limited",
Procedure == 31 ~ "76805 Ultrasound - Pregnancy (outpatient)",
Procedure == 32 ~ "76816 Ultrasound - Pregnancy follow-up",
Procedure == 33 ~ "76830 Ultrasound - Transvaginal (non-maternity)",
Procedure == 34 ~ "76856 Ultrasound - Pelvic (outpatient)",
Procedure == 35 ~ "77067 Mammogram (outpatient)",
Procedure == 36 ~ "77080 Bone Density Scan (outpatient)",
Procedure == 37 ~ "78452 Myocardial Imaging (outpatient)",
Procedure == 38 ~ "85027 Blood test for complete blood cell count (hemoglobin)")) %>% 
  separate(Procedure, into = c("CPT_code", "procedure"), sep = " ", extra = "merge")

primary_data <- clean_names(primary_data, case = "snake")

primary_data <- primary_data %>% 
  mutate(estimate_of_total_cost = case_when(is.na(estimate_of_total_cost) ~ estimate_of_procedure_cost,
                                            !is.na(estimate_of_total_cost) ~ estimate_of_total_cost)) %>% 
  rename(provider_name = provider_name_compare_selected)

primary_data$provider_name <- str_remove(primary_data$provider_name, "Compare ")

primary_data <- primary_data %>% 
  separate(provider_name,sep = " ", into = c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", 
                                   "eleven")) %>%
  select(-six, -eight, -ten) %>% 
  mutate(two = case_when(!is.na(four) ~ two),
         three = case_when(!(!is.na(two) & is.na(seven)) ~ three),
         four = case_when(!is.na(three) ~ four),
         four = case_when(!(!is.na(three) & is.na(nine)) ~ four),
         five = case_when(!(!is.na(three) & is.na(four)) ~ five),
         five = case_when(!(!is.na(four) & is.na(eleven)) ~ five),
         seven = case_when(!(!is.na(four) & is.na(five)) ~ seven),
         seven = case_when(!(!is.na(five) & !is.na(eleven)) ~ seven),
         nine = case_when(!(is.na(seven) & !is.na(eleven)) ~ nine)) %>% 
  unite("provider_name", c("one", "two", "three", "four", "five", "seven", "nine", "eleven"), sep = " ")
primary_data$provider_name <- str_remove_all(primary_data$provider_name, " NA")

primary_data %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("None" = "#999999", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                      "Harvard Pilgrim HC" = "#CC0000", "Other" = "#FFCC00")) +
  coord_flip() +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  scale_x_discrete(name = "Insurer") +
  labs(title = "Distribution of Cost Estimates Across Major Private Payers", subtitle = "(27 procedures)")

library(foreign)

anthem_prices <- primary_data %>% 
  filter(insurer == "Anthem NH") %>% 
  mutate(anthem_price = estimate_of_total_cost) %>% 
  select(cpt_code, procedure, provider_name, anthem_price)

primary_data <- primary_data %>% 
  left_join(anthem_prices, by = c("cpt_code", "procedure", "provider_name")) %>% 
  mutate(percent_of_anthem = (estimate_of_total_cost/anthem_price)*100,
         Anthem_NH = case_when(insurer == "Anthem NH" ~ 1,
                               insurer != "Anthem NH" ~ 0),
         Harvard_Pilgrim_HC = case_when(insurer == "Harvard Pilgrim HC" ~ 1,
                               insurer != "Harvard Pilgrim HC" ~ 0),
         CIGNA = case_when(insurer == "CIGNA" ~ 1,
                               insurer != "CIGNA" ~ 0))
  

lm_primary_data <- primary_data %>% 
  filter(!insurer %in% c("None", "Other")) %>% 
  lm(formula = percent_of_anthem ~ CIGNA + Harvard_Pilgrim_HC + factor(provider_name) + factor(procedure))

summary(lm_primary_data)


```

```{r}
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)

states <- map_data("state")

north_east <- subset(states, region %in% c("vermont", "new hampshire", "maine", "massachusetts", "connecticut", "rhode island"))

hospital_info <- read_csv("hospital_info.csv")

primary_data <- primary_data %>% 
  left_join(hospital_info, by = "provider_name") %>% 
  mutate(longitude = -longitude)

ggplot(data = north_east) + 
  geom_polygon(aes(x = long, y = lat, group = group), fill = "palegreen", color = "black") + 
  coord_fixed(1.3) +
  geom_point(data = primary_data, mapping = aes(x = longitude, y = latitude))

glimpse(primary_data)
```

