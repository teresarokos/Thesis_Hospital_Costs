---
title: "Working Thesis"
author: "Teresa Rokos"
date: "February 2019"
output: html_document
---

```{r, include=FALSE}
library(knitr)
library(tidyverse)
library(fs)
library(readxl)
library(janitor)
library(scales)
library(ggthemes)
library(stringi)
```

```{r, include=FALSE}

file_names <- dir_ls("NH_HealthCost_data/")

merge_sheets <- function(x) {
  bind_rows(
    x %>%
      excel_sheets() %>%
      set_names() %>% 
      map(read_excel, path = x), .id = "Insurer")
}

primary_data <- bind_rows(
  merge_sheets("NH_HealthCost_data/29826 Arthroscopic Shoulder Surgery.xlsx"),
  merge_sheets("NH_HealthCost_data/29881 Arthroscopic Knee Surgery (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/42820 Tonsillectomy with Adenoidectomy (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/43239 Upper Gastrointestinal Endoscopy, with biopsy.xlsx"),
  merge_sheets("NH_HealthCost_data/45378 Diagnostic colonoscopy (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/45380 Colonoscopy with biopsy (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/45385 Colonoscopy with polyp removal (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/51798 Urine Capacity Measurement.xlsx"),
  merge_sheets("NH_HealthCost_data/70450 CT - Head&Brain, without dye.xlsx"),
  merge_sheets("NH_HealthCost_data/70553 MRI - Brain (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/71020 X-Ray - Chest (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/71260 CT - Chest (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/72040 X-Ray - Neck (Spine, Cervical).xlsx"),
  merge_sheets("NH_HealthCost_data/72070 X-Ray - Middle Back (Spine, Thoracic).xlsx"),
  merge_sheets("NH_HealthCost_data/72100 X-Ray - Spine (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/72148 MRI - Back (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/72170 X-Ray - Pelvis.xlsx"),
  merge_sheets("NH_HealthCost_data/72197 MRI - Pelvis (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/73030 X-Ray - Shoulder (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/73110 X-Ray - Wrist (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/73130 X-Ray - Hand.xlsx"),
  merge_sheets("NH_HealthCost_data/73221 MRI - Shoulder, Elbow, or Wrist.xlsx"),
  merge_sheets("NH_HealthCost_data/73502 X-Ray - Hip.xlsx"),
  merge_sheets("NH_HealthCost_data/73562 X-Ray - Knee (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/73610 X-Ray - Ankle (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/73630 X-Ray - Foot (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/73721 MRI - Knee (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/74000 X-Ray - Abdomen.xlsx"),
  merge_sheets("NH_HealthCost_data/74177 CT - Abdomen & Pelvis, with contrast.xlsx"),
  merge_sheets("NH_HealthCost_data/76536 Ultrasound - Head and Neck.xlsx"),
  merge_sheets("NH_HealthCost_data/76642 Ultrasound - Breast (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/76700 Ultrasound - Abdominal, Complete.xlsx"),
  merge_sheets("NH_HealthCost_data/76705 Ultrasound - Abdominal, Limited.xlsx"),
  merge_sheets("NH_HealthCost_data/76805 Ultrasound - Pregnancy (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/76816 Ultrasound - Pregnancy follow-up.xlsx"),
  merge_sheets("NH_HealthCost_data/76830 Ultrasound - Transvaginal (non-maternity).xlsx"),
  merge_sheets("NH_HealthCost_data/76856 Ultrasound - Pelvic (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/77067 Mammogram (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/77080 Bone Density Scan (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/78452 Myocardial Imaging (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/85027 Blood test for complete blood cell count (hemoglobin).xlsx"),
  merge_sheets("NH_HealthCost_data/99282 Emergency Department Visit - Low Complexity (outpatient).xlsx"),
  merge_sheets("NH_HealthCost_data/99283 Emergency Room Visit - Medium (outpatient).xlsx"),
    .id = "Procedure"
  ) %>% 
  mutate(Procedure = case_when(Procedure == 1 ~ "29826 Arthroscopic Shoulder Surgery",
    Procedure == 2 ~ "29881 Arthroscopic Knee Surgery (outpatient)",
    Procedure == 3 ~ "42820 Tonsillectomy with Adenoidectomy (outpatient)",
    Procedure == 4 ~ "43239 Upper Gastrointestinal Endoscopy, with biopsy",
    Procedure == 5 ~ "45378 Diagnostic colonoscopy (outpatient)",
    Procedure == 6 ~ "45380 Colonoscopy with biopsy (outpatient)",
    Procedure == 7 ~ "45385 Colonoscopy with polyp removal (outpatient)",
    Procedure == 8 ~ "51798 Urine Capacity Measurement",
    Procedure == 9 ~ "70450 CT - Head&Brain, without dye",
    Procedure == 10 ~ "70553 MRI - Brain (outpatient)",
    Procedure == 11 ~ "71020 X-Ray - Chest (outpatient)",
    Procedure == 12 ~ "71260 CT - Chest (outpatient)",
    Procedure == 13 ~ "72040 X-Ray - Neck (Spine, Cervical)",
    Procedure == 14 ~ "72070 X-Ray - Middle Back (Spine, Thoracic)",
    Procedure == 15 ~ "72100 X-Ray - Spine (outpatient)",
    Procedure == 16 ~ "72148 MRI - Back (outpatient)",
    Procedure == 17 ~ "72170 X-Ray - Pelvis",
    Procedure == 18 ~ "72197 MRI - Pelvis (outpatient)",
    Procedure == 19 ~ "73030 X-Ray - Shoulder (outpatient)",
    Procedure == 20 ~ "73110 X-Ray - Wrist (outpatient)",
    Procedure == 21 ~ "73130 X-Ray - Hand",
    Procedure == 22 ~ "73221 MRI - Shoulder, Elbow, or Wrist",
    Procedure == 23 ~ "73502 X-Ray - Hip",
    Procedure == 24 ~ "73562 X-Ray - Knee (outpatient)",
    Procedure == 25 ~ "73610 X-Ray - Ankle (outpatient)",
    Procedure == 26 ~ "73630 X-Ray - Foot (outpatient)",
    Procedure == 27 ~ "73721 MRI - Knee (outpatient)",
    Procedure == 28 ~ "74000 X-Ray - Abdomen",
    Procedure == 29 ~ "74177 CT - Abdomen & Pelvis, with contrast",
    Procedure == 30 ~ "76536 Ultrasound - Head and Neck",
    Procedure == 31 ~ "76642 Ultrasound - Breast (outpatient)",
    Procedure == 32 ~ "76700 Ultrasound - Abdominal, Complete",
    Procedure == 33 ~ "76705 Ultrasound - Abdominal, Limited",
    Procedure == 34 ~ "76805 Ultrasound - Pregnancy (outpatient)",
    Procedure == 35 ~ "76816 Ultrasound - Pregnancy follow-up",
    Procedure == 36 ~ "76830 Ultrasound - Transvaginal (non-maternity)",
    Procedure == 37 ~ "76856 Ultrasound - Pelvic (outpatient)",
    Procedure == 38 ~ "77067 Mammogram (outpatient)",
    Procedure == 39 ~ "77080 Bone Density Scan (outpatient)",
    Procedure == 40 ~ "78452 Myocardial Imaging (outpatient)",
    Procedure == 41 ~ "85027 Blood test for complete blood cell count (hemoglobin)",
    Procedure == 42 ~ "99282 Emergency Department Visit - Low Complexity (outpatient)",
    Procedure == 43 ~ "99283 Emergency Room Visit - Medium (outpatient)")) %>% 
  separate(Procedure, into = c("CPT_code", "procedure"), sep = " ", extra = "merge")

primary_data <- clean_names(primary_data, case = "snake")

primary_data <- primary_data %>% 
  mutate(estimate_of_total_cost = case_when(is.na(estimate_of_total_cost) ~ estimate_of_procedure_cost,
                                            !is.na(estimate_of_total_cost) ~ estimate_of_total_cost),
         estimate_of_total_cost = case_when(!is.na(what_you_will_pay) ~ what_you_will_pay,
                                            is.na(what_you_will_pay) ~ estimate_of_total_cost)) %>% 
  rename(provider_name = provider_name_compare_selected)

primary_data$insurer <- str_replace(primary_data$insurer, "Uninsured", "Uninsured")

primary_data$provider_name <- str_remove(primary_data$provider_name, "Compare ")

primary_data <- primary_data %>% 
  separate(provider_name,sep = " ", into = c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", 
                                   "eleven")) %>%
  select(-six, -eight, -ten) %>% 
  mutate(two = case_when(!is.na(four) ~ two),
         three = case_when(!(!is.na(two) & is.na(seven)) ~ three),
         four = case_when(!is.na(three) ~ four),
         four = case_when(!(!is.na(three) & is.na(nine)) ~ four),
         five = case_when(!(!is.na(three) & is.na(four)) ~ five),
         five = case_when(!(!is.na(four) & is.na(eleven)) ~ five),
         seven = case_when(!(!is.na(four) & is.na(five)) ~ seven),
         seven = case_when(!(!is.na(five) & !is.na(eleven)) ~ seven),
         nine = case_when(!(is.na(seven) & !is.na(eleven)) ~ nine)) %>% 
  unite("provider_name", c("one", "two", "three", "four", "five", "seven", "nine", "eleven"), sep = " ")
primary_data$provider_name <- str_remove_all(primary_data$provider_name, " NA")

primary_data <- primary_data %>% 
  mutate(locality = case_when(provider_name %in% c("Northeastern Vermont Regional Hospital", "Springfield Medical Care System") ~ "VERMONT",
                              provider_name %in% c("Orthopaedic Surgical Associates", "Northeast Endoscopy Center", "Lowell General Hospital",
                                                   "Lahey Health", "Orthopaedic Northeast", "Steward Medical Group", "Lawrence General Hospital", 
                                                   "Merrimack Valley Endoscopy Center", "Anna Jacques Hospital") ~ "METROPOLITAN BOSTON, MA",
                              provider_name == "York Hospital" ~ "SOUTHERN MAINE",
                              TRUE ~ "NEW HAMPSHIRE"))



# Constructin Medicare prices and adding to primary data set
RVU18_info <- read_xlsx("RVU18A_files/PPRRVU18_JAN_mod.xlsx", skip = 9, col_names = TRUE) %>% 
  rename(cpt_code = HCPCS) %>% 
  filter(cpt_code %in% c(primary_data$cpt_code, 
                         "29806", "29807", "29819", "29820", "29821", "29822", "29823", "29824", "29825",
                         "29873", "29874", "29875", "29876", "29877", "29879", "29880", "29881",
                         "42821",
                         "45384",
                         "71045", "71046", "71047", "71048",
                         "72050",
                         "72072", "72074",
                         "74018", "74019", "74021")) %>% 
  filter(is.na(MOD)) %>% 
  select(cpt_code, DESCRIPTION, WorkRVU = RVU, FacilityPERVU = `PE RVU__1`, MPRVU = RVU__1, ConversionFactor = FACTOR) %>% 
  mutate(cpt_code = case_when(DESCRIPTION == "Shoulder arthroscopy/surgery" ~ "29826",
                              DESCRIPTION == "Knee arthroscopy/surgery" ~ "29881",
                              DESCRIPTION == "Remove tonsils and adenoids" ~ "42820",
                              DESCRIPTION == "Colonoscopy w/lesion removal" ~ "45385",
                              DESCRIPTION %in% c("X-ray exam chest 1 view", "X-ray exam chest 2 views", 
                                                 "X-ray exam chest 3 views", "X-ray exam chest 4+ views") ~ "71020",
                              DESCRIPTION %in% c("X-ray exam neck spine 2-3 vw", "X-ray exam neck spine 4/5vws") ~ "72040",
                              DESCRIPTION %in% c("X-ray exam abdomen 1 view", "X-ray exam abdomen 2 views", "X-ray exam abdomen 3+ views") ~ "74000",
                              DESCRIPTION %in% c("X-ray exam thorac spine 2vws", "X-ray exam thorac spine 3vws", "X-ray exam thorac spine4/>vw") ~ "72070",
                              TRUE ~ cpt_code),
         DESCRIPTION = case_when(cpt_code == "71020" ~ "X-ray exam chest",
                                 cpt_code == "72040" ~ "X-ray exam neck spine",
                                 cpt_code == "74000" ~ "X-ray exam abdomen",
                                 cpt_code == "72070" ~ "X-ray exam thorac spine",
                                 TRUE ~ DESCRIPTION)) %>% 
  group_by(cpt_code, DESCRIPTION) %>% 
  summarize(WorkRVU = mean(WorkRVU), FacilityPERVU = mean(FacilityPERVU), MPRVU = mean(MPRVU), ConversionFactor = mean(ConversionFactor))


GPCI2018_info <- read_xlsx("RVU18A_files/GPCI2018_copy.xlsx", skip = 2, col_names = TRUE) %>% 
  rename(locality = X__3) %>% 
  filter(locality %in% c("NEW HAMPSHIRE", "SOUTHERN MAINE", "METROPOLITAN BOSTON, MA", "REST OF MASSACHUSETTS", "VERMONT")) %>% 
  select(locality, WorkGPCI = `PW GPCI`, PEGPCI = `PE GPCI`, MPGPCI = `MP GPCI`)

medicare_prices <- primary_data %>% 
  left_join(RVU18_info, by = "cpt_code") %>% 
  left_join(GPCI2018_info, by = "locality") %>% 
  mutate(Medicare = ((WorkRVU * WorkGPCI) + (FacilityPERVU * PEGPCI) + (MPRVU * MPGPCI)) * ConversionFactor) %>% 
  select(cpt_code, procedure, provider_name, locality, Medicare) %>% 
  group_by(cpt_code, procedure, provider_name, locality) %>% 
  summarize(Medicare = mean(Medicare)) %>% 
  ungroup()

primary_data <- primary_data %>% 
  left_join(medicare_prices, by = c("cpt_code", "procedure", "provider_name", "locality")) %>% 
  select(cpt_code, procedure, provider_name, locality, insurer, estimate_of_total_cost, medicare_price = Medicare, precision_of_the_cost_estimate, 
         typical_patient_complexity, uninsured_discount)

primary_data <- medicare_prices %>% 
  gather(Medicare, key = insurer, value = estimate_of_total_cost) %>% 
  bind_rows(primary_data) %>% 
  mutate(medicare_price = case_when(insurer == "Medicare" ~ estimate_of_total_cost,
                                    TRUE ~ medicare_price))
```

## Introduction
### Abstract
This thesis evaluates how the market power of insurers and hospitals in geographical sub-markets determines the prices insurers and hospitals negotiate for hospital care. I will examine to what extent the variation in prices is explained by variation in costs and quality versus variation in market power, which may play an important role in bilateral price negotiations for services. Using carrier-hospital specific prices for outpatient medical procedures from New Hampshire's [NH HealthCost website](https://nhhealthcost.nh.gov/costs/select), I compare the estimated prices for the same services across the state, both between hospitals and within hospitals. The methodology for the collection of this data can be found [here](https://nhhealthcost.nh.gov/methodology-health-costs-consumers).

### Motivation
The U.S.'s expenditure on health care has grown rapidly over the last few decades and has outpaced that of many peer countries without significant returns to quality (e.g. OECD 2017; Etehad and Kim 2017; Reinhardt et al., 2004).  A substantial body of research has determined that the biggest driver behind the U.S. health care expenditure is not greater utilization or social spending but quite simply higher prices (e.g. Anderson et al., 2003; Papanicolas et al., 2018). Given that the $3.3 trillion spent on health care annually (17.9% of GDP) (Centers for Disease Control and Prevention 2017) erodes the budgets of families and individuals, state and local governments, and the federal government, understanding the sources of variation in these prices is of tremendous import. 

I choose to focus this paper on hospital prices because hospital care constitutes the largest component of U.S. health care spending at 32.4% ($1.0825 trillion) of national health expenditure (Centers for Disease Control and Prevention 2017) as shown in Figure 1, and a vast body of research has identified wide variation in private insurance reimbursements to hospitals for the same services and/or diagnoses ***citations***. Cooper et al., 2015 finds that for the privately insured, only about half of the variation in expenditure is due to the quantity of care delivered while half is purely driven by price variation while 95% of the variation in expenditure for public programs like Medicare is explained by variation in the quantity of care delivered. 
```{r, echo=FALSE, out.width="100%"}

# Creating a graphic to show the growth in U.S. health care spending over time and specifically the growth in hospital care spending

# 1) putting together the data frame that will have U.S. health expenditure by year manually, using data from the CDC

year <- c(1960, 1970, 1975, 1980, 1990, 2000, 2009, 2015, 2016)
national_health_expenditure <- c(27.2, 74.6, 133.3, 255.3, 721.4, 1369.1, 2495.4, 3200.8, 3337.2) # in billions of dollars
hospital_care_expenditure <- c(9.0, 27.2, 51.2, 100.5, 250.4, 415.5, 779.6, 1033.4, 1082.5) # in billions of dollars
phys_clinical_sevices_exp <- c(5.6, 14.3, 25.3, 47.7, 158.4, 288.2, 497.7, 631, 664.9) # in billions of dollars
prescrip_drugs_exp <- c(2.7, 5.5, 8.1, 12, 40.3, 121, 252.7, 324.5, 328.6)
real_gdp <- c(3260, 4951, 5645, 6759, 9366, 13131, 15209, 17387, 17659) # in billions of dollars, adj for inflation using 2012 dollars; https://www.thebalance.com/us-gdp-by-year-3305543

health_expenditures <- data.frame(year, national_health_expenditure, hospital_care_expenditure, real_gdp)


# 2) converting expenditures to percents of gdp
health_expenditures <- health_expenditures %>% 
  mutate(percent_nhe = national_health_expenditure/real_gdp,
         percent_hce = hospital_care_expenditure/real_gdp,
         percent_pcse = phys_clinical_sevices_exp/real_gdp,
         percent_pde = prescrip_drugs_exp/real_gdp) %>% 
  select(year, percent_nhe, percent_hce, percent_pcse, percent_pde) %>% 
  gather(-year, percent_pde, key = component_of_exp, value = percent_of_gdp)


# 2) putting together a line plot that will show this growth over time

ggplot(data = health_expenditures) +
  geom_line(mapping = aes(x = year, y = percent_of_gdp, color = fct_reorder(component_of_exp, -percent_of_gdp))) +
  labs(title = "Figure 1: Health Care Spending in the U.S. over time", caption = "Source: Centers for Disease Control and Prevention 2017") +
  scale_y_continuous(name = "Spending (percentage of GDP)", labels = percent) +
  scale_x_continuous(name = "Year", breaks = c(1960, 1970, 1980, 1990, 2000, 2010)) +
  scale_color_manual(name = "Component of Spending", values = c("percent_nhe" = "black", 
                                                                "percent_hce" = "red", 
                                                                "percent_pcse" = "gray", 
                                                                "percent_pde" = "light gray"),
                    labels = c("Total National Health Expenditure", "Hospital Care", "Physician and Clinical Services", "Prescription Drugs"))
```
 
Given that the largest portion of Americans (49%) receive health care coverage from their employer through private insurance plans rather than through Medicare and Medicaid (Kaiser Family Foundation 2017), this price variation among private insurers may affect what many Americans pay out of pocket for their healthcare. Moreover, this prior research such as Cooper et al. 2015 finds that this variation persists even when costs and quality are held constant. 

This paper is most closely related to Cooper et al. 2015, but differs in several key respects: first, this analysis will focus a set of price data for hospital care in New Hampshire, while Cooper et al. 2015 relies on HCCI data which is a national cross-section sample and relies on claims data from Aetna, Humana, and United Health. While the HCCI data is a rich set of data that is perhaps nationally representative in a broad sense, none of these insurers are major players in the New Hampshire market; secondly, this paper will devote more attention to insurers' relative market power as well as the effects on the uninsured who have minimal market power; lastly, I also include an analysis of how the share of Medicare patients at a given hospital affects the prices that hospital negotiates with private insurers.

### Price Variation in the New Hampshire Market
The New Hampshire Hospital Association provides a list of the [top outpatient CPT codes](https://www.nhha.org/images/Data/Outpatient-CPT-List-2016.pdf) in 2016 at hospitals throughout the state, and the average costs associated with each. Current Procedural Terminology (CPT) codes provide a uniform language for coding medical procedures and services and are published and maintained by the American Medical Association (AMA). The New Hampshire Hospital Association lists the 82 most common outpatient CPT codes (out of several thousand). To provide a picture of the extent of variation in the prices for these services, I further narrow this list down to 10 of the most expensive services for which I can obtain data on private insurance payments and prices for uninsured individuals from NH HealthCost and Medicare payments from [CMS](https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/PhysicianFeeSched/PFS-Relative-Value-Files-Items/RVU18A.html?DLPage=1&DLEntries=10&DLSort=0&DLSortDir=descending). I present the resulting boxplot distributions in Figure 2.1, which includes payments by the uninsured, private insurers, and Medicare, and Figure 2.2, which only shows the payments made by private insurers. All price data presented reflect 2018 prices.

The Medicare prices were constructed for the relevant procedures/CPT codes using data from the 2018 Physician Fee Schedule (PFS) Relative Value Files and the following formula: 

<br>

2018FacilityPricingAmount = [(WorkRVU x WorkGPCI) + (FacilityPERVU x PEGPCI) + (MPRVU x MPGPCI)] x ConversionFactor 

<br>

```{r, echo=FALSE, out.width="100%"}

# Top CPT codes from NH Hospital Association
top_cpt_codes <- read_xlsx("NHA_top_cpt_codes.xlsx", col_names = TRUE) %>% 
  filter(!is.na(`CPT Code`))

top_10_cpt <- top_cpt_codes %>% 
  gather(-`CPT Code`, -Description, key = hospital, value = avg_price) %>% 
  filter(!is.na(avg_price)) %>% 
  group_by(`CPT Code`, Description) %>% 
  summarize(avg_price_nh = mean(avg_price)) %>% 
  arrange(desc(avg_price_nh)) %>% 
  filter(Description %in% c("ARTHROSCOPY SHOULDER DECOM", "TONSILLECTOMY&ADNOIDECTOMY:UNDER AGE 12", "UPPER GI ENDOSCOPY, BIOPSY", 
                            "DIAGNOSTIC COLONOSCOPY", "CT BRAIN ‐ W/OUT CONTRAST", "PELVIC ULTRASOUND ‐ NON OBGYN ( NON PREGNANCY)", 
                            "VAGINAL ULTRASOUND ‐ NON OBGYN (NON PREGNANCY)", "ED VISIT‐ PROBLEM(S) ARE OF MODERATE SEVERITY", 
                            "SPINE X‐RAY (LUMBAR PA‐LAT)", "ED VISIT‐ PROBLEM(S) ARE OF LOW TO MODERATE SEVERITY")) %>% 
  rename(cpt_code = `CPT Code`, description = Description)

top_10_cpt$cpt_code <- as.character(top_10_cpt$cpt_code)

primary_data %>% 
  semi_join(top_10_cpt, by = "cpt_code") %>% 
  ggplot(aes(y = estimate_of_total_cost, fill = procedure)) + 
  geom_boxplot(show.legend = FALSE) +
  coord_flip() +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  theme(axis.title.y = element_blank(),
	        axis.text.y = element_blank(),
	        axis.ticks.y = element_blank()) +
  facet_wrap(~procedure, nrow = 5, ncol = 2, scales = "free") +
  labs(title = "Figure 2.1: Price Variation for 10 Common Outpatient Procedures (NH)", 
       subtitle = "Uninsured, Private Insurers, and Medicare")
```

<br>

```{r, echo=FALSE, out.width="100%"}

primary_data %>% 
  semi_join(top_10_cpt, by = "cpt_code") %>% 
  filter(!insurer %in% c("Uninsured", "Other", "Medicare")) %>% 
  ggplot(aes(y = estimate_of_total_cost, fill = procedure)) + 
  geom_boxplot(show.legend = FALSE) +
  coord_flip() +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  theme(axis.title.y = element_blank(),
	        axis.text.y = element_blank(),
	        axis.ticks.y = element_blank()) +
  facet_wrap(~procedure, nrow = 5, ncol = 2, scales = "free") +
  labs(title = "Figure 2.2: Price Variation for 10 Common Outpatient Procedures (NH)", 
       subtitle = "For the Top Three Private Insurers (Anthem, CIGNA, & Harvard Pilgrim)")
```

<br>

I also use [2015 outpatient charge data](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Medicare-Provider-Charge-Data/Outpatient2015.html) from the Center for Medicaid and Medicare Services (CMS) to determine what kind of outpatient procedures tend to generate the greatest expenditures (as a result of both quality and price) as shown in Figure 2. In doing so, I assume that these outpatient patient procedures are at least somewhat representative of those required among non-Medicare patients.
```{r, echo=FALSE, out.width="100%"}

nh_medicare_2015_outpatient <- read_xlsx("Medicare_Charge_Outpatient_APC28_CY2015_Provider.xlsx", skip = 6, col_names = TRUE) %>% 
 filter(`Provider\r\nState` == "NH")

primary_data <- nh_medicare_2015_outpatient %>% 
  count(`Provider ID`, `Provider Name`) %>% 
  arrange(desc(n)) %>% 
  mutate(provider_id = `Provider ID`, provider_name = `Provider Name`) %>% 
  select(provider_id, provider_name) %>% 
  full_join(primary_data, by = "provider_name")

# Narrowing down top 10 outpatient procedures
top_10_APC <- nh_medicare_2015_outpatient %>%
  mutate(hospital_revenue = `Outpatient\r\nServices`*`Average\r\nTotal Payments`) %>% 
  group_by(APC) %>% 
  summarize(Revenue = sum(hospital_revenue)) %>% 
  arrange(desc(Revenue)) %>% 
  slice(1:10)

kable(top_10_APC, col.names = c("Ambulatory Payment Classification (APC)", "Total 2015 Revenue (in $)"), 
      caption = "Figure 3: Top 10 APCs in Terms of Revenue",
      format.args = list(big.mark = ","))
```

<br>
<br>
<br>

For the exact same service, hospitals are able to charge different payers vastly different amounts. Below are some visual examples from the data that illustrate this variation between the three major private payers in New Hampshire (Anthem - NH, CIGNA, and Harvard Pilgrim Health Care) for the exact same service at the exact same hospital. 

<br>

For hospitals which had a price range between insurers >$100 for ankle x-rays:
```{r, echo=FALSE, out.width="100%"}
primary_data %>% 
  filter(procedure == "X-Ray - Ankle (outpatient)", !insurer %in% c("Uninsured", "Other", "Medicare")) %>% 
  count(provider_name, insurer) %>% 
  count(provider_name) %>% 
  filter(nn == 3) %>%
  left_join(primary_data, by = "provider_name") %>% 
  filter(procedure == "X-Ray - Ankle (outpatient)", !insurer %in% c("Uninsured", "Other", "Medicare")) %>%
  group_by(provider_name) %>% 
  mutate(range = max(estimate_of_total_cost) - min(estimate_of_total_cost)) %>% 
  filter(range > 100) %>% 
  ggplot(aes(x = fct_reorder(provider_name, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) +
  geom_col(position = "dodge", width = 0.5) +
  scale_fill_manual(values = c("Uninsured" = "#DCDCDC", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                               "Harvard Pilgrim HC" = "#CC0000", "Other" = "#C0C0C0", "Medicare" = "#808080"), name = "Insurer") +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  labs(title = "Prices Paid by Different Private Insurers", subtitle = "Procedure: X-Ray - Ankle (outpatient)") + 
  theme(axis.title.y = element_blank()) +
  coord_flip()
```

<br>

### Theoretical Framework
Both the hospital and the insurer are often interested in maximizing their profit margins per patient, even if the hospital is a non-profit (Horwitz 2005), and maximizing the number of patients they serve. Hospitals want to receive higher prices for their services but also to be included in insurers' networks, as patients facing lower out-of-pocket costs when going to hospitals in network may be more likely to go to these hospitals. Insurers want to pay lower prices for hospitals’ services to minimize their costs but also want to attract enrollees by including convenient hospitals in their network. Thus, this is the bargaining environment in which bilateral hospital-insurer contracts are negotiated and the work below examines the impact on prices.

<br>

## Data Sources
### Raw data from NH HealthCost
The primary source of data on hospital costs comes from [NH HealthCost](https://nhhealthcost.nh.gov/costs/select) which provides insurer-hospital specific estimations of total costs (reimbursements) for a long list of outpatient services and procedures. I copy and pasted this information for particular medical procedures and services into Excel spreadsheets (one for each medical procedure/service). At first, I attempted to mimic the 8 selected services analyzed in [Cooper et al. (2018)](https://healthcarepricingproject.org/sites/default/files/20180507_variationmanuscript_0.pdf) (Inpatient, Hip Replacement, Knee Replacement, Cesarean Section, Vaginal Delivery, PTCA, Colonoscopy, and Lower Limb MRI), but the website only had data for colonoscopies and MRIs. I therefore chose to first look at radiology services only as these types of services (CT scans, MRIs, X-rays) should be reasonably assumed to have constant costs and quality within the same hospital. This allowed me to construct a data set containing the estimated price for each procedure and each provider-insurer combination for which data was available. 

The following boxplot depicts the various distributions of estimated prices for each private insurer.
```{r, echo=FALSE}
primary_data %>% 
  ggplot(aes(x = fct_reorder(insurer, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) + 
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("Uninsured" = "#DCDCDC", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                               "Harvard Pilgrim HC" = "#CC0000", "Other" = "#C0C0C0", "Medicare" = "#808080")) +
  coord_flip() +
  scale_y_continuous(name = "Estimate of Total Cost", labels = dollar) +
  scale_x_discrete(name = "Insurer") +
  labs(title = "Distribution of Cost Estimates Across Major Private Payers", subtitle = "(27 procedures)")
```

### Insurance Coverage in New Hampshire
The pie charts below are taken from the [NH Insurance Department 2017 Final Report of Health Care Premium and Claim Cost Drivers](https://www.nh.gov/insurance/reports/documents/2018-nhid-annual-hearing-final-report.pdf) (published November 2018) and illustrate relevant information about the insurance market in New Hampshire.

```{r, echo=FALSE, out.width="100%"}
knitr::include_graphics("Images/statewide_coverage_type.png")
knitr::include_graphics("Images/employee_coverage_by_insurer.png")
```


### Location of New Hampshire Hospitals (from Google Maps data):

```{r, echo=FALSE, out.width="100%", message=FALSE, warning=FALSE}

library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)

states <- map_data("state")

north_east <- subset(states, region %in% c("vermont", "new hampshire", "maine", "massachusetts", "connecticut", "rhode island"))

hospital_info <- read_csv("hospital_info.csv") %>% 
  mutate(long = -long) %>% 
  filter(!is.na(lat))

primary_data <- primary_data %>% 
  left_join(hospital_info, by = "provider_name") 

static_map <- ggplot(data = north_east) + 
  geom_polygon(aes(x = long, y = lat, group = group), fill = "palegreen", color = "black") + 
  coord_fixed(1.3) +
  geom_point(data = primary_data, mapping = aes(x = long, y = lat))

# attempt at plotly map
library(plotly)

Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoidHJva29zIiwiYSI6ImNqcmg0aXY2MjJyYXo0M252NDd2aTNjOTEifQ.KUgzpvmF9LaUKBa7SkoFqw')

plotly_nh_hospitals <- hospital_info %>%
  plot_mapbox(lat = ~lat, lon = ~long, text = ~provider_name,
              mode = 'scattermapbox', hoverinfo = 'text') %>%
  layout(title = 'New Hampshire Hospitals',
         mapbox = list(style = 'light',
                       zoom = 6,
                       center = list(lat = 44, 
                                     lon = -72)),
         legend = list(orientation = 'h',
                       font = list(size = 8)),
         margin = list(l = 0, r = 0,
                  b = 0, t = 0,
                  pad = 0))
plotly_nh_hospitals

```

<br>

### CMS Data on Provider ID and Medicare Reimbursement:
```{r, echo=FALSE}

```

<br>

# Statistical Analysis
## Methodology
The goal of this analysis is to determine whether there is a statistical difference between the prices hospitals charge Anthem, Harvard Pilgrim, and CIGNA in New Hampshire. That is, for the same service at the same hospital, is one insurer consistently paying a higher amount than the other two?

I create dummy variables for each of the insurers and Medicare and a new variable ("percent_medicare") which is the price as a percentage of what Medicare pays for the same procedure at the same hospital. The price Medicare pays for Blood Tests is $0 so I drop those observations from my data (from 6,329 to 6,002). With the remaining data, I regress the "percent_medicare" variable on each insurer dummy variable (with the Medicare dummy being excluded) and include procedure fixed effects and hospital fixed effects to isolate within-hospital variation of prices and therefore plausibly control for quality and costs.

The results are listed below and show that Anthem pays on average 162% of Medicare prices, Harvard Pilgrim pays 282%, and CIGNA pays 396%.

```{r, echo=FALSE, message=FALSE}

library(foreign)

primary_data <- primary_data %>% 
  mutate(percent_medicare = (estimate_of_total_cost/medicare_price)*100,
         Anthem_NH = case_when(insurer == "Anthem NH" ~ 1,
                               insurer != "Anthem NH" ~ 0),
         Harvard_Pilgrim_HC = case_when(insurer == "Harvard Pilgrim HC" ~ 1,
                               insurer != "Harvard Pilgrim HC" ~ 0),
         CIGNA = case_when(insurer == "CIGNA" ~ 1,
                               insurer != "CIGNA" ~ 0),
         Medicare = case_when(insurer == "Medicare" ~ 1,
                               insurer != "Medicare" ~ 0))

lm_primary_data <-  
  lm(data = subset(primary_data, !medicare_price == 0, !insurer %in% c("Uninsured", "Other")),
     formula = percent_medicare ~ Anthem_NH + CIGNA + Harvard_Pilgrim_HC + factor(provider_name) + factor(procedure))

library(stargazer)

stargazer(lm_primary_data, type = "text")
```



