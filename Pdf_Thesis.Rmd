---
output:
  pdf_document:
  number_sections: yes
documentclass: article
geometry: "left=1.5in, right=1in, top=1in, bottom=1in"
fontsize: 12pt
---


```{r child = 'title_page.Rmd'}
```

\newpage
\pagenumbering{arabic}

```{r, include=FALSE}
library(knitr)
library(tidyverse)
library(fs)
library(readxl)
library(janitor)
library(scales)
library(ggthemes)
library(stringi)
library(stargazer)
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
library(plotly)
library(foreign)
library(purrr)
library(ggrepel)
```

```{r, include=FALSE}

merge_sheets <- function(x) {
 bind_rows(
   x %>%
      excel_sheets() %>%
      set_names() %>% 
      purrr::map(read_excel, path = x), .id = "Insurer") %>% 
    mutate(procedure = x)
}

primary_data <- data.frame(Insurer = character(), procedure = character())

file_names <- dir_ls("NH_HealthCost_data/")


for (n in file_names) {
  primary_data <- primary_data %>% 
    bind_rows(merge_sheets(n))
}

primary_data <- primary_data %>% 
  mutate(procedure = str_remove_all(procedure, "NH_HealthCost_data/"),
         procedure = str_remove_all(procedure, ".xlsx")) %>% 
  separate(procedure, into = c("CPT_code", "procedure"), sep = " ", extra = "merge")

primary_data <- clean_names(primary_data, case = "snake")

primary_data <- primary_data %>% 
  rename(provider_name = provider_name_compare_selected) %>% 
  mutate(estimate_of_total_cost = case_when(is.na(estimate_of_total_cost) ~ estimate_of_procedure_cost,
                                            !is.na(estimate_of_total_cost) ~ estimate_of_total_cost),
         insurer = str_replace_all(insurer, "None", "Uninsured"),
         provider_name = str_remove(provider_name, "Compare ")) %>% 
  separate(provider_name, sep = " ", into = c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven")) %>%
  select(-estimate_of_procedure_cost, -six, -eight, -ten) %>% 
  mutate(two = case_when(!is.na(four) ~ two),
         three = case_when(!(!is.na(two) & is.na(seven)) ~ three),
         four = case_when(!is.na(three) ~ four),
         four = case_when(!(!is.na(three) & is.na(nine)) ~ four),
         five = case_when(!(!is.na(three) & is.na(four)) ~ five),
         five = case_when(!(!is.na(four) & is.na(eleven)) ~ five),
         seven = case_when(!(!is.na(four) & is.na(five)) ~ seven),
         seven = case_when(!(!is.na(five) & !is.na(eleven)) ~ seven),
         nine = case_when(!(is.na(seven) & !is.na(eleven)) ~ nine)) %>% 
  unite("provider_name", c("one", "two", "three", "four", "five", "seven", "nine", "eleven"), sep = " ") %>% 
  mutate(provider_name = str_remove_all(provider_name, " NA"),
         locality = case_when(provider_name %in% c("Northeastern Vermont Regional Hospital", "Springfield Medical Care System") ~ "VERMONT",
                              provider_name %in% c("Orthopaedic Surgical Associates", "Northeast Endoscopy Center", "Lowell General Hospital",
                                                   "Lahey Health", "Orthopaedic Northeast", "Steward Medical Group", "Lawrence General Hospital", 
                                                   "Merrimack Valley Endoscopy Center", "Anna Jaques Hospital") ~ "METROPOLITAN BOSTON, MA",
                              provider_name %in% c("Bridgton Hospital", "York Hospital") ~ "SOUTHERN MAINE",
                              TRUE ~ "NEW HAMPSHIRE"),
         provider_name = str_replace_all(provider_name, "Lakes Region General Healthcare", "Lakes Region General Hospital"),
         provider_name = str_replace_all(provider_name, "LRGHealthcareLRGHealthcare", "LRGHealthcare"),
         provider_name = str_replace_all(provider_name, "Dartmouth-Hitchcock Clinic", "Dartmouth-Hitchcock (Manchester)"))


# Constructing Medicare prices and adding to primary data set
primary_data <- read_xlsx("RVU18A_files/PPRRVU18_JAN_mod.xlsx", skip = 9, col_names = TRUE) %>% 
  rename(cpt_code = HCPCS) %>% 
  filter(cpt_code %in% c(primary_data$cpt_code, 
                         "29806", "29807", "29819", "29820", "29821", "29822", "29823", "29824", "29825",
                         "29873", "29874", "29875", "29876", "29877", "29879", "29880", "29881",
                         "45384",
                         "71045", "71046", "71047", "71048",
                         "72050",
                         "72072", "72074",
                         "74018", "74019", "74021"), is.na(MOD)) %>% 
  select(cpt_code, DESCRIPTION, WorkRVU = RVU, FacilityPERVU = `PE RVU__1`, MPRVU = RVU__1, ConversionFactor = FACTOR) %>% 
  mutate(cpt_code = case_when(DESCRIPTION == "Shoulder arthroscopy/surgery" ~ "29826",
                              DESCRIPTION == "Knee arthroscopy/surgery" ~ "29881",
                              DESCRIPTION == "Colonoscopy w/lesion removal" ~ "45385",
                              DESCRIPTION %in% c("X-ray exam chest 1 view", "X-ray exam chest 2 views", 
                                                 "X-ray exam chest 3 views", "X-ray exam chest 4+ views") ~ "71020",
                              DESCRIPTION %in% c("X-ray exam neck spine 2-3 vw", "X-ray exam neck spine 4/5vws") ~ "72040",
                              DESCRIPTION %in% c("X-ray exam abdomen 1 view", "X-ray exam abdomen 2 views", "X-ray exam abdomen 3+ views") ~ "74000",
                              DESCRIPTION %in% c("X-ray exam thorac spine 2vws", "X-ray exam thorac spine 3vws", "X-ray exam thorac spine4/>vw") ~ "72070",
                              TRUE ~ cpt_code),
         DESCRIPTION = case_when(cpt_code == "71020" ~ "X-ray exam chest",
                                 cpt_code == "72040" ~ "X-ray exam neck spine",
                                 cpt_code == "74000" ~ "X-ray exam abdomen",
                                 cpt_code == "72070" ~ "X-ray exam thorac spine",
                                 TRUE ~ DESCRIPTION)) %>% 
  group_by(cpt_code, DESCRIPTION) %>% 
  summarize(WorkRVU = mean(WorkRVU), FacilityPERVU = mean(FacilityPERVU), MPRVU = mean(MPRVU), ConversionFactor = mean(ConversionFactor)) %>% 
  ungroup() %>% 
  right_join(primary_data,  by = "cpt_code")

primary_data <- read_xlsx("RVU18A_files/GPCI2018_copy.xlsx", skip = 2, col_names = TRUE) %>% 
  rename(locality = X__3) %>% 
  filter(locality %in% c("NEW HAMPSHIRE", "SOUTHERN MAINE", "METROPOLITAN BOSTON, MA", "REST OF MASSACHUSETTS", "VERMONT")) %>% 
  select(locality, WorkGPCI = `PW GPCI`, PEGPCI = `PE GPCI`, MPGPCI = `MP GPCI`) %>% 
  right_join(primary_data, by = "locality") %>% 
  mutate(Medicare = ((WorkRVU * WorkGPCI) + (FacilityPERVU * PEGPCI) + (MPRVU * MPGPCI)) * ConversionFactor, medicare_price = Medicare) %>% 
  select(cpt_code, procedure, provider_name, locality, insurer, estimate_of_total_cost, Medicare, medicare_price, precision_of_the_cost_estimate, 
         typical_patient_complexity, uninsured_discount)

primary_data <- primary_data %>% 
  count(cpt_code, procedure, provider_name, locality, Medicare) %>% 
  select(-n) %>% 
  gather(Medicare, key = insurer, value = estimate_of_total_cost) %>% 
  bind_rows(primary_data) %>% 
  mutate(medicare_price = case_when(insurer == "Medicare" ~ estimate_of_total_cost,
                                    TRUE ~ medicare_price),
         percent_medicare = (estimate_of_total_cost/medicare_price)*100,
         Anthem_NH = case_when(insurer == "Anthem NH" ~ 1,
                               insurer != "Anthem NH" ~ 0),
         Harvard_Pilgrim_HC = case_when(insurer == "Harvard Pilgrim HC" ~ 1,
                               insurer != "Harvard Pilgrim HC" ~ 0),
         CIGNA = case_when(insurer == "CIGNA" ~ 1,
                               insurer != "CIGNA" ~ 0),
         Medicare = case_when(insurer == "Medicare" ~ 1,
                               insurer != "Medicare" ~ 0)) %>% 
  filter(!cpt_code %in% c("29881", "45380", "45385", "85027")) # only looking at radiology services or top 10 procedures

# Adding in Hospital Compare data for quality measures
primary_data <- read_csv("Hospital_Compare_data/Hospital_General_Information_copy.csv") %>% 
  filter(State %in% c("VT", "NH", "ME", "MA")) %>% 
  mutate(provider_name = str_to_title(`Hospital Name`)) %>% 
  filter(`Provider ID` != "200001") %>% 
  mutate(provider_name = str_replace_all(provider_name, "Exeter Hospital Inc","Exeter Hospital"), 
         provider_name = str_replace_all(provider_name, "Memorial Hospital, The","Memorial Hospital"), 
         provider_name = str_replace_all(provider_name, "Southern Nh Medical Center", "Southern NH Medical Center"),
         provider_name = str_replace_all(provider_name, "St Joseph Hospital", "St. Joseph Hospital")) %>% 
  right_join(primary_data, by = "provider_name") %>% 
  mutate(`Hospital Type` = case_when(is.na(`Hospital Type`) ~ "Non-Hospital Providers",
                                     TRUE ~ `Hospital Type`),
         `Hospital overall rating` = case_when(provider_name == "Alice Peck Day Memorial Hospital" ~ "3",
                                              TRUE ~ `Hospital overall rating`),
         `Hospital overall rating footnote` = case_when(provider_name == "Alice Peck Day Memorial Hospital" ~ "2017 rating",
                                                        TRUE ~ `Hospital overall rating footnote`)) %>% 
  select(-`Hospital Name`, -Address, -`Phone Number`, -11, -12, -15:-28)

# Hospital and ambulatory center latitude and longitude
primary_data <- read_csv("provider_coordinates.csv") %>% 
  right_join(primary_data, by = "provider_name")

# The number of other hospitals in each hospital's market
# First adding info on each hospital's hsa and hrr from 2016 dartmouth atlas zipcode to HSA/HRR crosswalk
primary_data <- read_csv("ZipHsaHrr16.csv") %>% 
  filter(hsastate %in% c("NH", "MA", "ME", "VT")) %>% 
  rename(`ZIP Code` = zipcode16) %>%
  right_join(primary_data, by = "ZIP Code")

# Counting number of hospitals within HSA/HRR that also offer that procedure
primary_data <- primary_data %>% 
  filter(!is.na(`ZIP Code`)) %>% 
  count(provider_name, procedure, hsanum, hrrnum) %>% 
  group_by(procedure, hsanum) %>% 
  mutate(n_hosp_hsa_procedure = n()) %>% 
  ungroup() %>% 
  group_by(procedure, hrrnum) %>% 
  mutate(n_hosp_hrr_procedure = n()) %>% 
  ungroup() %>% 
  select(-n, -hsanum, -hrrnum) %>% 
  right_join(primary_data, by = c("provider_name", "procedure"))

# Counting number of total hospitals in HSA/HRR
primary_data <- primary_data %>% 
  filter(!is.na(`ZIP Code`)) %>% 
  count(provider_name, hsanum, hrrnum) %>% 
  group_by(hsanum) %>% 
  mutate(n_hosp_hsa_total = n()) %>% 
  ungroup() %>% 
  group_by(hrrnum) %>% 
  mutate(n_hosp_hrr_total = n()) %>% 
  ungroup() %>% 
  select(-n, -hsanum, -hrrnum) %>% 
  right_join(primary_data, by = "provider_name")

# Next, I want to calculate the distance of every hospital to every other hospital and define the markets as certain radius
# Counting number of hospitals that also offer that procedure
radial_markets_procedure <- data.frame(provider1 = character(), procedure = character(), provider2  = character(), 
                                      distance = double(), 
                                      hospital_type1 = character(), hospital_type2 = character(), 
                                      hospital_rating1 = character(), hospital_rating2 = character())

provider_coordinates <- primary_data %>% 
  count(provider_name, lat, long, `Hospital Type`, `Hospital overall rating`) %>% 
  select(-n) %>% 
  mutate(lat = (lat*pi)/180, long = (long*pi)/180)

for (i in provider_coordinates$provider_name) {

provider_procedure <- primary_data %>% 
  count(provider_name, procedure) %>% 
  select(-n) %>% 
  filter(provider_name == i)

provider <- provider_coordinates %>% 
  filter(provider_name == i)

provider1 <- provider$provider_name
lat1 <- provider$lat
long1 <- provider$long
hospital_type1 <- provider$`Hospital Type`
hospital_rating1 <- provider$`Hospital overall rating`

radial_markets_procedure <- primary_data %>% 
  count(provider_name, procedure, lat, long, `Hospital Type`, `Hospital overall rating`) %>% 
  select(-n) %>% 
  mutate(lat = (lat*pi)/180, long = (long*pi)/180) %>% 
  filter(procedure %in% provider_procedure$procedure) %>% 
  rename(provider2 = provider_name, lat2 = lat, long2 = long, hospital_type2 = `Hospital Type`, 
         hospital_rating2 = `Hospital overall rating`) %>% 
  mutate(provider1 = provider1,
         lat1 = lat1, long1 = long1, 
         hospital_type1 = hospital_type1,
         hospital_rating1 = hospital_rating1,
         dLat = (lat2 - lat1), dLong = (long2 - long1), 
         a = (sin(dLat/2)^2) + (cos(lat1) * cos(lat2) * sin(dLong/2)^2),
         c = 2 * atan2(sqrt(a), sqrt(1 - a)), 
         distance = 3959*c) %>% 
  filter(distance <= 25) %>% 
  select(provider1, procedure, provider2, distance, hospital_type1, hospital_type2, hospital_rating1, hospital_rating2) %>% 
  bind_rows(radial_markets_procedure)

}
  
primary_data <- radial_markets_procedure %>% 
  filter(!is.na(hospital_rating2)) %>% 
  group_by(provider1, procedure) %>% 
  summarize(n_hosp_25mi_procedure = n()) %>% 
  ungroup() %>% 
  rename(provider_name = provider1) %>% 
  right_join(primary_data, by = c("provider_name", "procedure"))

primary_data <- radial_markets_procedure %>% 
  filter(!is.na(hospital_rating2), distance <= 10) %>% 
  group_by(provider1, procedure) %>% 
  summarize(n_hosp_10mi_procedure = n()) %>% 
  ungroup() %>% 
  rename(provider_name = provider1) %>% 
  right_join(primary_data, by = c("provider_name", "procedure"))

primary_data <- radial_markets_procedure %>% 
  filter(!is.na(hospital_rating2), distance <= 5) %>% 
  group_by(provider1, procedure) %>% 
  summarize(n_hosp_5mi_procedure = n()) %>% 
  ungroup() %>% 
  rename(provider_name = provider1) %>% 
  right_join(primary_data, by = c("provider_name", "procedure"))

# Counting total number of hospitals
radial_markets <- data.frame(provider1 = character(), provider2  = character(), 
                                      distance = double(), 
                                      hospital_type1 = character(), hospital_type2 = character(), 
                                      hospital_rating1 = character(), hospital_rating2 = character())

provider_coordinates <- primary_data %>% 
  count(provider_name, lat, long, `Hospital Type`, `Hospital overall rating`) %>% 
  select(-n) %>% 
  mutate(lat = (lat*pi)/180, long = (long*pi)/180)

for (i in provider_coordinates$provider_name) {

provider <- provider_coordinates %>% 
  filter(provider_name == i)

provider1 <- provider$provider_name
lat1 <- provider$lat
long1 <- provider$long
hospital_type1 <- provider$`Hospital Type`
hospital_rating1 <- provider$`Hospital overall rating`

radial_markets <- provider_coordinates %>% 
  rename(provider2 = provider_name, lat2 = lat, long2 = long, hospital_type2 = `Hospital Type`, 
         hospital_rating2 = `Hospital overall rating`) %>% 
  mutate(provider1 = provider1,
         lat1 = lat1, long1 = long1, 
         hospital_type1 = hospital_type1,
         hospital_rating1 = hospital_rating1,
         dLat = (lat2 - lat1), dLong = (long2 - long1), 
         a = (sin(dLat/2)^2) + (cos(lat1) * cos(lat2) * sin(dLong/2)^2),
         c = 2 * atan2(sqrt(a), sqrt(1 - a)), 
         distance = 3959*c) %>% 
  filter(distance <= 25) %>% 
  select(provider1, provider2, distance, hospital_type1, hospital_type2, hospital_rating1, hospital_rating2) %>% 
  bind_rows(radial_markets)

}
  
primary_data <- radial_markets %>% 
  filter(!is.na(hospital_rating2)) %>% 
  group_by(provider1) %>% 
  summarize(n_hosp_25mi_total = n()) %>% 
  ungroup() %>% 
  rename(provider_name = provider1) %>% 
  right_join(primary_data, by = "provider_name")

primary_data <- radial_markets %>% 
  filter(!is.na(hospital_rating2), distance <= 10) %>% 
  group_by(provider1) %>% 
  summarize(n_hosp_10mi_total = n()) %>% 
  ungroup() %>% 
  rename(provider_name = provider1) %>% 
  right_join(primary_data, by = "provider_name")

primary_data <- radial_markets %>% 
  filter(!is.na(hospital_rating2), distance <= 5) %>% 
  group_by(provider1) %>% 
  summarize(n_hosp_5mi_total = n()) %>% 
  ungroup() %>% 
  rename(provider_name = provider1) %>% 
  right_join(primary_data, by = "provider_name")


# Top CPT codes from NH Hospital Association
top_10_cpt_codes <- read_xlsx("NHA_top_cpt_codes.xlsx", col_names = TRUE) %>% 
  filter(!is.na(`CPT Code`)) %>% 
  gather(-`CPT Code`, -Description, key = hospital, value = avg_price) %>% 
  filter(!is.na(avg_price)) %>% 
  group_by(`CPT Code`, Description) %>% 
  summarize(avg_price_nh = mean(avg_price)) %>% 
  arrange(desc(avg_price_nh)) %>% 
  filter(Description %in% c("ARTHROSCOPY SHOULDER DECOM", "TONSILLECTOMY&ADNOIDECTOMY:UNDER AGE 12", "UPPER GI ENDOSCOPY, BIOPSY", 
                            "DIAGNOSTIC COLONOSCOPY", "CT BRAIN ‐ W/OUT CONTRAST", "PELVIC ULTRASOUND ‐ NON OBGYN ( NON PREGNANCY)", 
                            "VAGINAL ULTRASOUND ‐ NON OBGYN (NON PREGNANCY)", "ED VISIT‐ PROBLEM(S) ARE OF MODERATE SEVERITY", 
                            "SPINE X‐RAY (LUMBAR PA‐LAT)", "ED VISIT‐ PROBLEM(S) ARE OF LOW TO MODERATE SEVERITY")) %>% 
  rename(cpt_code = `CPT Code`, description = Description) %>% 
  ungroup() %>% 
  mutate(cpt_code = as.character(cpt_code))


# Adding in Census Data
primary_data <- primary_data %>% 
  count(`County Name`, State) %>% 
  arrange(State) %>% 
  select(`County Name`) %>% 
  mutate(median_household_income = c(73533, 92878, 65702, 62618, 65834, 58139, 60148, 45386, 61036, 75777, 69856, 85619, 67805, 59419, 47371, NA),
         percent_pop_over65 = c(0.166, 0.15, 0.178, 0.197, 0.215, 0.271, 0.193, 0.232, 0.201, 0.153, 0.178, 0.173, 0.146, 0.21, 0.201, NA),
         pop_density = c(1508.8, 1837.9, 337.2, 199, 150.1, 51.4, 109.1, 18.4, 52.2, 457.4, 156.8, 425, 333.7, 81.4, 48.1, NA),
         percent_pop_over65 = 100*percent_pop_over65) %>% 
  right_join(primary_data, by = "County Name")

```

```{r, include=FALSE}
primary_regression_data <- primary_data %>% 
  filter(!insurer %in% c("Uninsured", "Other"), !is.na(`ZIP Code`), !cpt_code %in% c("29826", "42820", "43239", "45378", "99282", "99283")) %>% 
  mutate(`Hospital Quality` = as.numeric(`Hospital overall rating`))

primary_regression_data <- data.frame(typical_patient_complexity = c(" LOW", " MEDIUM", " HIGH", NA), typical_patient_complexity_num = c(1, 2, 3, NA)) %>% 
  mutate(typical_patient_complexity = as.character(typical_patient_complexity)) %>% 
  right_join(primary_regression_data, by = "typical_patient_complexity")

lm_insurers <- lm(data = primary_regression_data,
           formula = percent_medicare ~ Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(provider_name) + factor(procedure))

summary(lm_insurers)
anova(lm_insurers)

lm_hospitals1 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_hsa_total + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals1)

lm_hospitals2 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_hrr_total + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals2)

lm_hospitals3 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_hsa_procedure + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals3)

lm_hospitals4 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_hrr_procedure + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals4)

lm_hospitals5 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_5mi_total + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals5)

lm_hospitals6 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_10mi_total + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals6)

lm_hospitals7 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_25mi_total  + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals7)

lm_hospitals8 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_5mi_procedure + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals8)

lm_hospitals9 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_10mi_procedure + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals9)

lm_hospitals10 <- lm(data = primary_regression_data,
                   formula = percent_medicare ~ n_hosp_25mi_procedure  + typical_patient_complexity_num + `Hospital Quality` + 
                     median_household_income + percent_pop_over65 + pop_density +
                     Anthem_NH + Harvard_Pilgrim_HC + CIGNA + factor(procedure))

summary(lm_hospitals10)

glimpse(primary_regression_data)
```

### Abstract
This thesis evaluates how the market power of insurers and hospitals in geographical sub-markets relates to the prices insurers and hospitals negotiate for hospital care. I examine to what extent the variation in prices is explained by variation in costs and quality versus variation in market power, which may play an important role in bilateral price negotiations for services. Using carrier-hospital specific prices for outpatient medical procedures from New Hampshire's [NH HealthCost website](https://nhhealthcost.nh.gov/costs/select), I compare the estimated prices for the same services across the state, both between hospitals and within hospitals. I find that there is no statistically significant relationship between measures of quality and price, but there are statistically significant differences in the prices paid by each major private insurer as well as statistically significant differences between hospitals in a monopoly versus duopoly.

\newpage

## Introduction
The U.S.'s expenditure on health care has grown rapidly over the last few decades and has outpaced that of many peer countries without significant returns to quality (e.g. OECD 2017; Etehad and Kim 2017; Reinhardt et al., 2004).  A substantial body of research has determined that the biggest driver behind the U.S. health care expenditure is not greater utilization or social spending but quite simply higher prices (e.g. Anderson et al., 2003; Papanicolas et al., 2018). Given that the $3.3 trillion spent on health care annually (17.9% of GDP) (Centers for Disease Control and Prevention 2017) erodes the budgets of families and individuals, as well as those of local, state, and federal government, understanding the sources of variation in these prices is of tremendous import. 

This paper focuses on hospital prices because hospital care constitutes the largest share and one of the fastest growing components of U.S. health care spending at 32.4% ($1.0825 trillion) of national health expenditure (Centers for Disease Control and Prevention 2017) as shown in Figure 1. A vast body of research has identified wide variation in private insurance reimbursements to hospitals for the same services and/or diagnoses ***citations***. Cooper et al., 2015 finds that for the privately insured, only about half of the variation in expenditure is due to the quantity of care delivered while half is purely driven by price variation; as a comparison, 95% of the variation in expenditure for public programs like Medicare is explained by variation in the quantity of care delivered.
```{r, echo=FALSE, fig.align="center"}

# Creating a graphic to show the growth in U.S. health care spending over time and specifically the growth in hospital care spending

# 1) putting together the data frame that will have U.S. health expenditure by year manually, using data from the CDC

year <- c(1960, 1970, 1975, 1980, 1990, 2000, 2009, 2015, 2016)
national_health_expenditure <- c(27.2, 74.6, 133.3, 255.3, 721.4, 1369.1, 2495.4, 3200.8, 3337.2) # in billions of dollars
hospital_care_expenditure <- c(9.0, 27.2, 51.2, 100.5, 250.4, 415.5, 779.6, 1033.4, 1082.5) # in billions of dollars
phys_clinical_sevices_exp <- c(5.6, 14.3, 25.3, 47.7, 158.4, 288.2, 497.7, 631, 664.9) # in billions of dollars
prescrip_drugs_exp <- c(2.7, 5.5, 8.1, 12, 40.3, 121, 252.7, 324.5, 328.6)
real_gdp <- c(3260, 4951, 5645, 6759, 9366, 13131, 15209, 17387, 17659) # in billions of dollars, adj for inflation using 2012 dollars; https://www.thebalance.com/us-gdp-by-year-3305543

health_expenditures <- data.frame(year, national_health_expenditure, hospital_care_expenditure, real_gdp)


# 2) converting expenditures to percents of gdp
health_expenditures <- health_expenditures %>% 
  mutate(percent_nhe = national_health_expenditure/real_gdp,
         percent_hce = hospital_care_expenditure/real_gdp,
         percent_pcse = phys_clinical_sevices_exp/real_gdp,
         percent_pde = prescrip_drugs_exp/real_gdp) %>% 
  select(year, percent_nhe, percent_hce, percent_pcse, percent_pde) %>% 
  gather(-year, percent_pde, key = component_of_exp, value = percent_of_gdp)


# 2) putting together a line plot that will show this growth over time

ggplot(data = health_expenditures) +
  geom_line(mapping = aes(x = year, y = percent_of_gdp, color = fct_reorder(component_of_exp, -percent_of_gdp))) +
  labs(title = "Figure 1: Health Care Spending in the U.S. over time", caption = "Source: Centers for Disease Control and Prevention 2017") +
  scale_y_continuous(name = "Spending (percentage of GDP)", labels = percent) +
  scale_x_continuous(name = "Year", breaks = c(1960, 1970, 1980, 1990, 2000, 2010)) +
  scale_color_manual(name = "Component of Spending", values = c("percent_nhe" = "black", 
                                                                "percent_hce" = "red", 
                                                                "percent_pcse" = "gray", 
                                                                "percent_pde" = "light gray"),
                    labels = c("Total National Health Expenditure", "Hospital Care", "Physician and Clinical Services", "Prescription Drugs")) +
  theme_tufte()
```
 
Given that the largest portion of Americans (49%) receive health care coverage from their employer through private insurance plans rather than through Medicare and Medicaid (Kaiser Family Foundation 2017), this price variation between different private insurers/hospital contracts affects what many Americans pay in premiums and out of pocket for their healthcare. Moreover, prior research such as Cooper et al. 2015 finds that this variation persists even when costs and quality are arguably held constant. 

In this paper, I examine how prices for outpatient services in New Hampshire vary with the market share of the insurer and the market share of the hospital. New Hampshire has been a pioneer of price transparency in health care among the U.S. states and therefore provides the opportunity to more closely evaluate the forces shaping hospital prices. I use data from [NH HealthCost](https://nhhealthcost.nh.gov/costs/select) to construct prices at the insurer-provider-procedure level, information from the [New Hampshire Insurance Department](https://www.nh.gov/insurance/reports/documents/2018-nhid-annual-hearing-final-report.pdf) to obtain state-level health insurance information, and geographical data from a variety of sources to construct various measures of hospital market shares. I find statistically significant differences between the prices difference insurers face across the state.

This paper is most closely related to Cooper et al. 2015, but differs in several key respects: first, this analysis will focus a set of price data for hospital care in New Hampshire, while Cooper et al. 2015 relies on HCCI data which is a national cross-section sample and relies on claims data from Aetna, Humana, and United Health. While the HCCI data is a rich set of data that is perhaps nationally representative in a broad sense, none of these insurers are major players in the New Hampshire market; secondly, this paper will devote more attention to insurers' relative market power as well as the effects on the uninsured who have minimal market power; lastly, I also include an analysis of how the share of Medicare patients at a given hospital affects the prices that hospital negotiates with private insurers.

#### Structure
Section II of this paper provides background on the New Hampshire market for health services. Section III supplies explanation of the data sources being used, how they were obtained, and the relevant information contained therein. Section IV lays out the empirical framework used in the the analyses and Section V presents the results. The paper concludes with Section VI.




## Background on the New Hampshire Market
### Health Insurance Coverage
New Hampshire is a small state (8,953 sqaure miles) with a population of 1.343 million (90.5% white) and median household income of $71,305 (Census Bureau 2017). Additionally, 17.6% of the population is over the age of 65, which is slightly higher than the national average of 15.6% (Census Bureau 2017). Figures 2.1 and 2.2 depict the insurance status of New Hampshire residents in 2017 and the market share of major private insurers, respectively. According to the New Hampshire Insurance Department, a total of 543,900 members were enrolled in commercial market plans in 2017 in the state, and 81% received coverage through employer-sponsored insurance plans (11.0% Individual Market, 7.7% NH PAP, 12.6% Small Group, 19.8% Large Group Fully Insured, and 48.9% Large Group Self Insured). 
```{r, echo=FALSE}

# Creating dataframe on insurance status in NH from NH Insurance department, first creating columns
insurance_status <- c("Employer Coverage Only", "Individual Coverage Only", "Medicare Coverage Only", "Medicaid Coverage Only", "Uninsured", 
                      "Other Coverage Combinations", "Dual Medicare/Medicaid Coverage", "Tricare & VA Coverage")
percent_in <- c(56, 6, 14, 10, 6, 6, 1, 1)

# Putting together as dataframe
insurance_status_nh <- data.frame(insurance_status, percent_in)

# Creating dataframe on private insurance in NH
insurer <- c("Anthem/Matthew Thorton", "Harvard Pilgrim", "CIGNA", "Other")
percent_enrolled <- c(39, 27, 20, 14)

# Putting together as dataframe
private_insurance <- data.frame(insurer, percent_enrolled)
```

```{r, echo=FALSE, fig.align='center'}
insurance_status_nh %>% 
  ggplot(aes(x = "", y = percent_in, fill = fct_reorder(insurance_status, percent_in))) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start = 0) +
  scale_fill_brewer(name = "Insurance Status") +
  geom_text(aes(label = paste0(percent_in, "%")), position = position_stack(vjust = 0.5), color = "white", family = "serif", check_overlap = TRUE) +
  labs(title = "Figure 2: New Hampshire Residents by Health Insurance Status in 2017") +
  theme_tufte() +
  theme(axis.title.x  = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title.y  = element_blank(),
        axis.ticks.y = element_blank())
```

```{r, echo=FALSE, fig.align='center'}

private_insurance %>% 
  ggplot(aes(x = "", y = percent_enrolled, fill = fct_reorder(insurer, percent_enrolled))) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start = 0) +
  scale_fill_manual(name = "Private Insurer", values = c("CIGNA" = "#99CC00", "Anthem/Matthew Thorton" = "#336699", 
                               "Harvard Pilgrim" = "#CC0000", "Other" = "#C0C0C0")) +
  geom_text(aes(label = paste0(percent_enrolled, "%")), position = position_stack(vjust = 0.5), color = "white", family = "serif") +
  labs(title = "Figure 3: Distribution by Insurer for NH Commercial Market in 2017") +
  theme_tufte() +
  theme(axis.title.x  = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title.y  = element_blank(),
        axis.ticks.y = element_blank())
```

### New Hampshire Providers
New Hampshire has a total of 31 hospitals and 3,503 beds within the state (New Hampshire Hospital Association 2018). According to the New Hampshire Hospital Association, 13 of these hospitals with 2,704 beds total are Prospective Payment Systems (PPS) Hospitals, which take prospective payments from Medicare; 13 hospitals with 301 beds total are Critical Access Hospitals (CAH), which serve rural populations and therefore are eligible to receive certain benefits from Medicare such as cost-based reimbursement for Medicare services; 5 hospitals with 498 beds total are Specialty Hospitals, which provide a specialized category of services (such as children’s hospitals, orthopedic hospitals, cancer hospitals, etc.) and are omitted from my analysis for lack of price information. While categorized by Medicare reimbursements, all of the hospitals included in my analysis serve privately insured individuals in addition to Medicare patients.

In addition to the 26 New Hampshire hospitals, there are 6 out-of-state hospitals included in my analysis which are located close to New Hampshire's borders: Anna Jaques Hospital, Lawrence General Hospital, and Lowell General Hospital (Massachusetts); Bridgton Hospital and York Hospital (Maine); and Northeastern Vermont Regional Hospital (Vermont). Furthermore, there are 99 non-hospital providers such as ambulatory surgical centers, clinics, and private phsycian groups that also provide some of the relevant outpatient procedures. Though the focus of the analysis will be on hospitals, I include these non-hospital providers in Figure 3 for context.

```{r, echo=FALSE, out.width="100%", message=FALSE, warning=FALSE}

counties <- map_data("county")

north_east <- subset(counties, region == "new hampshire")
                     # region %in% c("vermont", "new hampshire", "maine", "massachusetts"))

hospitals <- primary_data %>% 
  filter(!is.na(`Provider ID`)) %>% 
  count(provider_name, lat, long, `Hospital Type`)

 ggplot() + 
  geom_polygon(data = north_east, aes(x = long, y = lat, group = group), fill = "light gray", color = "white") + 
  coord_fixed(xlim = c(-75, -69),  ylim = c(42, 46), ratio = 1.3) +
  geom_point(data = primary_data, mapping = aes(x = long, y = lat, color = `Hospital Type`)) +
  scale_color_manual(name = "Hospital Type", values = c("Acute Care Hospitals" = "#0072B2", 
                                                        "Critical Access Hospitals" = "#56B4E9", 
                                                        "Non-Hospital Providers" = "#999999")) +
  geom_text_repel(data = subset(hospitals, long < -71.4 & lat > 44), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-74,-72), ylim = c(44.1, 46)) +
   geom_text_repel(data = subset(hospitals, long < -71.5 & lat < 44 & lat > 43), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-74,-72.5), ylim = c(42, 44.1)) +
   geom_text_repel(data = subset(hospitals, long < -72 & lat < 43), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-75,-72.7), ylim = c(42, 42.8)) +
   geom_text_repel(data = subset(hospitals, long < -71.5 & long > -72 & lat < 43), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                  box.padding = unit(0.2, 'lines'), xlim = c(-75,-72.8), ylim = c(42, 42.6)) +
   geom_text_repel(data = subset(hospitals, long > -71.4 & lat > 44), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-71,-69), ylim = c(44, 46)) +
   geom_text_repel(data = subset(hospitals, long > -71.5 & lat < 44 & lat > 43.2), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-70.7,-69), ylim = c(43.2, 44.1)) +
   geom_text_repel(data = subset(hospitals, long > -71 & lat < 43.2), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-70,-69), ylim = c(42, 43.2)) +
   geom_text_repel(data = subset(hospitals, long < -71 & long > -71.7 & lat < 43.1 & lat > 42.9), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-75,-72), ylim = c(42, 42.4)) +
   geom_text_repel(data = subset(hospitals, long < -71.4 & long > -71.7 & lat < 42.9 & lat > 42.74), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-72.5,-71), ylim = c(41, 42.2)) +
   geom_text_repel(data = subset(hospitals, long < -71 & long > -71.4 & lat < 42.9), aes(x = long, y = lat, label = provider_name), size = 1.7, 
                   box.padding = unit(0.2, 'lines'), xlim = c(-71,-69), ylim = c(41, 42.7)) +
  labs(title = "Figure 4: Location of New Hampshire Hospitals") +
  theme_tufte() +
  theme(axis.title.x  = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title.y  = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

```

There has only been one official hospital merger involving a hospital in New Hampshire: Massachusetts General Hospital (MGH)/Partners HealthCare from Massachusetts acquired Wentworth-Douglass on January 1, 2017. However, if two pending quasi-mergers go through, "22 out of New Hampshire's 26 acute-care hospitals will have established some kind of organizational connection with other institutions, often mergers in all but name" ( [Concord Monitor Jan 26, 2019](https://www.concordmonitor.com/hospitals-merge-followup-23005911) ). In May 2018 Partners HealthCare also made a bid to acquire Exeter Health Resources, and this merger is still pending approval.

### Price variation in the New Hampshire Market
Large price variation exists in New Hampshire, and I present boxplot distributions of procedure prices in Figures 4.1 and 4.2 for ten common outpatient procedures in New Hampshire. I indentify these procedures using 2016 data from the [New Hampshire Hospital Association](https://www.nhha.org/images/Data/Outpatient-CPT-List-2016.pdf) and further narrow their list of 82 (out of thousands) down to 10 of the most expensive services for which I have price estimates for private insurers. Figure 4.1 includes payments by the uninsured, private insurers, and Medicare  for these common procedures, and Figure 4.2 only shows the payments made by private insurers. All price data presented reflect 2018 prices. Significant variation exists in the prices paid for the same procedure or service, even when only considering the privately insured, and this may be expected if costs and quality vary across hospitals.

```{r, message=FALSE, echo=FALSE, fig.align='center', warning=FALSE, message=FALSE}
primary_data %>% 
  semi_join(top_10_cpt_codes, by = "cpt_code") %>% 
  ggplot(aes(y = estimate_of_total_cost, fill = procedure)) + 
  geom_boxplot(show.legend = FALSE) +
  coord_flip() +
  scale_y_continuous(name = "Price Estimate", labels = dollar) +
  scale_fill_brewer() +
  facet_wrap(~procedure, nrow = 5, ncol = 2, scales = "free") +
  labs(title = "Figure 4.1: Price Variation for 10 Common Outpatient Procedures (NH)", 
       subtitle = "Uninsured, Private Insurers, and Medicare") +
  theme_tufte() +
  theme(axis.title.y = element_blank(),
	        axis.text.y = element_blank(),
	        axis.ticks.y = element_blank())


primary_data %>% 
  semi_join(top_10_cpt_codes, by = "cpt_code") %>% 
  filter(!insurer %in% c("Uninsured", "Other", "Medicare")) %>% 
  ggplot(aes(y = estimate_of_total_cost, fill = procedure)) + 
  geom_boxplot(show.legend = FALSE) +
  coord_flip() +
  scale_y_continuous(name = "Price Estimate", labels = dollar) +
  scale_fill_brewer() +
  facet_wrap(~procedure, nrow = 5, ncol = 2, scales = "free") +
  labs(title = "Figure 4.2: Price Variation for 10 Common Outpatient Procedures (NH)", 
       subtitle = "For the Top Three Private Insurers (Anthem, CIGNA, & Harvard Pilgrim)") +
  theme_tufte() +
  theme(axis.title.y = element_blank(),
	        axis.text.y = element_blank(),
	        axis.ticks.y = element_blank())
```

This variation persists even when costs and quality are reasonably assumed fixed within the same hospital. Controlling for procedure, across hospital price variation accounts for 16.4% of the total variation but *within* hospital price variation accounts for a further 17.0% of the total. For the same service at the same hospital, different payers are charged vastly different amounts. Figures 5.1 and 5.2 show the different prices paid by the three major private payers in New Hampshire (Anthem NH, CIGNA, and Harvard Pilgrim Health Care) at the same hospital for a transvaginal ultrasound and a spine x-ray (two very common radiology services), respectively. All hospitals in Figure 5.1 have a difference of at least \$150 in the price paid by the highest private payer and that paid by the lowest private payer. In three of these hospitals (St. Joseph Hospital, Anna Jaques Hospital, and Foundation Medical Partners), the highest payer is paying more than twice the amount the lowest payer is paying. For all of the hospitals in Figure 5.2, there is a difference of at least \$100 between the highest and lowest payers.

```{r, echo=FALSE, fig.align='center'}
primary_data %>% 
  filter(procedure == "Ultrasound - Transvaginal (non-maternity)", !insurer %in% c("Uninsured", "Other", "Medicare")) %>% 
  count(provider_name, insurer) %>% 
  count(provider_name) %>% 
  filter(nn == 3) %>%
  left_join(primary_data, by = "provider_name") %>% 
  filter(procedure == "Ultrasound - Transvaginal (non-maternity)", !insurer %in% c("Uninsured", "Other", "Medicare")) %>%
  group_by(provider_name) %>% 
  mutate(range = max(estimate_of_total_cost) - min(estimate_of_total_cost)) %>% 
  filter(range > 150) %>% 
  ungroup() %>% 
  ggplot(aes(x = fct_reorder(provider_name, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) +
  geom_col(position = "dodge", width = 0.5) +
  scale_fill_manual(values = c("Uninsured" = "#DCDCDC", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                               "Harvard Pilgrim HC" = "#CC0000", "Other" = "#C0C0C0", "Medicare" = "#808080"), name = "Insurer") +
  scale_y_continuous(name = "Price Estimate", labels = dollar) +
  labs(title = "Figure 6.1: Prices for Ultrasound - Transvaginal (non-maternity)") + 
  coord_flip() +
  theme_tufte() +
  theme(axis.title.y = element_blank())
  # geom_text(aes(label = paste0("$", estimate_of_total_cost)), color = "black", position = position_dodge(width = TRUE), size = 2)
  

primary_data %>% 
  filter(procedure == "X-Ray - Spine (outpatient)", !insurer %in% c("Uninsured", "Other", "Medicare")) %>% 
  count(provider_name, insurer) %>% 
  count(provider_name) %>% 
  filter(nn == 3) %>%
  left_join(primary_data, by = "provider_name") %>% 
  filter(procedure == "X-Ray - Spine (outpatient)", !insurer %in% c("Uninsured", "Other", "Medicare")) %>%
  group_by(provider_name) %>% 
  mutate(range = max(estimate_of_total_cost) - min(estimate_of_total_cost)) %>% 
  filter(range > 100) %>% 
  ungroup() %>% 
  ggplot(aes(x = fct_reorder(provider_name, estimate_of_total_cost), y = estimate_of_total_cost, fill = insurer)) +
  geom_col(position = "dodge", width = 0.5) +
  scale_fill_manual(values = c("Uninsured" = "#DCDCDC", "CIGNA" = "#99CC00", "Anthem NH" = "#336699", 
                               "Harvard Pilgrim HC" = "#CC0000", "Other" = "#C0C0C0", "Medicare" = "#808080"), name = "Insurer") +
  scale_y_continuous(name = "Price Estimate", labels = dollar) +
  labs(title = "Figure 6.2: Prices for X-Ray - Spine (outpatient)") +
  coord_flip() +
  theme_tufte() + 
  theme(axis.title.y = element_blank())
```

It is unlikely that the cost of providing each of these services and the quality of each of these services within the same hospital should vary with patients' insurance coverage. That is, it should be no more costly from the hospital's point of view to perform a spine x-ray on a patient covered by CIGNA as opposed to a patient covered by Anthem, and hospitals should not provide higher quality spine x-rays to CIGNA covered patients than they do to Anthem patients. Thus my analysis explores other potential sources of this variation, particularly those related to market power.




## Data
### HealthCost Data
The primary source of data on hospital prices comes from the New Hampshire Insurance Department [HealthCost website](https://nhhealthcost.nh.gov/costs/select) which is a publicly available tool that provides insurer-hospital specific estimations of costs for a long list of services and procedures. New Hampshire is among a handful of states that make such information publicly available, hence why I use it as a case study for my analysis. The cost estimates are calculated using claims data from the New Hampshire Comprehensive Healthcare Information System (NHCHIS) to determine the median amount that insurance carriers and patients pay for each service. The estimated costs therefore reflect the rates negotiated between health care providers and insurance carriers (often referred to as the "allowable amount") rather than provider charges, which have been shown to have little relation to what most privately insurered individuals actually pay for a given service. In addition, HealthCost estimates the prices faced by the uninsured based on charges minus any discount the provider may offer uninsured patients.

For the services relevant to this paper (outpatient procedures and radiology services), the estimated prices may be "bundled" to include multiple services or independent providers; that is, the estimates aggregate the costs for what may be treatment received from several providers (billing separately) under the "lead provider" rather than distinguishing between what is paid to the facility versus the physicians who treat the patient. Price estimates for radiology services use a modified bundle that includes the facility and the professional fees associated with the patient receiving that service but not any other costs that the patient may have incurred on the same day. 

Each service on HealthCost is identified with a description (e.g. "X-Ray - Abdomen") and one of the American Medical Association's Current Procedural Terminology (CPT) codes.  However, there are multiple CPT codes for an abdominal x-ray (different codes for different numbers of views), so the CPT codes for similar services are counted and the most common ones identified through the frequency distribution. From there, the representative CPT code and description is chosen based on what will be the simplest and most easily recognized procedure, and, when available, clinical insight is also considered. This means that in some cases, multiple CPT codes may be combined, as long as the cost is similar, under a single service. 

Additionally, HealthCost includes indicators of variability for each estimate under the "Precision of the Cost Estimate" field, where "High" corresponds to cost estimates with little variability from one patient to the next, and risk-adjustment indicators under the "Typical Patient Complexity" field, which are evaluated for each hospital within that procedure. For example, a hospital may attract an average population when considering all procedures but a more complex population when only considering brain MRIs as compared to other hospitals. Thus, for brain MRIs, this hospital would have a "High" typical patient complexity. 

The data available on HealthCost me to construct a data set containing the estimated price for each procedure and each provider-insurer combination for which data was available. I also keep values for "Typical Patient Complexity" and "Precision of the Cost Estimate" to use as controls in my analysis. 

### CMS Data
The Center for Medicaid and Medicare Services (CMS) provides several useful data sets on Medicare prices and hospital quality. Medicare sets all of it prices centrally, allowing for some variation across regions. For oupatient services, Medicare reimburses hospital by the services they provided. That is prices are provided at the CPT code level. This information is made public in the Physician Fee Schedule (PFS) [2018 Relative Value file](https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/PhysicianFeeSched/PFS-Relative-Value-Files.html), allowing me to construct the Medicare reimbursement rates at each hospital for each service observed in the HealthCost data by matching each hospital with a locality in the CMS data. I am able to calculate the 2018 Medicare Facility Pricing Amount $p_{2018}^{Medicare}$ for each procedure $j$ at the locality level $l$ using  the following formula:
$$p_{jl, 2018}^{Medicare} = [({RVU}_{j}^{work}*{GPCI}_{l}^{work}) + ({RVU}_{j}^{PE}*{GPCI}_{l}^{PE}) + ({RVU}_{j}^{MP}*{GPCI}_{l}^{MP})]*{CF}_{2018} $$ 
where ${RVU}_{j}^{work}$ denotes the Relative Value Unit (RVU) for the physician work involved in providing procedure $j$, ${RVU}_{j}^{PE}$ denotes the RVU for the resource-based practice expense for the facility setting, and ${RVU}_{j}^{MP}$ denotes the RVU for the malpractice expense. ${GPCI}_{l}^{work}$ denotes the Geographic Practice Cost Index (GPCI) corresponding to locality $l$ and the work RVU, ${GPCI}_{l}^{PE}$ corresponds to the practice expense RVU, and ${GPCI}_{l}^{MP}$ corresponds to the malpractice RVU. ${CF}_{2018}$ denotes the 2018 conversion factor ($36.00).

Medicare treats all of New Hampshire as one locality, meaning that all hospitals in New Hampshire that are reimbursed through prospective payments are reimbursed the same amount for outpatient services through Medicare Part B. However, 13 out of the 32 hospitals in my dataset are Critical Access Hospitals (CAHs) that are elligible to receive cost-based reimbursements from Medicare. I was unable to obtain data on exactly how much these CAHs are reimbursed by CPT code and therefore use the prospective payment rates as an approximation for what they are reimbursed by Medicare. This should not have a major impact on the analysis as the focus is on private insurers, and I primarily use Medicare prices for the purposes of standardization of the private insurer prices available through NH HealthCost. 


The second dataset provided by CMS is the [Hospital Compare data](https://data.medicare.gov/data/hospital-compare) which provides measures of quality. The hospital overall ratings show the quality of care a hospital may provide compared to other hospitals based on the quality measures reported on Hospital Compare, summarizing into a single rating more than 60 measures in seven measure groups: mortality, safety of care, readmission, patient experience, effectiveness of care, timeliness of care, and efficient use of medical imaging.




## Empirical Framework
### Theoretical Framework
In standard micro-economic theory, one learns that prices reflect supply and demand; in a perfectly competitive market, the supply curve is largely determined by each firm's costs of production and the demand curve determined by consumer preferences and budget constraints. In this standard model, there are no profits as both producers and consumers are price takers. However, a more realistic model allows for the possibility of profits, therefore encouraging firm entry to the industry, by admitting firms may exercise some monopolist or market power.

Market power is largely a function of the number of other firms in the market, but a firm may also generate market power for itself through distiguishing it's product from others. When it's product differs from others in the market, a firm can act as a quasi-monopolist, price setter and extract a certain mark-up from consumers who have a preference for that difference and are price takers. As consumers often have a preference for quality or some aspect of quality, firms that can best distinguish their product as being of higher quality than others are more able to demand higher prices for their product(s).

The market for health services (often provided through hospitals) is unique in that there are two components of demand: individuals and payers. Even this is somewhat of an oversimplification in the US market because many individuals are privately insured through their employer which contracts with a private insurer. However, for the most part, it is insurer-provider price negotiations that determine the price of care; private insurers negotiate contracts with each provider (Medicare and Medicaid set their prices at a regional level) and also dictate how much the individual or family must pay in premiums and out of pocket for each episode of care. This gives private insurers some form of monopsony power in price negotiations as there are often only a few of private insurers present in each market and they can choose whether or not to include each provider in their network, affecting the prices individual/families face for care. 

Thus, payers and providers engage in bilateral negotiations where both are price setters rather than price takers. I assume the following: both the provider and the payer want to maximize the number of patients they serve and their profit margins per patient, even if the provider is a non-profit (Horwitz 2005). Providers want to receive higher prices for their services but also to be included in payers' networks, as patients face lower out-of-pocket costs when going to providers in network. Payers want to pay lower prices for providers’ services to minimize their costs but also want to attract enrollees by including convenient providers in their network, which is an important aspect of plan selection for individuals (Ho 2006). Thus, this is the bargaining environment in which bilateral hospital-insurer contracts are negotiated and the work below examines the impact on prices.

### Empirical Approach
My analysis seeks to identify whether the market power of hospitals and insurers is related to variation in the prices private insurers pay for hospital services. The first section focuses insurer market power and the second on hospital market power. I restrict my analyses only to radiology services, which are among some of the most common outpatient procedures, only to hospitals (excluding ambulatory care centers, clinics, specialist practices, etc.), and only to the three major private insurers and Medicare (to provide a base price). This leaves me with 33 services, 31 hospitals, and 2,308 observations as I do not have prices for all four insurers and all 33 services at each each hospital.

Radiology services (CT scans, MRIs, ultrasounds, x-rays, etc.) generally involve the use of an imaging device to capture an image which is then read (examined) by a radiologist who reports their findings to the patient or patient's doctor. The initial cost of purchasing one of these imaging devices may vary somewhat, but the per unit cost of procuring and reading an image is likely to be similar across providers once controlling for wages. Within hospitals, there should be very little deviation in per unit costs. Furthermore, the quality of radiology services may potentially vary across hospitals, but within each hospital, this quality is plausibly assumed constant.

My outcome variable of interest is the percentage of the price Medicare paid by individual with insurance $i$ for a particular procedure $j$ at a particular hospital $h$, denoted as $y_{ijh}$. That is, 

$$y_{ijh} = \frac {p_{ijh}}{p_{ijh}^{Medicare}}$$

where $p_{ijh}$ denotes the price a particular insurer pays for procedure $j$ at hospital $h$, and $p_{ijh}^{Medicare}$ denotes the price Medicare pays for the same service at the same hospital. As mentioned above, for some of the critical access hospitals, this may not be the rate at which Medicare actually reimburses the hospital because only the PFS rates are known, but the medicare price is merely used to standardize prices and therefore the analysis should be largely unaffected by this limitation.

The first estimation is interested in determining whether there is a statistical difference between the prices hospitals charge Anthem, Harvard Pilgrim, and CIGNA in New Hampshire for the same service, with the context that Anthem (the largest commercial insurer) composes 39% of the commercial insurance market, Harvard Pilgrim 27%, and CIGNA (the smallest major commercial insurer) 20%. I estimate what percentage of the Medicare price each insurer pays using the following linear model:

$$y_{ijh} = \sum_{n \epsilon N} \gamma_n \left[{insurer_n}\right] + \delta_j + \lambda_h + \varepsilon_{ijh}$$

where $N$ is the set of private insurers (Anthem, Harvard Pilgrim, CIGNA), and ${insurer_n}$ is an indicator variable that takes on the value of 1 or 0. The coefficient $\gamma_n$ therefore denotes the percentage of the medicare price insurer $n$ is estimated to pay, and the three resulting coefficients of the summation (one $\gamma_i$ for each insurer) are the primary coefficients of interest. The regression also includes procedure fixed effects $\delta_j$ and hospital fixed effects $\lambda_h$ so that the price for the same procedure at the same hospital can be compared among the commercial insurers. The error term is denoted by $\varepsilon_{ijh}$.

This estimation is unable to directly make any claims regarding the magnitude of the relationship between the market power of insurer $i$ and the price of procedure $j$ at hospital $h$, because I only have the state-wide market shares of each insurer. An analysis to truly test the effect of market power would require knowing the market power of each insurer within hospital $h$'s market, which may not be distributed as the state-wide shares are, and identifying this relationship the prices negotiated between insurer $i$ and hospital $h$ given insurer $i$'s market share in hospital $h$'s market, but I do not have this information. However, in my analysis the relative magnitude of the coefficients $\gamma_i$ and their statistical significance suggest the potential direction of this relationship. That is, each insurer's state-wide market share is known and can be ranked from largest to smallest, and a negative relationship between the size of the insurer's statewide market share and the magnitude of $\gamma_i$ suggests that larger insurers may negotiate cheaper prices, potentially as a function of their market power.

The second set of estimations concerns how the market power of each hospital relates to the price (as a percentage of the Medicare price) for a particular service that that hospital negotiates with each insurer. Essentially, the hospital fixed effects variable Equation (2) is broken apart into various observable measures relating to a particular hospital and its market, resulting in the following linear model:

$$y_{ijh} = \zeta_i + \delta_j + \alpha m_h + \beta x_h + \varepsilon_{ijh}$$

where $\zeta_i$ replaces the summation in Equation (2) and denotes insurer fixed effects; $\delta_j$ denotes procedure fixed effects as in Equation (2); $m_h$ represents the number of hospitals in hospital $h$'s market and $x_h$ is a vector of hospital characteristics defined as follows:

$$x_h = \eta_{jh} + \vartheta_h + \mu_c + \rho_c + \phi_c$$ 

where $\eta_{jh}$ denotes the typical patient complexity for procedure $j$ at hospital $h$; $\vartheta_h$ denotes overall hospital quality as provided through the CMS Hospital Compare data; $\mu_c$ represents the median household income in the hospital's county $c$; $\rho_c$ represents the percentage of person's over 65 years of age in the hospital's county; and $\phi_c$ denotes the population density of the hospital's county. Data for $\mu_c$, $\rho_c$, and $\phi_c$ comes from the [2017 US Census](https://www.census.gov/quickfacts/fact/map/US/INC110217).

A hospital's market $m_h$ is defined differently across several specifications. I first use two common definitions for a hospital's market in the literature: it's Hospital Service Area (HSA) and it's Hospital Referral Region (HRR), both defined and made publicly available by the [Dartmouth Atlas of Health Care](http://archive.dartmouthatlas.org/tools/downloads.aspx?tab=39). An HSA dilineates a local market for hospital care, composed of a collection of ZIP codes whose residents receive most of their hospitalizations from the hospitals in that area. For the most part, this calculation is based on assigning each ZIP code to the area where the greatest proportion of its Medicare patients were hospitalzed. Most HSAs contain only one hospital. An HRR dilineates regional health care markets for tertiary medical care and each contains at least one hospital that performs major cardiovascular procedures and neurosurgery. HRRs were largely defined by assigning HSAs to the region where the greatest proportion of major cardiovascular procedures were performed. My dataset contains 29 unique HSAs and 4 unique HRRs. 

For both the HSA and HRR market definitions, I count the total number of hospitals within each hospital's market as well as the number of hospitals that also provide the same service/procedure within that market. This attempts to isolate whether the hospital is truly competing with other hospitals in its market in providing procedure $j$ or whether it may be the only hospital in its market providing that service and therefore faces no competitors. While the 33 radiology services I have restricted my analysis to are quite common, I do not have at least one price observation available for all 33 procedures at all hospitals from the HealthCost data. Thus it is possible, though unlikely, that hospitals for which HealthCost does not have a price for a particular service may not offer that service, or provide it so infrequently that they do not really compete with other hospitals for its provision.  Most hospitals however do provide at least half of the services within the and there does not appear to be a consistent set of services for which price data is missing at many hospitals.

The second set of market definitions I use are based on geographical radii drawn around each hospital. As with the HSA/HRR market definitions, I count the total number of hospitals as well as the number of hospitals that also provide the same service/procedure within a 25 mile, 10 mile, and 5 mile radius of each hospital $h$. As the services being examined are all outpatient services, the HSA/HRR definitions may not truly capture the potential patient population and potential competitors because they are calculated on the basis of hospitalization (inpatient) events. For outpatient services, patients may be able to exercise more choice in which hospitals they go to and therefore place greater weight on convenience and distance to the hospital, so this radial measure of a hospital's market may be more applicable to consumers' choices in the outpatient setting.

The primary coefficient of interest in this second set of regressions is $\alpha$ which reveals how hospital competition may be related to prices. If $\alpha$ is negative, this suggests that the more hospital competition there is within a hospital's market, the lower the prices or, alternatively, the greater market power a hospital has, the higher its prices.




## Results
The first set of results presented in Table 1 demonstrate that there are statistically significant differences in the prices paid by each insurer for a particular service at a particular hospital. The coefficients (presented as the average percentage of the Medicare price that insurer pays) suggest that on average Anthem pays 6.43 times the Medicare price, Harvard Pilgrim pays 7.04 times the Medicare price, and CIGNA 7.92 times the Medicare price. 
```{r, echo=FALSE, results = "asis", fig.align='center', message=FALSE}
stargazer(lm_insurers, omit = c(4:172), header = FALSE,
          title = "Insurance Carrier and Relative Prices",
          covariate.labels = c("Anthem NH", "Harvard Pilgrim HC", "CIGNA"), 
          dep.var.labels = "Percent of Medicare Price")

```
The positive direction of the coefficients is unsurprising as Medicare consistently reimburses providers at much lower rates than do private insurers; however the magnitude of the coefficients is somewhat large compared to prior literature, which usually finds private insurer rates to be somewhere betwee 150-200% of Medicare rates largely in the context of inpatient services. Nonetheless, the meaning of these results is not necessarily diminished. Among the inpatient services they examine, Cooper et al. (2015) find the greatest disparity in Medicare versus private reimbursement for lower limb MRIs, the only radiology service they consider (private insurers pay on average 4 times the Medicare price in their sample), so perhaps Medicare is particularly able to set low prices for radiology services given the low per-unit cost of radiology services. Additionally, the price data from HealthCost reflects "bundled" prices as detailed in the Data portion of this paper, so they may be somewhat inflated compared to the Medicare prices. Importantly however, HealthCost bundles payments in the same way across all three private insurers and therefore the variation in the prices paid by each insurer is unaffected by this imperfect standardization to the Medicare price.

While definitive conclusions about the effect of insurer market power cannot be made from these results given the limitations mentioned in the Empirical Approach, they do suggest that the larger the market share of the insurer, and therefore the larger its market power, the lower the prices that insurer pays at each hospital for a given procedure. Anthem, with the largest share of the market, pays less on average than both Harvard Pilgrim and CIGNA; Harvard Pilgrim, which is smaller than Anthem but bigger than CIGNA, pays somewhere between the Anthem and CIGNA price on average; and CIGNA, the smallest of the major insurers, consistently pays much more than both Anthem and Harvard Pilgrim.

The second set of regressions presented in Tables 2-5 suggest that the number of hospitals in a hospital's market is negatively related to price at a statistically significant level when defining the hospital's market as a radius of 25 miles, reducing prices by 19-26% on average depending on whether competitors are defined as other hospitals offering the same service or not. For all other definitions of a hospital's market, the effect is often negative but not statistically different from zero. 
```{r, echo=FALSE, results = "asis", message=FALSE}
stargazer(lm_hospitals1, lm_hospitals2, omit = c(9:170), header = FALSE, 
          title = "Total Number of Hospitals in Market (HSA/HRR definition) and Relative Price",
          covariate.labels = c("Total Number in HSA",
                               "Total Number in HRR",
                               "Typical Patient Complexity", 
                               "Hospital Quality",
                               "Median Household Income (county)",
                               "% Population 65 and older (county)",
                               "Population Density (county)"), 
          dep.var.labels = "Percent of Medicare Price")

stargazer(lm_hospitals3, lm_hospitals4, omit = c(9:170),  
          title = "Number of Hospitals in Market (HSA/HRR definition) Offering Procedure and Relative Price",
          covariate.labels = c("Number in HSA offering procedure",
                               "Number in HRR offering procedure",
                               "Typical Patient Complexity", 
                               "Hospital Quality",
                               "Median Household Income (county)",
                               "% Population 65 and older (county)",
                               "Population Density (county)"), 
          dep.var.labels = "Percent of Medicare Price")

stargazer(lm_hospitals5, lm_hospitals6, lm_hospitals7, omit = c(11:170),  
          title = "Total Number of Hospitals in Market (radial definition) and Relative Price",
          covariate.labels = c("Number of Hospitals in 5 mile radius",
                               "Number of Hospitals in 10 mile radius",
                               "Number of Hospitals in 25 mile radius",
                               "Typical Patient Complexity", 
                               "Hospital Quality",
                               "Median Household Income (county)",
                               "% Population 65 and older (county)",
                               "Population Density (county)"), 
          dep.var.labels = "Percent of Medicare Price")

stargazer(lm_hospitals8, lm_hospitals9, lm_hospitals10, omit = c(11:170),  
          title = "Number of Hospitals in Market (radial definition) Offering Procedure and Relative Price",
          covariate.labels = c("Hospitals with procedure in 5 mile radius",
                               "Hospitals with procedure in 10 mile radius",
                               "Hospitals with procedure in 25 mile radius",
                               "Typical Patient Complexity", 
                               "Hospital Quality",
                               "Median Household Income (county)",
                               "% Population 65 and older (county)",
                               "Population Density (county)"), 
          dep.var.labels = "Percent of Medicare Price")


```
These results suggest that, under a certain definition of the market, the greater the number of hospitals in a hospital's market, the lower the prices at that hospital are, or, alternatively, the greater a hospital's market power, the higher the prices at that hospital. This is 



## Conclusions

